' Gambas class file

Private fTotal As Float
Private rResult As Result
Private myOrder As Integer
Private myTicket As Integer
Private rYPrint As Integer
'Private iInc As Integer

Private Const PRINT_MARGIN As Float = 1

Public Function sCalculaCosto() As String[]

Dim sQuery As String
Dim hResult, rResultProxOr, rResultPromos, rResultVar, rResultDetail, rNombreVar As Result
Dim flTemporal As Float
Dim docV As New String[2]

  sQuery = "SELECT * FROM tbl_precio_tipo_ordenes where `id_orden` = &1;"
  docV[0] = ""
  Try hResult = modVariables.c_Conn.Exec(sQuery, modVariables.i_intOrdenID)
  modVariables.i_intTipoPrecio = hResult["id_tipo_precio"]
  hResult = Null
  sQuery = "Select * from vw_prods_x_orden where `Orden` = &1 and `Activo` = 1 and `Tipo Precio` = &2 order by `Control Fecha` Asc"
  Try rResultProxOr = modVariables.c_Conn.Exec(sQuery, modVariables.i_intOrdenID, modVariables.i_intTipoPrecio)
  
  If rResultProxOr.available And rResultProxOr <> Null Then
    fTotal = 0
    For Each rResultProxOr 'checar promos y costos extra
      sQuery = "Select * from `tbl_promociones` where `id_producto` = &1 and `bit_activo = 1`"
      Try rResultPromos = modVariables.c_Conn.Exec(sQuery, rResultProxOr["ID Prod"])
      If rResultPromos <> Null Then 'Hay una promocion para este producto, checar validez de d√≠as.
        flTemporal = 0
        If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
          flTemporal = rResultProxOr!Precio - (rResultProxOr!Precio * rResultPromos!fl_descuento)
          flTemporal = (flTemporal * rResultProxOr!Cantidad)
          fTotal = ftotal + flTemporal
        Endif
      Else
        rResultPromos = Null
        sQuery = "SELECT `dbl_precio` as Precio FROM `tbl_precios_productos` where `id_producto` = &1 and int_tipo_precio = &2 and `bit_activo` = 1;"
        Try rResultPromos = modVariables.c_Conn.Exec(sQuery, rResultProxOr["ID Prod"], rResultProxOr["Tipo Precio"])
        flTemporal = rResultPromos["Precio"] * rResultProxOr["Cantidad"]
        fTotal += flTemporal
        docV[0] &= "<tr>"
        docV[0] &= "<td style=\"font-size: medium;\" width=\"15%\">" & rResultProxOr["Cantidad"] & " x </td><td width=\"70%\"> " & rResultProxOr["Producto"] & " </td><td align=\"right\"width=\"15%\">" & " $" & CInt(flTemporal) & "</td></tr>" 

        rResultPromos = Null
        hResult = Null
        sQuery = "SELECT * FROM `tbl_prods_orden_opciones` where `id_prod_x_orden` = &1"
        
        Try hResult = modVariables.c_Conn.Exec(sQuery, rResultProxOr["IDPO"])
        
        If hResult.Available Then
          For Each hResult
            sQuery = "SELECT * FROM `tbl_prods_variantes` where `id_producto`= &1 and `id_variante` = &2 and `int_activo` = 1 order by `id_producto`, `id_variante`;"
            Try rResultVar = modVariables.c_Conn.Exec(sQuery, rResultProxOr["ID Prod"], hResult["id_variante_platillo"])
            If rResultVar.available Then
              For Each rResultVar
                docV[0] &= "<tr>"
                sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1; "
                Try rResultDetail = modVariables.c_Conn.Exec(sQuery, rResultVar["id_prods_variantes"])
                If rResultDetail.Available Then
                  For Each rResultDetail
                    If rResultDetail["id_tipo_precio"] = rResultProxOr["Tipo Precio"] Then
                      flTemporal = CFloat(rResultDetail["fl_costo_extra"]) * CFloat(rResultProxOr["Cantidad"])
                      fTotal += flTemporal
                      sQuery = "SELECT * FROM `tbl_variantes_platillos` where `id_variante_pl` = &1 order by `fl_ordenar`"
                      Try rNombreVar = modVariables.c_Conn.Exec(sQuery, hResult["id_variante_platillo"])
                      docV[0] &= "<td></td><td>"
                      docV[0] &= gb.CrLf & rNombreVar["chr_imprimir"] & "</td><td colspan=2 align=\"right\">" & " $ " & CInt(flTemporal) & gb.CrLf 
                    Endif
                    docV[0] &= "</td>"
                  Next
                  rResultDetail = Null
                Endif
                docV[0] &= "</tr>"
              Next
              rResultVar = Null
            Endif
          Next
          hResult = Null
          
        Endif
      Endif
      'Inc iInc
    Next
    docV[1] = CStr(fTotal)
Print docV[0]
Endif

  Return docV
  
End


Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btnCancel_Click()

  Me.Close

End

Public Sub Form_Open()

  Dim sQuery As String
  Dim rResultPromos As Result
  Dim flTemporal As String[]
  
  lblCbOrden.Text = modVariables.i_intOrdenID
  lblCbMesa.Text = modVariables.s_strMesaTemp
  
  flTemporal = sCalculaCosto() 
    
    lblCbTotal.Text = "$" & CStr(flTemporal[1])
    
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub txtRecibido_KeyPress()

  Print Str(key.code) 
  'If Len(txtRecibido.text) = 0 Then btnOK.Enabled = False Else btnOK.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)  
End

Public Sub txtRecibido_LostFocus()

  If txtRecibido.Text <> "" Then lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub PrinterCobrar_Draw()

  'Dim documento As New ClassLaTex
  'Dim tex As String
  Dim sQuery As String
  Dim hResult, rResultProxOr, rResultSuc, rResultVar, rResultDetail, rNombreVar As Result
  Dim docV As New String[2]
  Dim sTemporal As String[]
  Dim hImage As Image
  Dim rResultPromos As Result
  Dim flTemporal As Float
  Dim iInc As Integer
  
  Dim sArray As String[] = Split(File.Load(User.Home &/ "Templates/ticketventa.html"), gb.Newline, "", True)
  Dim sHTML As String
  
  sHTML = sArray.Join(gb.Newline)
  
  If txtRecibido.Text = "" Then 
    Message.Error("Indique la cantidad recibida por favor")
    txtRecibido.SetFocus
    Return
  Endif
    
  lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
  
  hImage = Image.Load(User.Home &/ ".tacosroy/pictures" &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 600, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCobrar.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica"]
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  
  
  sHTML = Replace(sHTML, "@@OrdenNr@@", CStr(modVariables.i_intOrdenID))
  sHTML = Replace(sHTML, "@@TicketNr@@", CStr(myTicket))
  
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try rResultSuc = modVariables.c_Conn.Exec(sQuery)
  
  sHTML = Replace(sHTML, "@@NombreSucursal@@", CStr(rResultSuc["chr_nombre"]))
  sHTML = Replace(sHTML, "@@DatosSuc1@@", CStr(rResultSuc["chr_dir1"]))
  sHTML = Replace(sHTML, "@@DatosSuc2@@", CStr(rResultSuc["chr_dir2"]))
  sHTML = Replace(sHTML, "@@DatosSuc3@@", CStr(rResultSuc["chr_dir3"]))
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", CStr(rResultSuc["chr_telefono1"]))
  
  'aqui va el calculo con print true
  sTemporal = sCalculaCosto()
  sHTML = Replace(sHTML, "@@DetalleOrden@@", sTemporal[0])
  sHTML = Replace(sHTML, "@@Total@@", sTemporal[1])
  
  sHTML = Replace(sHTML, "@@Recibido@@", txtRecibido.Text)
  sHTML = Replace(sHTML, "@@Cambio@@", CStr(CFloat(txtRecibido.Text - fTotal) & ".00"))

  PrinterCobrar.PaperWidth = 80
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnOK_MouseUp()

  Dim sQuery, sTemp As String
  Dim hResult As Result
  Dim myInt As Integer
  Dim myTot As Integer
  Dim sTempFile, sCommand As String
  
  
  sQuery = "Select * From `tbl_consecutivo` ORDER BY `id_consecutivo` DESC LIMIT 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  modVariables.i_intTicketNR = hResult[1]
  myTicket = modVariables.i_intTicketNR
  
  'sQuery = "INSERT INTO `tbl_ticket_cons` (`id_ticketNrConsecutivo`, `chr_ticketConsecutivo`) VALUES (Null, &1)"
  
  hResult = Null
  modVariables.c_Conn.Begin()
  hResult = modVariables.c_Conn.Create("tbl_ticket_cons")
  Select Case Mouse.Control
    Case True
      myTot = myTicket
      'hResult!chr_ticketConsecutivo = myTicket
      myInt = 0
    Case False
      myTot = myTicket + 1
      'hResult!chr_ticketConsecutivo = myTicket + 1 
      myInt = 1
  End Select
  
  hResult!chr_ticketConsecutivo = myTot
  hResult.Update()
  modVariables.c_Conn.Commit()
  hResult = Null
  Try modVariables.i_ticketNumber = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
  
  'Se cambia el status del ticket
  sQuery = "UPDATE `tbl_ordenes` SET `chr_status_orden` = &1 where `id_orden_id` = &2"
  If txtReferencia.Text = "" Then sTemp = "Cerrada"
  Try modVariables.c_Conn.Exec(sQuery, txtReferencia.Text, modVariables.i_intOrdenID)

  modVariables.c_Conn.Begin()
    hResult = modVariables.c_Conn.Create("tbl_ordenes_cerradas")
    hResult!id_orden_id = modVariables.i_intOrdenID
    hResult!dt_horafecha_cierre_orden = Now()
    hResult!fl_total = fTotal
    hResult!bool_factura = False
    hResult!chr_referencia_notas = txtReferencia.Text
    hResult!int_lvl_report = myInt
    hResult!id_ticket_IDNr = modVariables.i_ticketNumber
    hResult!id_control_fecha = modVariables.i_idControlFecha
    hResult.Update()
  modVariables.c_Conn.Commit()
  hResult = Null
  
  If Error Then Message.Error(Error.Text & ", " & Error.Where)
  
  sQuery = "Select * From `vw_info_ordenes_tickets` Where id_orden_id = &1"
  Try hResult = modVariables.c_Conn.Exec(sQuery, modVariables.i_intOrdenID)
  myOrder = hResult["chr_consecutivo"]
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  myTicket = CInt(hResult[1])
  
  sQuery = "SELECT * From `tbl_ordenes` where `chr_status_orden` = 'Abierta' order by id_orden_id"
  FMain1.gridMainOrden.Rows.Count = 0
  
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  FMain1.gridMainOrden.Rows.Count = hResult.Count
  
  'Se imprime el ticket
  Me.Enabled = False
  Inc Application.Busy
  PrinterCobrar.PaperWidth = 80
  'PrinterCobrar.Configure
  sTempFile = User.Home &/ "Tickets/ticket_" & modVariables.i_intTicketNR & "-" & modUtils.convierteFechaFormatoHora(Now) & ".pdf"
  sTempFile = Replace(sTempFile, " ", "-")
  PrinterCobrar.OutputFile = sTempFile
  PrinterCobrar.Print()
  
  sCommand = "lpr " & sTempFile
  Shell sCommand
  
  Dec Application.Busy
  Me.Enabled = True
  
  With FMain1
    .gridOrdenDetails.Rows.count = 0
    .btnCancelOrden.Enabled = False
    .btnCerrarOrden.Enabled = False
    .btnImrpimeCuenta.Enabled = True
    .btnModifOrden.Enabled = False
  End With
  
  Me.Close(True)
  cmbFormaPago.Enabled = True
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End


Public Sub txtDescuento_KeyPress()

  If Len(txtDescuento.text) = 0 Then btnAplicaDesc.Enabled = False Else btnAplicaDesc.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event

End

Public Sub txtDescuento_Change()

  If CInt(txtDescuento.Text) > 100 Then txtDescuento.Text = "99"

End

Public Sub cmbFormaPago_Change()

  Select Case cmbFormaPago.Index
    Case 0
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Efectivo"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = True
      txtReferencia.Enabled = False
      lblReferencia.Text = ""
      'btnOK.Enabled = False
    Case 1
      lblDescuento.Visible = True
      txtDescuento.Visible = True
      btnAplicaDesc.Visible = True
      txtReferenciaPago.Text = "Descuento"
      txtReferenciaPago.Visible = False
      txtRecibido.Enabled = True
      txtReferencia.Enabled = True
      txtReferencia.Text = ""
      lblReferencia.Text = "Referencia:"
      'btnOK.Enabled = False
    Case 2
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Personal"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
      txtReferencia.Enabled = True
      lblReferencia.Text = "Empleado:"
    Case 3
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "T. Deb/Cred"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
      txtReferencia.Enabled = True
      lblReferencia.Text = "Numero Tarjeta:"
    Case Else
      
    End Select
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub cmbFormaPago_KeyRelease()

  cmbFormaPago_Change()

End

Public Sub cmbFormaPago_MouseUp()

  cmbFormaPago_Change()

End

Public Sub cmbFormaPago_Click()

  cmbFormaPago_Change()

End

Public Sub btnAplicaDesc_Click()

  lblCbTotal.Text = fTotal - (CFloat(fTotal) * (CFloat(txtDescuento.Text) / 100))
  fTotal = CFloat(lblCbTotal.Text)

End

Public Sub txtRecibido_Change()

  If txtRecibido.Text <> "" Then lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)

End
