' Gambas class file

Private fTotal As Float
Private rResult As Result
Private myOrder As Integer
Private myTicket As Integer

Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btnCancel_Click()

  Me.Close

End

Public Sub Form_Open()

  Dim sQuery As String
  Dim rResultPromos As Result
  Dim flTemporal As Float
  
  lblCbOrden.Text = modVariables.$intOrdenID
  lblCbMesa.Text = modVariables.$strMesaTemp
  
  'vw_order_prods_precio
  sQuery = "Select * from vw_orden_prods_precio where `Orden` = &1 and `Activo` = 1 order by `HoraFecha` Asc"
    
    Print sQuery & ", " & modVariables.$intOrdenID
    Try rResult = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenID)
    If Error Then Message.Error(Error.Text & ", " & Error.Where)
    
    If rResult.Available Then
      fTotal = 0
      For Each rResult
        
        sQuery = "Select * from tbl_promociones where id_producto = &1"
        Try rResultPromos = modVariables.$hConn.Exec(sQuery, rResult!IDPR)
        If rResultPromos.Available Then 'Hay una promocion para este producto, checar validez de días.
          If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
            flTemporal = rResult!Precio - (rResult!Precio * rResultPromos!fl_descuento)
            fTotal = fTotal + (flTemporal * rResult!Cantidad)
          Else
            fTotal = fTotal + (rResult!Precio * rResult!Cantidad)
          Endif
        Else
          fTotal = fTotal + (rResult!Precio * rResult!Cantidad)
        Endif
        rResultPromos = Null 
        'rResult.MoveNext
      Next
    Endif
    
    lblCbTotal.Text = "$" & CStr(fTotal)
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub txtRecibido_KeyPress()

  Print Str(key.code) 
  If Len(txtRecibido.text) = 0 Then btnOK.Enabled = False Else btnOK.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)  
End

Public Sub txtRecibido_LostFocus()

  If txtRecibido.Text <> "" Then lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub PrinterCobrar_Draw()

  'Dim documento As New ClassLaTex
  'Dim tex As String
  Dim sQuery As String
  Dim rResult2, rResultSuc As Result
  Dim docV As String
  Dim hImage As Image
  Dim rYPrint As Integer
  Dim rResultPromos As Result
  Dim fTotale, flTemporal As Float
  
  Dim PRINT_MARGIN As Float
  Dim iInc As Integer

  PRINT_MARGIN = 1
  iInc = 1
  
  If txtRecibido.Text = "" Then 
    Message.Error("Indique la cantidad recibida por favor")
    txtRecibido.SetFocus
    Return
  Endif
  
  sQuery = "Select Producto, Cantidad, Precio, (Cantidad * Precio) as Subtotal from vw_orden_prods_precio where `Orden` = &1 and `Activo` = 1 order by `HoraFecha` Asc"
  
  Try rResult2 = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenID)
  If Error Then Message.Error(Error.Text & ", " & Error.Where)
  
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try rResultSuc = modVariables.$hConn.Exec(sQuery)
    
  lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
  
  hImage = Image.Load(User.Home &/ ".tacosroy/pictures" &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 200, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCobrar.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica, Bold, 12"]
  docV = "Orden: " & modVariables.$intOrdenID & ", Ticket Nr.: " & myTicket 
  Paint.DrawRichText(docV, PRINT_MARGIN, 300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = "Mesa: " & modVariables.$strMesaTemp
  Paint.DrawRichText(docV, PRINT_MARGIN, 600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  Paint.Font = Font["Helvetica, Regular, 10"]
  
  Paint.MoveTo(1, 405)
  docV = Format(Now, "dddd dd mmmm yyyy, hh:nn:ss")
  Paint.DrawRichText(docV, 1, rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = Null
  Paint.Font = Font["Helvetica, Regular, 8"]
  docV = rResultSuc["chr_nombre"]
  Paint.DrawRichText(docV, PRINT_MARGIN, 1100 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  docV = rResultSuc["chr_dir1"]
  Paint.DrawRichText(docV, PRINT_MARGIN, 1300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = rResultSuc["chr_dir2"]
  Paint.DrawRichText(docV, PRINT_MARGIN, 1500 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = rResultSuc["chr_dir3"] & " - " & rResultSuc["chr_telefono1"]
  Paint.DrawRichText(docV, PRINT_MARGIN, 1700 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  'docV &= documento.ResultadoConsultaDB(rResult, False)
  docV = ""
  
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV = "Detalle de la orden:\n"
  Paint.DrawRichText(docV, PRINT_MARGIN, 2000 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 9"]
  Try rResult = modVariables.$hConn.Exec("Select * from vw_orden_prods_precio where `Orden` = &1 and `Activo` = 1 order by `HoraFecha`", modVariables.$intOrderID)
  If rResult <> Null Then
    
    fTotal = 0
    For Each rResult
      docV = ""
      
      sQuery = "Select * from tbl_promociones where id_producto = &1"
        Try rResultPromos = modVariables.$hConn.Exec(sQuery, rResult!IDPR)
        
        If rResultPromos.Available Then 'Hay una promocion para este producto, checar validez de días.
          flTemporal = 0
          If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
            flTemporal = rResult!Precio - (rResult!Precio * rResultPromos!fl_descuento)
            flTemporal = (flTemporal * rResult!Cantidad)
            fTotal = ftotal + flTemporal
          Endif
        Else
          flTemporal = (rResult!Precio * rResult!Cantidad)
          fTotal = ftotal + flTemporal
          Endif
        rResultPromos = Null 

      docV = rResult["Cantidad"] & gb.Tab & gb.Tab & gb.Tab & rResult["Producto"] & gb.Cr & gb.Tab & "$" & CInt(flTemporal)
      Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
      Inc iInc  
    Next
  Endif
  
  Paint.Font = Font["Helvetica, Regular, 12"]
  docV = "Total a Pagar: $" & fTotal & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV = "Efectivo: $" & txtRecibido.Text & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2700 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Bold, 10"]
  docV = "Cambio: $" & CInt(txtRecibido.Text - ftotal) & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2900 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)

  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "Documento sin Efectos Fiscales."
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "Si requiere factura, solicítela el mismo día de compra."
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "Este establecimiento emite tickets en apego a lo"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "previsto Por las leyes vigentes"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3800 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
 
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV = "Muchas gracias por su compra"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 4100 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnOK_MouseUp()

  Dim sQuery As String
  Dim rResult As Result
  Dim myInt As Integer
  
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  Try rResult = modVariables.$hConn.Exec(sQuery)
  myTicket = CInt(rResult[1])
  
  sQuery = "INSERT INTO `db_tacos_roy`.`tbl_ticket_cons` (`id_ticketNrConsecutivo`, `chr_ticketConsecutivo`) VALUES (Null, &1)"

  If Mouse.Control Then
    Try modVariables.$hConn.Exec(sQuery, myTicket)
    Try modVariables.$ticketNumber = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
    myInt = 0
  Else
    Try modVariables.$hConn.Exec(sQuery, myTicket + 1)
    Try modVariables.$ticketNumber = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
    myInt = 1
  Endif
  
  'Se cambia el status del ticket
  sQuery = "UPDATE `tbl_ordenes` SET `chr_status_orden` = &1 where `id_orden_id` = &2"
  Try modVariables.$hConn.Exec(sQuery, txtReferenciaPago.Text, modVariables.$intOrdenID)
  
  sQuery = "INSERT INTO `db_tacos_roy`.`tbl_ordenes_cerradas` ("
  sQuery &= "`id_orden_id`, `dt_horafecha_cierre_orden`, `fl_total`, `bool_factura`, `chr_referencia_notas`, `int_lvl_report`, `id_ticket_IDNr`) VALUES ("
  sQuery &= "&1, &2, &3, &4, &5, &6, &7);"
  
  Try modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenID, Null, fTotal, False, txtReferenciaPago.Text, myInt, modVariables.$ticketNumber)
  If Error Then Message.Error(Error.Text & ", " & Error.Where)
  
  sQuery = "Select * From `vw_info_ordenes_tickets` Where id_orden_id = &1"
  Try rResult = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenID)
  myOrder = rResult["chr_consecutivo"]
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  Try rResult = modVariables.$hConn.Exec(sQuery)
  myTicket = CInt(rResult[1])
  
  sQuery = "SELECT * From `tbl_ordenes` where `chr_status_orden` = 'Abierta' order by id_orden_id"
  FMain1.gridMainOrden.Rows.Count = 0
  
  Try rResult = modVariables.$hConn.Exec(sQuery)
  
  FMain1.gridMainOrden.Rows.Count = rResult.Count
  
  'Se imprime el ticket
  Me.Enabled = False
  Inc Application.Busy
  PrinterCobrar.Print
  Dec Application.Busy
  Me.Enabled = True
  
  Me.Close(True)
  cmbFormaPago.Enabled = True
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End


Public Sub txtDescuento_KeyPress()

  If Len(txtDescuento.text) = 0 Then btnAplicaDesc.Enabled = False Else btnAplicaDesc.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event

End

Public Sub txtDescuento_Change()

  If CInt(txtDescuento.Text) > 100 Then txtDescuento.Text = "99"

End

Public Sub cmbFormaPago_Change()

  Select Case cmbFormaPago.Index
    Case 0
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Efectivo"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = True
      btnOK.Enabled = False
    Case 1
      lblDescuento.Visible = True
      txtDescuento.Visible = True
      btnAplicaDesc.Visible = True
      txtReferenciaPago.Text = "Descuento"
      txtReferenciaPago.Visible = False
      txtRecibido.Enabled = True
      btnOK.Enabled = False
    Case 2
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Cortesía"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
    Case Else
      
    End Select
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub cmbFormaPago_KeyRelease()

  cmbFormaPago_Change()

End

Public Sub cmbFormaPago_MouseUp()

  cmbFormaPago_Change()

End

Public Sub cmbFormaPago_Click()

  cmbFormaPago_Change()

End

Public Sub btnAplicaDesc_Click()

  lblCbTotal.Text = fTotal - (CFloat(fTotal) * (CFloat(txtDescuento.Text) / 100))
  fTotal = CFloat(lblCbTotal.Text)

End

Public Sub txtRecibido_Change()

  If txtRecibido.Text <> "" Then lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)

End
