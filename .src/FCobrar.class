' Gambas class file

Private fTotal As Float
Private fDescuento As Float
'Private rResult As Result
Private rResultFormaPago As Result
Private myOrder As Integer
Private myTicket As Integer
Private rYPrint As Integer

'Private iInc As Integer

Private Const PRINT_MARGIN As Float = 1

Public Function sCalculaCosto(intOrdenID As Integer) As String[]

Dim sQuery As String
Dim hResult, rResultProxOr, rResultPromos, rResultVar, rResultDetail, rNombreVar As Result
Dim flTemporal As Float
Dim docV As New String[2]

  sQuery = "SELECT * FROM tbl_precio_tipo_ordenes where `id_orden` = &1;"
  docV[0] = ""
  Try hResult = modVariables.c_Conn.Exec(sQuery, intOrdenID)
  modVariables.i_intTipoPrecio = hResult["id_tipo_precio"]
  hResult = Null
  
  sQuery = "Select * from vw_prods_x_orden where `Orden` = &1 and `Activo` = 1 and `Tipo Precio` = &2 order by `Control Fecha` Asc"
  Try rResultProxOr = modVariables.c_Conn.Exec(sQuery, intOrdenID, modVariables.i_intTipoPrecio)
  
  If rResultProxOr.available And (rResultProxOr <> Null) Then
    fTotal = 0
    For Each rResultProxOr 'checar promos y costos extra
      sQuery = "Select * from `tbl_promociones` where `id_producto` = &1 and `bit_activo = 1`"
      Try rResultPromos = modVariables.c_Conn.Exec(sQuery, rResultProxOr["ID Prod"])
      If (rResultPromos <> Null) Then 'Hay una promocion para este producto, checar validez de días.
        flTemporal = 0
        If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
          flTemporal = rResultProxOr!Precio - (rResultProxOr!Precio * rResultPromos!fl_descuento)
          flTemporal = (flTemporal * rResultProxOr!Cantidad)
          fTotal = ftotal + flTemporal
        Endif
      Else
        rResultPromos = Null
        sQuery = "SELECT `dbl_precio` as Precio FROM `tbl_precios_productos` where `id_producto` = &1 and int_tipo_precio = &2 and `bit_activo` = 1;"
        Try rResultPromos = modVariables.c_Conn.Exec(sQuery, rResultProxOr["ID Prod"], rResultProxOr["Tipo Precio"])
        flTemporal = rResultPromos["Precio"] * rResultProxOr["Cantidad"]
        fTotal += flTemporal
        docV[0] &= "<tr>"
        docV[0] &= "<td align=\"right\" style=\"font-size: medium;\" width=\"20%\">" & rResultProxOr["Cantidad"] & " x </td><td width=\"65%\"> " & rResultProxOr["Producto"] & " </td><td align=\"right\" width=\"15%\">" & " $" & CInt(flTemporal) & "</td></tr>" 

        rResultPromos = Null
        hResult = Null
        sQuery = "SELECT * FROM `tbl_prods_orden_opciones` where `id_prod_x_orden` = &1"
        
        Try hResult = modVariables.c_Conn.Exec(sQuery, rResultProxOr["IDPO"])
        
        If hResult.Available Then
          For Each hResult
            sQuery = "SELECT * FROM `tbl_prods_variantes` where `id_producto`= &1 and `id_variante` = &2 and `int_activo` = 1 order by `id_producto`, `id_variante`;"
            Try rResultVar = modVariables.c_Conn.Exec(sQuery, rResultProxOr["ID Prod"], hResult["id_variante_platillo"])
            If rResultVar.available Then
              For Each rResultVar
                docV[0] &= "<tr>"
                sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1; "
                Try rResultDetail = modVariables.c_Conn.Exec(sQuery, rResultVar["id_prods_variantes"])
                If rResultDetail.Available Then
                  For Each rResultDetail
                    If rResultDetail["id_tipo_precio"] = rResultProxOr["Tipo Precio"] Then
                      flTemporal = CFloat(rResultDetail["fl_costo_extra"]) * CFloat(rResultProxOr["Cantidad"])
                      fTotal += flTemporal
                      sQuery = "SELECT * FROM `tbl_variantes_platillos` where `id_variante_pl` = &1 order by `fl_ordenar`"
                      Try rNombreVar = modVariables.c_Conn.Exec(sQuery, hResult["id_variante_platillo"])
                      docV[0] &= "<td></td><td>"
                      docV[0] &= gb.CrLf & rNombreVar["chr_imprimir"] & "</td><td colspan=2 align=\"right\">" & " $ " & CInt(flTemporal) & gb.CrLf 
                    Endif
                    docV[0] &= "</td>"
                  Next
                  rResultDetail = Null
                Endif
                docV[0] &= "</tr>"
              Next
              rResultVar = Null
            Endif
          Next
          hResult = Null
          
        Endif
      Endif
      'Inc iInc
    Next
    docV[1] = CStr(fTotal)
Print docV[0]
Endif

  Return docV
  
End


Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btnCancel_Click()

  Me.Close

End

Public Sub Form_Open()

  Dim sQuery As String
  'Dim rResultPromos As Result
  Dim flTemporal As String[]
  
  sQuery = "SELECT * FROM tbl_formas_pago order by id_forma_pago;"
  
  rResultFormaPago = modVariables.c_Conn.Exec(sQuery)
  cmbFormaPago.Clear
  
  For Each rResultFormaPago
    cmbFormaPago.Add(rResultFormaPago["chr_forma_pago"])
  Next
  
  lblCbOrden.Text = modVariables.i_intOrdenID
  lblCbMesa.Text = modVariables.s_strMesaTemp
  
  flTemporal = sCalculaCosto(modVariables.i_intOrdenID) 
    
  lblCbTotal.Text = "$" & CStr(flTemporal[1])
    
  txtReferencia.Text = "Efectivo"
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub txtRecibido_KeyPress()

  Print Str(key.code) 
  'If Len(txtRecibido.text) = 0 Then btnOK.Enabled = False Else btnOK.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)  
End

Public Sub txtRecibido_LostFocus()

  If txtRecibido.Text <> "" Then lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub PrinterCobrar_Draw()

  'Dim documento As New ClassLaTex
  Dim tLetra As String
  Dim sQuery As String
  'Dim hResult, rResultProxOr, , rResultVar, rResultDetail, rNombreVar As Result
  Dim rResultSuc As Result
  'Dim docV As New String[2]
  Dim sTemporal As String[]
  Dim hImage As Image
  'Dim rResultPromos As Result
  'Dim flTemporal As Float
  'Dim iInc As Integer
  
  Dim sArray As String[] = Split(File.Load("Templates/ticketventa.html"), gb.Newline, "", True)
  Dim sHTML As String
  
  sHTML = sArray.Join(gb.Newline)
  
  hImage = Image.Load(User.Home &/ ".tacosroy/pictures" &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 600, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCobrar.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica"]
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  
  sHTML = Replace(sHTML, "@@OrdenNr@@", CStr(modVariables.i_intOrdenID))
  sHTML = Replace(sHTML, "@@TicketNr@@", CStr(myTicket))
  
  'sQuery = "SELECT * FROM `tbl_mesas` where id_mesa_id = &1"
  'Try rResultSuc = modVariables.c_Conn.Exec(sQuery, modVariables.i_intIDMesaTemp)
  
  sHTML = Replace(sHTML, "@@NrMesa@@", CStr(modVariables.s_strMesaTemp))
  'rResultSuc = Null

  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try rResultSuc = modVariables.c_Conn.Exec(sQuery)
  
  sHTML = Replace(sHTML, "@@NombreSucursal@@", CStr(rResultSuc["chr_nombre"]))
  sHTML = Replace(sHTML, "@@DatosSuc1@@", CStr(rResultSuc["chr_dir1"]))
  sHTML = Replace(sHTML, "@@DatosSuc2@@", CStr(rResultSuc["chr_dir2"]))
  sHTML = Replace(sHTML, "@@DatosSuc3@@", CStr(rResultSuc["chr_dir3"]))
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", CStr(rResultSuc["chr_telefono1"]))
  
  'aqui va el calculo con print true
  sTemporal = sCalculaCosto(modVariables.i_intOrdenID)
  sHTML = Replace(sHTML, "@@DetalleOrden@@", sTemporal[0])
  tLetra = modNumeros.EnLetras(CStr(fTotal))
  
  Select Case modVariables.i_tipoCobro
    Case modVariables.COBRO_NORMAL
      sHTML = Replace(sHTML, "@@Total@@", "Total: $" & CStr(fTotal) & ".00")
      tLetra = modNumeros.EnLetras(CStr(fTotal))
    Case modVariables.COBRO_DESCUENTO
      sHTML = Replace(sHTML, "@@Total@@", "Total: $" & CStr(fTotal) & "<br>" & "Descuento: $" & CStr(fDescuento) & "<br>A Pagar: $" & CStr(fTotal - fDescuento) & ".00")
    Case modVariables.COBRO_CORTESIA
      sHTML = Replace(sHTML, "@@Total@@", "Total: $0.00 (Cortesía)")
      tLetra = "CORTESIA - " & tLetra 
    Case modVariables.COBRO_CANCELADO
      sHTML = Replace(sHTML, "@@Total@@", "Total: CANCELADA ($" & CStr(fTotal) & ".00)")
      tLetra = "ORDEN CANCELADA - " & tLetra
      
  End Select
  
  sHTML = Replace(sHTML, "@@TotalLetra@@", tLetra)
    
  If txtRecibido.Text <> "" Then
    lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
  Else
    txtRecibido.Text = "0.00"
  Endif
  
  If cmbFormaPago.Index < 3 Then
    sHTML = Replace(sHTML, "@@Recibido@@", txtRecibido.Text & ".00")
    sHTML = Replace(sHTML, "@@Cambio@@", CStr(CFloat(txtRecibido.Text - fTotal) & ".00"))
  Else
    sHTML = Replace(sHTML, "@@Recibido@@", CStr(fTotal) & ".00")
    sHTML = Replace(sHTML, "@@Cambio@@", "00.00")
  Endif

  PrinterCobrar.PaperWidth = 80
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnOK_MouseUp()

  Dim sQuery, sTemp As String
  Dim hResult As Result
  Dim myInt As Integer
  Dim myTot As Integer
  Dim iOrdenCerrada As Integer
  Dim sTempFile, sCommand As String
  
  Select Case cmbFormaPago.Index
    Case 0
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      'btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Efectivo"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = True
      txtReferencia.Enabled = False
      lblReferencia.Text = ""
      txtReferencia.Text = "Efectivo"
      'btnOK.Enabled = False
    Case 1
      lblDescuento.Visible = True
      txtDescuento.Visible = True
      'btnAplicaDesc.Visible = True
      txtReferenciaPago.Text = "Descuento"
      txtReferenciaPago.Visible = False
      txtRecibido.Enabled = True
      txtReferencia.Enabled = True
      txtReferencia.Text = ""
      lblReferencia.Text = "Referencia:"
      txtReferencia.Text = ""
      fTotal = fDescuento
      If txtDescuento.Text = "" Then
        Message.Warning("Introduzca el descuento")
        txtDescuento.SetFocus
        Return
      Endif
      btnOK.Enabled = False
    Case 2
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      'btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Personal"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
      txtReferencia.Enabled = True
      lblReferencia.Text = "Referencia:"
      txtReferencia.Text = ""
    Case 3
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      'btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "T. Deb/Cred"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
      txtReferencia.Enabled = True
      If txtReferencia.Text = "" Then
        Message.Info("Introduzca Referencia de pago")
        txtReferencia.SetFocus
        Return
      Endif
      lblReferencia.Text = "Numero Operacion:"
    Case Else
  End Select
  
    'Si hay descuento se aplica
  
  sQuery = "Select * From `tbl_consecutivo` ORDER BY `id_consecutivo` DESC LIMIT 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  modVariables.i_intTicketNR = hResult[1]
  myTicket = modVariables.i_intTicketNR
  
  hResult = Null
  modVariables.c_Conn.Begin()
  hResult = modVariables.c_Conn.Create("tbl_ticket_cons")
  Select Case Mouse.Control
    Case True
      myTot = myTicket
      'hResult!chr_ticketConsecutivo = myTicket
      myInt = 0
    Case False
      myTot = myTicket + 1
      'hResult!chr_ticketConsecutivo = myTicket + 1 
      myInt = 1
  End Select
  
  hResult!chr_ticketConsecutivo = myTot
  hResult.Update()
  modVariables.c_Conn.Commit()
  hResult = Null
  Try modVariables.i_ticketNumber = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
  
  'Se cambia el status del ticket
  sQuery = "UPDATE `tbl_ordenes` SET `chr_status_orden` = &1 where `id_orden_id` = &2"
  If txtReferencia.Text = "" Then sTemp = "Cerrada"
  Try modVariables.c_Conn.Exec(sQuery, txtReferencia.Text, modVariables.i_intOrdenID)

  modVariables.c_Conn.Begin()
    hResult = modVariables.c_Conn.Create("tbl_ordenes_cerradas")
    hResult!id_orden_id = modVariables.i_intOrdenID
    hResult!dt_horafecha_cierre_orden = Now()
    hResult!fl_total = fTotal
    hResult!bool_factura = False
    hResult!chr_referencia_notas = txtReferencia.Text
    hResult!int_lvl_report = myInt
    hResult!id_ticket_IDNr = modVariables.i_ticketNumber
    hResult!id_control_fecha = modVariables.i_idControlFecha
    hResult!int_forma_pago = cmbFormaPago.Index + 1
    hResult.Update()
  modVariables.c_Conn.Commit()
  hResult = Null
  
  Try iOrdenCerrada = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
  
  modVariables.c_Conn.Begin()
    hResult = modVariables.c_Conn.Create("tbl_ordenes_descuento")
    hResult!id_orden_cerrada_id = iOrdenCerrada
    hResult!fl_descuento_aplicado = fDescuento
    hResult.Update()
  modVariables.c_Conn.Commit()
  hResult = Null
  
  If cmbFormaPago.Index = 1 Then
    modVariables.c_Conn.Begin()
      hResult = modVariables.c_Conn.Create("tbl_ordenes_descuento")
      hResult!id_orden_cerrada_id = iOrdenCerrada
      hResult!fl_descuento_aplicado = txtDescuento.Text
      hResult.Update()
    modVariables.c_Conn.Commit()
  Endif
  
  If Error Then Message.Error(Error.Text & ", " & Error.Where)
  
  sQuery = "Select * From `vw_info_ordenes_tickets` Where id_orden_id = &1"
  Try hResult = modVariables.c_Conn.Exec(sQuery, modVariables.i_intOrdenID)
  myOrder = hResult["chr_consecutivo"]
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  hResult = Null
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  myTicket = CInt(hResult[1])
  
  sQuery = "SELECT * From `tbl_ordenes` where `chr_status_orden` = 'Abierta' order by id_orden_id"
  FMain1.gridMainOrden.Rows.Count = 0
  hResult = Null
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  If (hResult <> Null) And hResult.Available Then
    FMain1.gridMainOrden.Rows.Count = hResult.Count
  Else
    FMain1.gridMainOrden.Rows.Count = 0
  Endif
  
  hResult = Null
  'Se imprime el ticket
  Me.Enabled = False
  Inc Application.Busy
  PrinterCobrar.PaperWidth = 80
  'PrinterCobrar.Configure
  sTempFile = User.Home &/ "Tickets/" 
  sTempFile &= "ticket_" & modVariables.i_intTicketNR & "-" & modUtils.convierteFechaFormatoHora(Now) & ".pdf"
  sTempFile = Replace(sTempFile, " ", "-")
  PrinterCobrar.OutputFile = sTempFile
  PrinterCobrar.Print()
  
  sCommand = "lpr " & sTempFile 
  Shell sCommand
  
  If chkFactura.Value = True Then
    hResult = Null
    modVariables.c_Conn.Begin()
      hResult = modVariables.c_Conn.Create("tbl_facturas")
      hResult!id_orden = iOrdenCerrada
      hResult!chr_nr_factura = "Por llenar"
      hResult.Update()
    modVariables.c_Conn.Commit()
     'If modVariables.iClienteID <= 0 Then Message.Info("Tendra que elegir cliente mas adelante")
    If chkFacturaPendiente.Value = False Then
      Dim Email As New SmtpClient
    
      Do While modVariables.iClienteID <= 0
        FBClientes.ShowModal
        If modVariables.iClienteID <= 0 Then
          Message.Error("Debe elegir un cliente")
        Else
          Exit
        Endif
      Loop
      
      hResult = Null
      sQuery = "Select * from `tbl_ordenes_x_clientes` where id_orden = &1"
      Try hResult = modVariables.c_Conn.Exec(sQuery, iOrdenCerrada)
      
      If hResult = Null Or hResult.Available = False Then 'Sin cliente asignado para facturar
        hResult = Null
        modVariables.c_Conn.Begin()
          hResult = modVariables.c_Conn.Create("tbl_ordenes_x_clientes")
          hResult!id_orden = iOrdenCerrada
          hResult!id_cliente = modVariables.iClienteID
          hResult.Update()
        modVariables.c_Conn.Commit()
        
      Endif
      
      hResult = Null
      sQuery = "Select `chr_var_value` from `tbl_configs` where `chr_var_name` = &1"
      Try hResult = modVariables.c_Conn.Exec(sQuery, "email_host")
      If (hResult <> Null) And hResult.Available Then Email.Host = hResult["chr_var_value"]
      
      hResult = Null
      sQuery = "Select `chr_var_value` from `tbl_configs` where `chr_var_name` = &1"
      Try hResult = modVariables.c_Conn.Exec(sQuery, "email_user")
      If (hResult <> Null) And hResult.Available Then Email.User = hResult["chr_var_value"]
      
      hResult = Null
      sQuery = "Select `chr_var_value` from `tbl_configs` where `chr_var_name` = &1"
      Try hResult = modVariables.c_Conn.Exec(sQuery, "email_password")
      If (hResult <> Null) And hResult.Available Then Email.Password = hResult["chr_var_value"]
      
      'Email.Host = "smtpout.secureserver.net"
      'Email.User = "pedidos@tacosroy.com"
      'Email.Password = ".tacos1965."
      hResult = Null
      sQuery = "SELECT * FROM tbl_clientes where id_cliente = &1"
      Try hResult = modVariables.c_Conn.Exec(sQuery, modVariables.iClienteID)
      
      Email.From = "pedidos@tacosroy.com"
      Email.To.Add("carlos.revilla.m@gmail.com")
      'Email.To.Add("carlos.revilla.m@gmail.com") 'Opcional, agregar email de vladis
    
      Email.Subject = "Nueva factura Tacos Roy"
      Email.Body = hResult["chr_nombre"] & " " & hResult["chr_apellidos"] & "\n"
      Email.Body &= hResult["chr_email"] & "\n"
      Email.Body &= "Direccion:\n" & hResult["chr_direccion1"] & " #" & hResult["chr_num_ext"] & " - " & hResult["chr_num_int"] & "\n"
      Email.Body &= hResult["chr_direccion2"] & "\n" & hResult["chr_colonia"] & " CP:" & hResult["chr_CP"] & "\n"
      Email.Body &= hResult["chr_municipio"] & "\n" & hResult["chr_ciudad"] & " CP:" & hResult["chr_CP"] & "\n"
      Email.Body &= "Total: $" & fTotal & "\n"
      Email.Body &= "ID Orden Cerrada: " & iOrdenCerrada & "\n" 
      
      Email.Add(File.Load(sTempFile), "application/pdf", "ticket_" & modVariables.i_intTicketNR & "-" & Format(Now, "yyyy-mm-dd") & ".pdf")
      Email.Send
    Else
      Message.Info("Tendra que asignar cliente a la factura mas adelante")
    Endif
  Endif
  
  Dec Application.Busy
  Me.Enabled = True
  
Finally 
  With FMain1
    .gridOrdenDetails.Rows.count = 0
    .btnCancelOrden.Enabled = False
    .btnCerrarOrden.Enabled = False
    .btnImrpimeCuenta.Enabled = True
    .btnModifOrden.Enabled = False
  End With
  modVariables.i_intOrdenID = 0
  modVariables.iClienteID = 0
  modVariables.i_intIDMesaTemp = 0
  modVariables.s_strMesaTemp = ""
  Me.Close(True)
  cmbFormaPago.Enabled = True
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End


Public Sub cmbFormaPago_Change()

  rResultFormaPago.MoveTo(cmbFormaPago.Index)
  
  Select Case cmbFormaPago.Index
    Case 0
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      'btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Efectivo"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = True
      txtReferencia.Enabled = False
      lblReferencia.Text = ""
      txtReferencia.Text = "Efectivo"
      'btnOK.Enabled = False
      modVariables.i_tipoCobro = modVariables.COBRO_NORMAL
    Case 1
      lblDescuento.Visible = True
      txtDescuento.Visible = True
      'btnAplicaDesc.Visible = True
      txtReferenciaPago.Text = "Descuento"
      txtReferenciaPago.Visible = False
      txtRecibido.Enabled = True
      txtReferencia.Enabled = True
      txtReferencia.Text = ""
      lblReferencia.Text = "Referencia:"
      btnOK.Enabled = False
      modVariables.i_tipoCobro = modVariables.COBRO_DESCUENTO
    Case 2
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      'btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "Personal"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
      txtReferencia.Enabled = True
      lblReferencia.Text = "Nombre:"
      txtReferencia.Text = ""
      modVariables.i_tipoCobro = modVariables.COBRO_CORTESIA
    Case 3
      lblDescuento.Visible = False
      txtDescuento.Visible = False
      'btnAplicaDesc.Visible = False
      txtReferenciaPago.Text = "T. Deb/Cred"
      txtReferenciaPago.Visible = True
      txtRecibido.Enabled = False
      btnOK.Enabled = True  
      txtReferencia.Enabled = True
      lblReferencia.Text = "Ref. Operacion:"
      txtReferencia.Text = ""
      modVariables.i_tipoCobro = modVariables.COBRO_NORMAL
    Case Else
      
    End Select
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub cmbFormaPago_KeyRelease()

  cmbFormaPago_Change()

End

Public Sub cmbFormaPago_MouseUp()

  cmbFormaPago_Change()

End

Public Sub cmbFormaPago_Click()

  cmbFormaPago_Change()

End


Public Sub txtRecibido_Change()

  If txtRecibido.Text <> "" Then 
    If cmbFormaPago.Index = 2 Then
      lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fDescuento)
    Else
      lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
    Endif
  Endif

End



Public Sub chkFactura_Click()

  chkFacturaPendiente.Enabled = chkFactura.Value

End


Public Sub txtDescuento_LostFocus()

Dim flTemporal As String[]
  
  If txtDescuento.Length > 0 Then
    flTemporal = sCalculaCosto(modVariables.i_intOrdenID) 
    fTotal = flTemporal[1]
    fDescuento = CFloat(txtDescuento.Text)
    fTotal -= fDescuento 
    lblCbTotal.Text = fTotal
    'fDescontado = fTotal
    'fTotal = fDescuento
    btnOK.Enabled = True
  Else
    btnOK.Enabled = False
  Endif

End
