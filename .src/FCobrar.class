' Gambas class file

Private fTotal As Float
Private rResult As Result
Private myOrder As Integer
Private myTicket As Integer

Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btnCancel_Click()

  Me.Close

End


Public Sub Form_Open()

  Dim sQuery As String
  Dim rResultPromos As Result
  Dim flTemporal As Float
  
  lblCbOrden.Text = modVariables.$intOrdenTmp
  lblCbMesa.Text = modVariables.$strMesaTemp
  
  'vw_order_prods_precio
  sQuery = "Select * from vw_orden_prods_precio where Orden = &1 order by `IDPO` Asc"
    
    Print sQuery & ", " & modVariables.$intOrdenTmp
    Try rResult = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenTmp)
    If Error Then Message.Error(Error.text)
    
    If rResult.Available Then
      fTotal = 0
      For Each rResult
        
        sQuery = "Select * from tbl_promociones where id_producto = &1"
        Try rResultPromos = modVariables.$hConn.Exec(sQuery, rResult!IDPR)
        If rResultPromos.Available Then 'Hay una promocion para este producto, checar validez de días.
          If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
            flTemporal = rResult!Precio - (rResult!Precio * rResultPromos!fl_descuento)
            fTotal = fTotal + (flTemporal * rResult!Cantidad)
          Endif
        Else
          fTotal = fTotal + (rResult!Precio * rResult!Cantidad)
        Endif
        rResultPromos = Null 
        'rResult.MoveNext
      Next
    Endif
    
    lblCbTotal.Text = "$" & CStr(fTotal)

End

Public Sub txtRecibido_KeyPress()

  Print Str(key.code) 
  If Len(txtRecibido.text) = 0 Then btnOK.Enabled = False Else btnOK.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
  
End

Public Sub txtRecibido_LostFocus()

  lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)

End

Public Sub PrinterCobrar_Draw()

  Dim documento As New ClassLaTex
  Dim tex As String
  Dim sQuery As String
  Dim rResult2 As Result
  Dim docV As String
  Dim hImage As Image
  Dim rYPrint As Integer
  Dim rResultPromos As Result
  Dim fTotal, flTemporal As Float
  
  Dim PRINT_MARGIN As Float
  Dim iInc As Integer

  PRINT_MARGIN = 2
  iInc = 1
  
  If txtRecibido.Text = "" Then 
    Message.Error("Indique la cantidad recibida por favor")
    txtRecibido.SetFocus
    Return
  Endif
  
  sQuery = "Select Producto, Cantidad, Precio, (Cantidad * Precio) as Subtotal from vw_orden_prods_precio where Orden = &1"
  
  Try rResult2 = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenTmp)
  If Error Then Message.Error(Error.text)
    
  lblCambio.Text = "$" & CStr(CFloat(txtRecibido.Text) - fTotal)
  
  hImage = Image.Load(Application.Path &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 200, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCobrar.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica, Bold, 18"]
  docV = "Orden: " & modVariables.$intOrdenTmp & ", Ticket Nr.: " & myTicket 
  Paint.DrawRichText(docV, PRINT_MARGIN, 300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = "Mesa: " & modVariables.$strMesaTemp
  Paint.DrawRichText(docV, PRINT_MARGIN, 600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  Paint.Font = Font["Helvetica, Regular, 10"]
  
  Paint.MoveTo(1, 405)
  docV = Format(Now, "dddd dd mmmm yyyy, hh:nn:ss")
  Paint.DrawRichText(docV, 1, rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = Null
  Paint.Font = Font["Helvetica, Regular, 9"]
  docV = "TACOS ROY, Sucursal Ant. Aeropuerto" 
  Paint.DrawRichText(docV, PRINT_MARGIN, 1100 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  docV = "Escuadron 201 No. 300-1" 
  Paint.DrawRichText(docV, PRINT_MARGIN, 1300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = "Col. Antiguo Aeropuerto" 
  Paint.DrawRichText(docV, PRINT_MARGIN, 1500 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  docV = "Oaxaca de Juárez, Oaxaca - CP 68050" 
  Paint.DrawRichText(docV, PRINT_MARGIN, 1700 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  'docV &= documento.ResultadoConsultaDB(rResult, False)
  docV = ""
  
  Paint.Font = Font["Helvetica, Regular, 12"]
  docV = "Detalle de la orden:"
  Paint.DrawRichText(docV, PRINT_MARGIN, 2000 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 10"]
  Try rResult = modVariables.$hConn.Exec("Select * from vw_orden_prods_precio where Orden = &1", modVariables.$intOrdenTmp)
  If rResult.Available Then
    For Each rResult
      
      
      sQuery = "Select * from tbl_promociones where id_producto = &1"
        Try rResultPromos = modVariables.$hConn.Exec(sQuery, rResult!IDPR)
        
        If rResultPromos.Available Then 'Hay una promocion para este producto, checar validez de días.
          flTemporal = 0
          If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
            flTemporal = rResult!Precio - (rResult!Precio * rResultPromos!fl_descuento)
            flTemporal = (flTemporal * rResult!Cantidad)
            fTotal = ftotal + flTemporal
          Endif
        Else
          flTemporal = (rResult!Precio * rResult!Cantidad)
          fTotal = ftotal + flTemporal
          Endif
        rResultPromos = Null 

      docV = rResult["Cantidad"] & gb.Tab & gb.Tab & gb.Tab & rResult["Producto"] & gb.Cr & gb.Tab & "$" & CInt(flTemporal)
      Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
      Inc iInc  
    Next
  Endif
  
  Paint.Font = Font["Helvetica, Regular, 14"]
  docV = "Total a Pagar: $" & fTotal & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 11"]
  docV = "Efectivo: $" & txtRecibido.Text & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2700 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Bold, 11"]
  docV = "Cambio: $" & CInt(txtRecibido.Text - ftotal) & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2900 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)

  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "Documento sin Efectos Fiscales."
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "Si requiere factura, solicítela el mismo día de compra."
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "Este establecimiento emite tickets en apego a lo"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV = "previsto Por las leyes vigentes"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 3800 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
 
  Paint.Font = Font["Helvetica, Regular, 11"]
  docV = "Muchas gracias por su compra"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 4100 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCobrar.Count, Align.TopNormal)
  
End

Public Sub btnOK_MouseUp()

  Dim sQuery As String
  Dim rResult As Result
  Dim myInt As Integer
  
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  Try rResult = modVariables.$hConn.Exec(sQuery)
  myTicket = CInt(rResult[1])
  
  sQuery = "INSERT INTO `db_tacos_roy`.`tbl_ticket_cons` (`id_ticketNrConsecutivo`, `chr_ticketConsecutivo`) VALUES (Null, &1)"

  If Mouse.Control Then
    Try modVariables.$hConn.Exec(sQuery, myTicket)
    Try modVariables.$ticketNumber = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
    myInt = 0
  Else
    Try modVariables.$hConn.Exec(sQuery, myTicket + 1)
    Try modVariables.$ticketNumber = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
    myInt = 1
  Endif
  
  'Se cambia el status del ticket como pagado
  sQuery = "UPDATE `tbl_ordenes` SET `chr_status_orden` = 'PAGADA' where `id_orden_id` = &1"
  Try modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenTmp)
  
  sQuery = "INSERT INTO `db_tacos_roy`.`tbl_ordenes_cerradas` ("
  sQuery &= "`id_orden_id`, `dt_horafecha_cierre_orden`, `fl_total`, `bool_factura`, `chr_referencia_notas`, `int_lvl_report`, `id_ticket_IDNr`) VALUES ("
  sQuery &= "&1, &2, &3, &4, &5, &6, &7);"
  
  Try modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenTmp, Null, fTotal, False, "Efectivo", myInt, modVariables.$ticketNumber)
  If Error Then Message.Error(Error.text)
  
  sQuery = "Select * From `vw_info_ordenes_tickets` Where id_orden_id = &1"
  Try rResult = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenTmp)
  myOrder = rResult["chr_consecutivo"]
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  Try rResult = modVariables.$hConn.Exec(sQuery)
  myTicket = CInt(rResult[1])
  
  sQuery = "SELECT * From `tbl_ordenes` where `chr_status_orden` = 'Abierta' order by id_orden_id"
  FMain1.gridMainOrden.Rows.Count = 0
  
  Try rResult = modVariables.$hConn.Exec(sQuery)
  
  FMain1.gridMainOrden.Rows.Count = rResult.Count
  
  'Se imprime el ticket
  Me.Enabled = False
  Inc Application.Busy
  PrinterCobrar.Print
  Dec Application.Busy
  Me.Enabled = True
  
  Me.Close(True)

End

