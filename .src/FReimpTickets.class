' Gambas class file

Public myCSVfile As CsvFile
Private iRecords As Integer
Private colRecords As New Collection
Private aFields As String[]
Private myiComanda As Integer
Private myDate As Date
Private myfTotal As Float
Private myImporte As Float
Private myFormaPago As String
Private myFactura As Boolean

Private myIConsecutivo As Integer
Private mySConsecutivo As String
Private myHora As String

Private hResultPrint As Result
'Impresion de tickets y  reportes
Private rYPrint As Integer
Private Const PRINT_MARGIN As Float = 1

Private sPrefijo As String

Public Sub Form_Open()

  
End

Public Sub Button2_Click()

  Me.Close

End

Public Sub btnImprimeT_Click()

Dim iInc As Integer
Dim sTempFile, scommand As String
Dim iRecordsCount As Integer
Dim myField, myColName, myValue As Variant
Dim sYear, sMonth, sDay As Integer
Dim sQuery As String
Dim hResult As Result
Dim ConsecutivoFound, bComandaFound, bDateFound, bImporteFound As Boolean
Dim bFacturaEncontrada As Boolean
Dim bPrintTicket As Boolean
Dim bFormaPagoFound As Boolean
Dim sPreTicket As Integer
Dim myControlFecha As Integer


  iInc = 0
  Me.Enabled = False
  Inc Application.Busy
  'If gridFacturas.Rows.Selection.Count > 0 Then 
    'For Each iInc In gridFacturas.Rows.Selection
      PrinterCuenta.PaperWidth = 80
      'For iRecordsCount = 0 To colRecords.Count
      'Print iRecordsCount
      For Each myField In colRecords
        bPrintTicket = False
        If (myField <> Null) Then
          For Each myColName In aFields
            bPrintTicket = False
            Select Case myColName
              Case "idorden"
                If (myField["idorden"] <> Null And myField["idorden"] <> "N/A") Then 
                  modVariables.i_intOrdenID = CInt(myField["idorden"])
                  bComandaFound = True
                Endif
              Case "idorc" 
                If (myField["idorc"] <> Null And myField["idorc"] <> "N/A") Then 
                  myiComanda = CInt(myField["idorc"])
                  bComandaFound = True
                Endif
              Case "fecha2"
                'Hay que corregir la fecha, pues el sistema me da un dia de menos
                If (myField["fecha2"] <> Null) Then 
                  myValue = myField["fecha2"]
                  sYear = CInt(Left(myValue, 4))
                  sMonth = CInt(Mid(myValue, 6, 2))
                  sDay = CInt(Right(myValue, 2))
                  myDate = CDate("01/01/1980 00:00:00")
                  myDate = DateAdd(myDate, gb.Year, sYear - 1980)
                  myDate = DateAdd(myDate, gb.Month, sMonth - 1)
                  myDate = DateAdd(myDate, gb.Day, sDay)
                  myDate = DateAdd(myDate, gb.Hour, -18)
                  'myDate = DateAdd(myDate, gb.Minute, -59)
                  bDateFound = True
                Endif
              Case "fpago"
                If myField["fpago"] <> "" Then
                  myFormaPago = myField["fpago"]
                  bFormaPagoFound = True 
                Endif
              Case "importe"
                If myField["importe"] <> "" Then
                  myImporte = myField["importe"]
                bImporteFound = True
                Endif
              Case "factura"
                If myField["factura"] <> "" Then
                  myFactura = myField["factura"]
                Endif
              Case "control fecha"
                If myField["control fecha"] <> "" Then
                  myControlFecha = myField["control fecha"]
                  squery = "Select * from tbl_control_fechas where id_control_fechas = &1"
                  hResult = Null
                  hResult = modVariables.c_Conn.Exec(squery, myControlFecha)
                  sPrefijo = Left(modVariables.sPrefijoDB, 2) & Format(hResult["dt_fecha_calendario"], "mm")
                Endif
              Default 
            End Select

            If bComandaFound And bDateFound And bFormaPagoFound And bImporteFound Then 
              myIConsecutivo += 1
              mySConsecutivo = Left(modVariables.sPrefijoDB, 2) & Format(Now, "mm") & "-" & myIConsecutivo
              If Exist(User.Home &/ "Tickets" &/ modVariables.sPrefijoDB &/ Format(Now, "yyyy") &/ Format(Now, "mm") &/ Format(Now, "dd")) = False Then
                modUtils.CreateDirTree(User.Home &/ "Tickets" &/ modVariables.sPrefijoDB &/ Format(Now, "yyyy") &/ Format(Now, "mm") &/ Format(Now, "dd"))
              Endif
                sTempFile = User.Home &/ "Tickets" &/ modVariables.sPrefijoDB &/ Format(Now, "yyyy") &/ Format(Now, "mm") &/ Format(Now, "dd") &/ "ticket_" & sPrefijo & "-" & myiConsecutivo
                sTempFile = Replace(sTempFile, " ", "_")
                PrinterCuenta.OutputFile = sTempFile & ".pdf"
                PrinterCuenta.Print()
                Wait 1.0
                ConsecutivoFound = False
                bComandaFound = False
                bDateFound = False
                bFormaPagoFound = False
                bImporteFound = False
                myFactura = False
                sPrefijo = ""
                myiComanda = 0
            Endif
          Next 
        Endif
      
        
      Next
    'Next
    
    'sCommand = "for FILE in *.pdf ; do lpr \"$FILE\" ; done"
    'Shell sCommand Wait
        
    Me.Enabled = True
    Dec Application.Busy
    
  'Endif 
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub PrinterCuenta_Draw()

  Dim sQuery As String
  Dim hResult As Result
  Dim sTemporal As String[]
  Dim hImage As Image
  
  Dim sArray As String[] = Split(File.Load("Templates/ticketreporte-" & modVariables.sPrefijoDB & ".html"), gb.Newline, "", True)
  Dim sHTML As String
  
  sHTML = sArray.Join(gb.Newline)
  PrinterCuenta.PaperWidth = 80
  hImage = Image.Load("Imagenes" &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(19, 105)
  Paint.DrawImage(hImage, 12, 600, hImage.Width * 7, hImage.Height * 7)
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica"]

  sHTML = Replace(sHTML, "@@DateTime@@", Format(myDate, "yyyy-mm-dd"))
  'sHTML = Replace(sHTML, "@@OrdenNr@@", CStr(modVariables.i_intOrdenID))
  sHTML = Replace(sHTML, "@@TicketNr@@", sPrefijo & "-" & CStr(myiConsecutivo))
  'sHTML = Replace(sHTML, "@@NrMesa@@", modVariables.s_strMesaTemp)
  'sHTML = Replace(sHTML, "@@FormaPago@@", colRecords["Forma Pago"])
  
  hResult = Null
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  sHTML = Replace(sHTML, "@@NombreSucursal@@", CStr(hResult["chr_nombre"]))
  sHTML = Replace(sHTML, "@@DatosSuc1@@", CStr(hResult["chr_dir1"]))
  sHTML = Replace(sHTML, "@@DatosSuc2@@", CStr(hResult["chr_dir2"]))
  sHTML = Replace(sHTML, "@@DatosSuc3@@", CStr(hResult["chr_dir3"]))
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", CStr(hResult["chr_telefono1"]))
  '
  'aqui va el calculo con print true
  sTemporal = FCobrar.sCalculaCosto(modVariables.i_intOrdenID)
  sHTML = Replace(sHTML, "@@DetalleOrden@@", sTemporal[0])
  'rYPrint = sTemporal[3]
  'tLetra = 
  sHTML = Replace(sHTML, "@@Total@@", "Total: " & sTemporal[1] & ".00")
  sHTML = Replace(sHTML, "@@Recibido@@", sTemporal[1] & ".00")
  sHTML = Replace(sHTML, "@@Cambio@@", "0.00")
  sHTML = Replace(sHTML, "@@TotalLetra@@", modNumeros.EnLetras(CStr(sTemporal[1])))
  'tbl_ordenes_cerradas
  
  Paint.Font = Font["Helvetica"]
  PrinterCuenta.PaperWidth = 80
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub Button4_Click()
Dim iInt As Integer
Dim myPath As String

  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  If myPath <> "" Then 
    myCSVfile = New CsvFile(myPath)
    Do Until myCSVfile.Eof
      colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
      Inc iRecords                                    'count the number of records
    Loop
    aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
    
    gridFacturas.Rows.Count = 0
    gridFacturas.Columns.Count = 0
    
    gridFacturas.Header = GridView.Horizontal
    gridFacturas.Grid = True
    gridFacturas.Columns.Count = aFields.Count
    
    For iInt = 0 To aFields.Count - 1
      gridFacturas.Columns[iInt].Text = myCSVfile.Fields[iInt]
    Next
    'display some data from the CSV file
    If colRecords.Count > 0 Then 
      gridFacturas.Rows.Count = colRecords.Count 
      btnImprimeT.Enabled = True
      lblSubTotal.Text = "Columnas: " & aFields.Count & ", Comandas encontradas: " & colRecords.Count 
    Else 
      gridFacturas.Rows.Count = 0
      btnImprimeT.Enabled = False
      lblSubTotal.Text = "0 Registros"
    Endif 
  Else 
    btnImprimeT.Enabled = False
  Endif

Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)
  
End

Public Sub gridFacturas_Data(Row As Integer, Column As Integer)
  
  If Row Mod 2 = 0 Then gridFacturas.Data.Background = Color.RGB(115, 115, 115)
  gridFacturas.Data.text = colRecords[Row + 2][CStr(aFields[Column])]
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End
