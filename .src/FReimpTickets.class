' Gambas class file

Private rsRecords As Result
Private tmpOrden_prods_precio As Result
Private rYPrint As Integer
'Private myTicket As Integer
'Private fTotal As Float
'Private myOrder As Integer
'Private iInc As Integer

Private Const PRINT_MARGIN As Float = 1

Public Sub Form_Open()

  'Abrimos la conexion que serÃ¡ utilizada en el proyecto
  modVariables.c_Conn = modConn.ConectarDB()
  
  gridMainOrden.header = GridView.Horizontal
  gridMainOrden.grid = True
  gridMainOrden.Rows.count = 0
  gridMainOrden.Columns.count = 4
  gridMainOrden.Columns[0].text = "Orden"
  gridMainOrden.Columns[1].text = "Hora"
  gridMainOrden.Columns[2].text = "Mesa"
  gridMainOrden.Columns[3].text = "Status"
  
  gridMainOrden.Columns[0].width = 80
  gridMainOrden.Columns[1].width = 100
  gridMainOrden.Columns[2].width = 80
  gridMainOrden.Columns[3].width = 100

  gridOrdenDetails.header = GridView.Horizontal
  gridOrdenDetails.grid = True
  gridOrdenDetails.Rows.count = 0
  gridOrdenDetails.Columns.count = 6
  gridOrdenDetails.Columns[0].text = "Orden"
  gridOrdenDetails.Columns[1].text = "IDPO"
  gridOrdenDetails.Columns[2].text = "Producto"
  gridOrdenDetails.Columns[3].text = "IDPR"
  gridOrdenDetails.Columns[4].text = "Cantidad"
  gridOrdenDetails.Columns[5].text = "Precio"
  'gridOrdenDetails.Columns[6].text = "TicketNR"
  
  gridOrdenDetails.Columns[0].width = 0
  gridOrdenDetails.Columns[1].width = 0
  gridOrdenDetails.Columns[2].width = 180
  gridOrdenDetails.Columns[3].width = 0
  gridOrdenDetails.Columns[4].width = 40
  gridOrdenDetails.Columns[5].width = 40

  PrinterCuenta.PaperWidth = 80
End

Public Sub btnImrpimeCuenta_Click()

  Me.Enabled = False
  PrinterCuenta.PaperWidth = 80
  Inc Application.Busy
  'PrinterCuenta.Print()
  PrinterCuenta.OutputFile = User.Home &/ "Tickets/ticketcopia_" & modVariables.i_intTicketNR & "-" & modUtils.convierteFechaFormatoHora(Now) & ".pdf"
  PrinterCuenta.Print()
  'If PrinterCuenta.Configure = True Then PrinterCuenta.Print Else PrinterCuenta.Cancel
  Dec Application.Busy
  Me.Enabled = True

End

Public Sub PrinterCuenta_Draw()

  Dim sQuery As String
  Dim hResult As Result
  Dim sTemporal As String[]
  Dim hImage As Image
  
  Dim sArray As String[] = Split(File.Load(User.Home &/ "Templates/ticketcopia.html"), gb.Newline, "", True)
  Dim sHTML As String
  
  sHTML = sArray.Join(gb.Newline)
  PrinterCuenta.PaperWidth = 80
  hImage = Image.Load("Imagenes" &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 600, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica"]
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  'sHTML = Replace(sHTML, "@@OrdenNr@@", CStr(modVariables.i_intOrdenID))
  
  sQuery = "Select * From `tbl_consecutivo` where `id_consecutivo` = &1"
  Try hResult = modVariables.c_Conn.Exec(sQuery, modVariables.i_intOrdenID)
  
  modVariables.i_intTicketNR = hResult["chr_consecutivo"]
  
  sHTML = Replace(sHTML, "@@TicketNr@@", CStr(modVariables.i_intTicketNR))
  hResult = Null
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  sHTML = Replace(sHTML, "@@NombreSucursal@@", CStr(hResult["chr_nombre"]))
  sHTML = Replace(sHTML, "@@DatosSuc1@@", CStr(hResult["chr_dir1"]))
  sHTML = Replace(sHTML, "@@DatosSuc2@@", CStr(hResult["chr_dir2"]))
  sHTML = Replace(sHTML, "@@DatosSuc3@@", CStr(hResult["chr_dir3"]))
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", CStr(hResult["chr_telefono1"]))
  '
  
  'aqui va el calculo con print true
  sTemporal = FCobrar.sCalculaCosto(modVariables.i_intOrdenID)
  sHTML = Replace(sHTML, "@@DetalleOrden@@", sTemporal[0])
  'rYPrint = sTemporal[3]
  
  sHTML = Replace(sHTML, "@@Total@@", sTemporal[1])
  
  Paint.Font = Font["Helvetica"]
  PrinterCuenta.PaperWidth = 80
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End

Public Sub btnFindTicket_MouseUp()

Dim rResult As Result
Dim sQueryString As String

  modVariables._cnnFechaInicio = DtBPickDateStart.Value
  modVariables._cnnFechaFinal = DtBPickDateEnd.Value
  If Mouse.Control Then
    sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_horafecha_cierre_orden) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' order by dt_horafecha_cierre_orden, id_orden_id ASC"
  Else
    sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_horafecha_cierre_orden) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
  Endif
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString)
  
  If (rsRecords <> Null) Then
    gridMainOrden.Rows.Count = 0
    
    'SELECT * FROM  tbl_precio_tipo_ordenes;
    sQueryString = "SELECT `id_tipo_precio` FROM  tbl_precio_tipo_ordenes where `id_orden` = &1;"
    Try rResult = modVariables.c_Conn.Exec(sQueryString, rsRecords["id_orden_id"])
    If (rResult <> Null) Then modVariables.i_intTipoPrecio = rResult[0]
    
    gridMainOrden.Rows.Count = rsRecords.Count
   
    Label1.Text = "Se han encontrado \n" & rsRecords.Count & " movimientos"
    'GridView1.Refresh
    'btnGeneraUnica.Enabled = True
  Else
    'GridView1.Clear
    gridMainOrden.Rows.Count = 0
    'btnGeneraUnica.Enabled = False
    Label1.Text = "No existen movimientos\npara la fecha seleccionada"
    btnImrpimeCuenta.Enabled = False
  Endif

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End

Public Sub gridMainOrden_Data(Row As Integer, Column As Integer)
  
  If Row >= 0 Then
    rsRecords.moveTo(Row)
    Try gridMainOrden.Data.Text = Str(rsRecords[Column])
    If Error Then Print Error.Text & ", " & Error.Where
  Endif
  If row Mod 2 = 0 Then gridMainOrden.Data.Background = Color.RGB(105, 105, 105)
End

Public Sub gridMainOrden_Click()

  Dim qString As String
  Dim intTempOrder As Integer

  gridOrdenDetails.Rows.Count = 0
  intTempOrder = rsRecords.MoveTo(gridMainOrden.Row)
  modVariables.i_intOrdenID = rsRecords["id_orden_id"]
  'modVariables.i_intTicketNR = hResultOrdenes["TicketNR"]
  modVariables.s_strMesaTemp = rsRecords["Mesa"]
  
  'btnCancelOrden.Enabled = True
  'btnModifOrden.Enabled = True
  'btnCerrarOrden.Enabled = True

  qString = "Select * from vw_prods_x_orden where `Orden` = &1 and `Activo` = 1 and `Tipo Precio` = &2 order by `HoraFecha` Asc"  
    Try tmpOrden_prods_precio = modVariables.c_Conn.Exec(qString, rsRecords["id_orden_id"], modVariables.i_intTipoPrecio)
    If Error Then 
      Message.Error(Error.Text & ", " & Error.Where) 
     Else 
      'Message(qString & ", " & hResultOrdenes[0])
      gridOrdenDetails.Rows.Count = tmpOrden_prods_precio.Count
    Endif
  
If gridMainOrden.Row > 0 Then btnImrpimeCuenta.Enabled = True

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End

Public Sub gridOrdenDetails_Data(Row As Integer, Column As Integer)

  Try tmpOrden_prods_precio.moveTo(Row)
  Try gridOrdenDetails.Data.text = Str(tmpOrden_prods_precio[gridOrdenDetails.Columns[column].text])  
  
  If row Mod 2 = 0 Then gridOrdenDetails.Data.Background = Color.RGB(115, 115, 115)
  
  btnImrpimeCuenta.Enabled = True

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End
