' Gambas class file

Private sQueryString As String
Private rsRecords As Result
Private tmpOrden_prods_precio As Result
Private rYPrint As Integer
Private myTicket As Integer
Private fTotal As Float
Private myOrder As Integer
Private iInc As Integer

Private Const PRINT_MARGIN As Float = 1

Public Sub btnImrpimeCuenta_Click()

  Me.Enabled = False
  Inc Application.Busy
  PrinterCuenta.OutputFile = User.Home &/ "Tickets/ticketOrden_" & modVariables.i_intTicketNR & ".pdf"
  PrinterCuenta.Print()
  Dec Application.Busy
  Me.Enabled = True

End

Public Sub PrinterCuenta_Draw()

  Dim sQuery As String
  Dim hResult, rResultProxOr, rResultSuc, rResultVar, rResultDetail, rNombreVar As Result
  Dim docV As New String[3]
  Dim sTemporal As String[]
  Dim hImage As Image
  Dim rResultPromos As Result
  Dim flTemporal As Float
  Dim iInc As Integer
  iInc = 1

  
  hImage = Image.Load(User.Home &/ ".tacosroy/pictures" &/ "logoTicketCopia.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 200, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Helvetica, Bold, 12"]
  docV[0] = "Orden: " & modVariables.i_intOrdenID & ", Ticket Nr.: " & myTicket 
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  docV[0] = "Mesa: " & modVariables.s_strMesaTemp
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  Paint.Font = Font["Helvetica, Regular, 10"]
  
  Paint.MoveTo(1, 405)
  docV[0] = Format(Now, "dddd dd mmmm yyyy, hh:nn:ss")
  Paint.DrawRichText(docV[0], 1, rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  docV[0] = ""
  
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try rResultSuc = modVariables.c_Conn.Exec(sQuery)
  
  Paint.Font = Font["Helvetica, Regular, 8"]
  docV[0] = rResultSuc["chr_nombre"]
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 1100 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  docV[0] = rResultSuc["chr_dir1"]
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 1300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  docV[0] = rResultSuc["chr_dir2"]
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 1500 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  docV[0] = rResultSuc["chr_dir3"] & " - " & rResultSuc["chr_telefono1"]
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 1700 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  'docV[0] &= documento.ResultadoConsultaDB(rResult, False)
  docV[0] = ""
  
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV[0] = "Detalle de la orden:\n"
  Paint.DrawRichText(docV[0], PRINT_MARGIN, 2000 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 9"]
  
  'aqui va el calculo con print true
  sTemporal = fCobrar.sCalculaCosto(iInc, True)
  iInc = sTemporal[2]
  'Paint.Font = Font["Helvetica, Regular, 10"]
  'docV[0] = "Efectivo: $" & txtRecibido.Text & ".00"
  Paint.DrawRichText(sTemporal[0], PRINT_MARGIN, (iInc * 250) + 3700 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  'Paint.Font = Font["Helvetica, Bold, 10"]
  'docV[0] = "Cambio: $" & CFloat(txtRecibido.Text - fTotal) & ".00"
  'Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 2900 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, 'Align.TopNormal)

  Paint.Font = Font["Helvetica, Regular, 7"]
  docV[0] = "Documento sin Efectos Fiscales."
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 4000 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV[0] = "Si requiere factura, solicítela el mismo día de compra."
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 4200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV[0] = "Este establecimiento emite tickets en apego a lo"
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 4400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV[0] = "previsto por las leyes vigentes"
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 4600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
 
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV[0] = "Muchas gracias por su compra"
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 4900 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 7"]
  docV[0] = "Ordena en linea:"
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 5200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV[0] = "www.tacosroy.com"
  Paint.DrawRichText(docV[0], PRINT_MARGIN, (iInc * 250) + 5400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End


Public Sub Form_Open()

  'Abrimos la conexion que será utilizada en el proyecto
  modVariables.c_Conn = modConn.ConectarDB()
  
  gridMainOrden.header = GridView.Horizontal
  gridMainOrden.grid = True
  gridMainOrden.Rows.count = 0
  gridMainOrden.Columns.count = 4
  gridMainOrden.Columns[0].text = "Orden"
  gridMainOrden.Columns[1].text = "Hora"
  gridMainOrden.Columns[2].text = "Mesa"
  gridMainOrden.Columns[3].text = "Status"
  
  gridMainOrden.Columns[0].width = 80
  gridMainOrden.Columns[1].width = 100
  gridMainOrden.Columns[2].width = 80
  gridMainOrden.Columns[3].width = 100

  gridOrdenDetails.header = GridView.Horizontal
  gridOrdenDetails.grid = True
  gridOrdenDetails.Rows.count = 0
  gridOrdenDetails.Columns.count = 6
  gridOrdenDetails.Columns[0].text = "Orden"
  gridOrdenDetails.Columns[1].text = "IDPO"
  gridOrdenDetails.Columns[2].text = "Producto"
  gridOrdenDetails.Columns[3].text = "IDPR"
  gridOrdenDetails.Columns[4].text = "Cantidad"
  gridOrdenDetails.Columns[5].text = "Precio"
  'gridOrdenDetails.Columns[6].text = "TicketNR"
  
  gridOrdenDetails.Columns[0].width = 0
  gridOrdenDetails.Columns[1].width = 0
  gridOrdenDetails.Columns[2].width = 180
  gridOrdenDetails.Columns[3].width = 0
  gridOrdenDetails.Columns[4].width = 40
  gridOrdenDetails.Columns[5].width = 40

  PrinterCuenta.PaperWidth = 80
End

Public Sub btnFindTicket_MouseUp()

Dim rResult As Result

  'SELECT * FROM db_tacosRoy.tbl_ordenes_cerradas;
  
    modVariables._cnnFechaInicio = DtBPickDateStart.Value
    modVariables._cnnFechaFinal = DtBPickDateEnd.Value
    If Mouse.Control Then
      sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_horafecha_cierre_orden) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' order by dt_horafecha_cierre_orden, id_orden_id ASC"
    Else
      sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_horafecha_cierre_orden) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    Endif
    
    Try rsRecords = modVariables.c_Conn.Exec(sQueryString)
    
    If rsRecords <> Null Then
    gridMainOrden.Rows.Count = 0
    
    'SELECT * FROM db_tacosRoy.tbl_precio_tipo_ordenes;
    sQueryString = "SELECT `id_tipo_precio` FROM db_tacosRoy.tbl_precio_tipo_ordenes where `id_orden` = &1;"
    Try rResult = modVariables.c_Conn.Exec(sQueryString, rsRecords["id_orden_id"])
    If rResult <> Null Then modVariables.i_intTipoPrecio = rResult[0]
    
    gridMainOrden.Rows.Count = rsRecords.Count
   
    Label1.Text = "Se han encontrado \n" & rsRecords.Count & " movimientos"
    'GridView1.Refresh
    'btnGeneraUnica.Enabled = True
  Else
    'GridView1.Clear
    gridMainOrden.Rows.Count = 0
    'btnGeneraUnica.Enabled = False
    Label1.Text = "No existen movimientos\npara la fecha seleccionada"
    btnImrpimeCuenta.Enabled = False
  Endif

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End

Public Sub gridMainOrden_Data(Row As Integer, Column As Integer)
  
  If Row >= 0 Then
    rsRecords.moveTo(Row)
    Try gridMainOrden.Data.Text = Str(rsRecords[Column])
    If Error Then Print Error.Text & ", " & Error.Where
  Endif
  If row Mod 2 = 0 Then gridMainOrden.Data.Background = Color.RGB(105, 105, 105)
End

Public Sub gridMainOrden_Click()

  Dim qString As String
  Dim intTempOrder As Integer

  gridOrdenDetails.Rows.Count = 0
  intTempOrder = rsRecords.MoveTo(gridMainOrden.Row)
  modVariables.i_intOrdenID = rsRecords["id_orden_id"]
  'modVariables.i_intTicketNR = hResultOrdenes["TicketNR"]
  modVariables.s_strMesaTemp = rsRecords[2]
  
  'btnCancelOrden.Enabled = True
  'btnModifOrden.Enabled = True
  'btnCerrarOrden.Enabled = True

  qString = "Select * from vw_prods_x_orden where `Orden` = &1 and `Activo` = 1 and `Tipo Precio` = &2 order by `HoraFecha` Asc"  
    Try tmpOrden_prods_precio = modVariables.c_Conn.Exec(qString, rsRecords["id_orden_id"], modVariables.i_intTipoPrecio)
    If Error Then 
      Message.Error(Error.Text & ", " & Error.Where) 
     Else 
      'Message(qString & ", " & hResultOrdenes[0])
      gridOrdenDetails.Rows.Count = tmpOrden_prods_precio.Count
    Endif
  
If gridMainOrden.Row > 0 Then btnImrpimeCuenta.Enabled = True

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End

Public Sub gridOrdenDetails_Data(Row As Integer, Column As Integer)

  Try tmpOrden_prods_precio.moveTo(Row)
  Try gridOrdenDetails.Data.text = Str(tmpOrden_prods_precio[gridOrdenDetails.Columns[column].text])  
  
  If row Mod 2 = 0 Then gridOrdenDetails.Data.Background = Color.RGB(115, 115, 115)
  
  btnImrpimeCuenta.Enabled = True

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End
