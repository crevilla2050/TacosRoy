' Gambas class file

Static Public User As String
Static Public Password As String

Private sQuery As String
Private rResult As Result

Public Sub Run() As Boolean

  lblRealm.Text = "Por favor introduzca sus credenciales"
  Me.Title = "Validación de usuario"
  Return Not Me.ShowModal()
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnOK_Click()

  User = txtUser.Text
  Password = txtPassword.Text
  
  sQuery = "SELECT * FROM `tbl_usuarios` where `chr_login` = '" & User & "' and `chr_password` = sha2(" & Password & ", 256)"
  Try rResult = modVariables.c_Conn.Exec(sQuery)
  
  If (rResult <> Null) And rResult.Available Then
    modVariables.b_UsrAutorizado = True
    modVariables.i_UsuarioConectado = rResult["id_usuario"]
    modVariables.i_UsrLevel = rResult["int_status"]
    
  Else
    Message.Error("Usuario/Contraseña incorrectos")
    modVariables.b_UsrAutorizado = False 
    modVariables.i_UsuarioConectado = -1
    modVariables.i_UsrLevel = -1
    
  Endif
  Me.Close
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnCancel_Click()
  
  modVariables.b_UsrAutorizado = False 
  modVariables.i_UsuarioConectado = -1
  modVariables.i_UsrLevel = -1

  Me.Close(False)
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End


Public Sub Form_Open()

  modVariables.c_Conn = modConn.ConectarDB()
  If (modVariables.c_Conn = Null) Then 
    Message.Error("No se pudo conectar a la base de datos")

  Else 
    txtUser.SetFocus
  Endif
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End
