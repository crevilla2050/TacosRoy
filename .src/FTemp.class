' Gambas class file




Public Sub Form_Open()
  
  modVariables.cnfConfigFile = New Settings(User.Home &/ ".tacosroy/tacosroy.conf")
  modVariables.sPrefijoDB = modVariables.cnfConfigFile["DB/Prefijo"]
  modVariables.sCloudDirectory = modVariables.cnfConfigFile["Application/CloudDirectory"]

  modVariables.c_Conn = modConn.ConectarDB()
  
  End
Private Sub holder()
  
  '      Select Case hResult["ID TPago"]
'        Case 1
'          
'          Else
'            If hResult["Activo"] = 1 Then 
'              flEfectivo += flTemporal 
'            Else 
'              flBorradoV += flTemporal
'            Endif
'            sDetallado &= "x " & iCantidad & "</td><td align=\"right\" " & sDelString & ">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
'          Endif
'        Case 2
'          sDetallado &= "<tr><td colspan=\"2\" " & sDelString & ">" & hResult["Producto"] & "*</td></tr><tr><td align = \"left\" " & sDelString & ">"
'          If hResult["Activo"] = 1 Then 
'            flDescuento += flTemporal 
'          Else 
'            flBorradoV += flTemporal
'          Endif
'          sDetallado &= "x " & iCantidad & "</td><td align=\"right\" " & sDelString & ">(" & hResult["Tipo Pago"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
'        Case 3
'          sDetallado &= "<tr><td colspan=\"2\" " & sDelString & ">" & hResult["Producto"] & "</td></tr><tr><td align = \"left\" " & sDelString & ">"
'          If hResult["Tipo Precio"] = iIndexPersonal Then
'            hResultEmpleado = Null
'            sQuery = "SELECT * FROM `tbl_precios_productos` where `id_producto` = &1 and int_tipo_precio = 1 and bit_activo = 1;"
'            Try hResultEmpleado = modVariables.c_Conn.Exec(sQuery, hResult["ID Prod"])
'            If (hResultEmpleado <> Null) And hResultEmpleado.Available Then 
'              flTemporal = CFloat(hResultEmpleado["dbl_precio"]) * CFloat(hResult["Cantidad"]) 
'              If hResult["Activo"] = 1 Then 
'                flEmpleados += flTemporal
'              Else 
'                flBorradoE += flTemporal
'              Endif
'            Else
'              flEmpleados += 0
'            Endif
'            'sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & flEmpleados & "</td></tr/>" 
'          Else
'            If hResult["Activo"] = 1 Then 
'              flEmpleados += flTemporal
'            Else 
'              flBorradoE += flTemporal
'            Endif
'          Endif
'          sDetallado &= "x " & iCantidad & "</td><td align=\"right\" " & sDelString & ">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
'          hResultEmpleado = Null
'        Case 4
'          sDetallado &= "<tr><td colspan=\"2\" " & sDelString & ">" & hResult["Producto"] & "</td></tr><tr><td align = \"left\" " & sDelString & ">"
'          If hResult["Activo"] = 1 Then 
'            flTarjeta += flTemporal
'          Else 
'            flBorradoV += flTemporal
'          Endif
'          sDetallado &= "x " & iCantidad & "</td><td align=\"right\" " & sDelString & ">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
'      End Select
  
End



Public Sub Button1_Click()

  Dim sQuery As String
  Dim rResult As Result
  Dim rResultTemp As Result
  Dim rResultOper As Result
  Dim iInc As Integer

  sQuery = "SELECT * FROM  tbl_prods_variantes where int_activo = 1 order by id_prods_variantes, id_producto, id_variante;"
  rResult = modVariables.c_Conn.Exec(sQuery)
  
  For Each rResult
      
    sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1;"
    Try rResultTemp = modVariables.c_Conn.Exec(sQuery, rResult["id_prods_variantes"])
    
    If rResultTemp.Available Then
      For iInc As Integer = 1 To 2
        For Each rResultTemp
          rResultOper = Null
            Select Case rResult["id_variante"]
              Case 10
                sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
                rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResult["id_prods_variantes"], iInc)
                modVariables.c_Conn.Begin()
                rResultOper!fl_costo_extra = 5
                rResultOper.Update()
                modVariables.c_Conn.Commit()
              Case 17
                sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
                rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResult["id_prods_variantes"], iInc)
                modVariables.c_Conn.Begin()
                rResultOper!fl_costo_extra = 5
                rResultOper.Update()
                modVariables.c_Conn.Commit()
              Case 19
                sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
                rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResult["id_prods_variantes"], iInc)
                modVariables.c_Conn.Begin()
                rResultOper!fl_costo_extra = 10
                rResultOper.Update()
                modVariables.c_Conn.Commit()
              Default
                Print rResult["id_prods_variantes"] & ", " & rResult[2]
            End Select
          rResultOper = Null
        Next
        'Inc iInc
      Next
    Else
      rResultOper = Null
      For iInc As Integer = 1 To 2
        
        Select Case rResult["id_variante"]
          Case 10
            modVariables.c_Conn.Begin()
            rResultOper = modVariables.c_Conn.Create("tbl_costos_extra_var_prod")
            rResultOper!id_producto_variante = rResult[0]
            rResultOper!id_fecha_control = 18
            rResultOper!fl_costo_extra = 5
            rResultOper!id_tipo_precio = iInc
            rResultOper.Update()
          modVariables.c_Conn.Commit()
          Case 17
            modVariables.c_Conn.Begin()
            rResultOper = modVariables.c_Conn.Create("tbl_costos_extra_var_prod")
            rResultOper!id_producto_variante = rResult[0]
            rResultOper!id_fecha_control = 18
            rResultOper!fl_costo_extra = 5
            rResultOper!id_tipo_precio = iInc
            rResultOper.Update()
          modVariables.c_Conn.Commit()
          Case 19
            modVariables.c_Conn.Begin()
            rResultOper = modVariables.c_Conn.Create("tbl_costos_extra_var_prod")
            rResultOper!id_producto_variante = rResult[0]
            rResultOper!id_fecha_control = 18
            rResultOper!fl_costo_extra = 10
            rResultOper!id_tipo_precio = iInc
            rResultOper.Update()
          modVariables.c_Conn.Commit()
          Default
            Print rResult["id_prods_variantes"] & ", " & rResult[2]
        End Select
          
        'Inc iInc
      Next
    Endif
  Next

End

Public Sub Button2_Click()

Dim sQuery As String
Dim rResultProds, rResultProdVar As Result
Dim rResultOper, rResultTemp As Result
Dim iInc As Integer

  sQuery = "SELECT * FROM `tbl_productos` where `id_categoria` = &1 and `int_activo` = 1 order by `id_categoria`, `id_producto`;"
  rResultProds = modVariables.c_Conn.Exec(sQuery, TextBox1.Text)
  
  For Each rResultProds
    sQuery = "SELECT * FROM `tbl_prods_variantes` where `id_producto` = &1"
    rResultProdVar = modVariables.c_Conn.Exec(sQuery, rResultProds["id_producto"])
    If rResultProdVar.Available Then
      For Each rResultProdVar
        rResultTemp = ""
        
        For iInc As Integer = 1 To 2
          Select Case rResultProdVar["id_variante"]
            Case 10 'Para llevar
              sQuery = " `id_producto_variante` = &1 and `id_tipo_precio` = &2 "
              rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResultProdVar["id_prods_variantes"], iInc)
              modVariables.c_Conn.Begin()
              'rResultOper!id_producto_variante = rResultProdVar[0]
              rResultOper!id_fecha_control = 18
              rResultOper!fl_costo_extra = textBox2.Text
              rResultOper!id_tipo_precio = iInc
              rResultOper.Update()
            modVariables.c_Conn.Commit()
            Case 17 'A domicilio
              sQuery = " `id_producto_variante` = &1 and `id_tipo_precio` = &2 "
              rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResultProdVar["id_prods_variantes"], iInc)
              modVariables.c_Conn.Begin()
              'rResultOper!id_producto_variante = rResultProdVar[0]
              rResultOper!id_fecha_control = 18
              rResultOper!fl_costo_extra = textBox3.Text
              rResultOper!id_tipo_precio = iInc
              rResultOper.Update()
            modVariables.c_Conn.Commit()
            Case 19 'Tortilla de Harina
              sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
              rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResultProdVar["id_prods_variantes"], iInc)
              modVariables.c_Conn.Begin()
              'rResultOper!id_producto_variante = rResultProdVar[0]
              rResultOper!id_fecha_control = 18
              rResultOper!fl_costo_extra = textBox4.Text
              rResultOper!id_tipo_precio = iInc
              rResultOper.Update()
            modVariables.c_Conn.Commit()
            Default
              Print rResultProdVar["id_prods_variantes"] & ", " & rResultProdVar[2]
          End Select
        Next
      Next  
      rResultProdVar = Null
        'sQuery = "SELECT * FROM  tbl_costos_extra_var_prod where `id_producto_variante` = &1;"
        'rResultTemp = modVariables.c_Conn.Exec(sQuery, rResultProdVar["id_producto_variante"])
    Endif
    
    
'    modVariables.c_Conn.Begin()
'      rResultTemp = modVariables.c_Conn.Create("tbl_precios_productos")
'      rResultTemp!id_producto = rResultProdVar["id_producto"]
'      rResultTemp!dbl_precio = 0
'      rResultTemp!int_tipo_precio = 3
'      rResultTemp!bit_activo = 1
'      rResultTemp!dat_fecha_precio_activo = Now()
'      rResultTemp.Update()
'    modVariables.c_Conn.Commit()
  Next
  

End

Public Sub Button3_Click()

  Dim iInc, iNumber As Integer
  Dim rResultOper As Result
  Dim sQuery As String
  
   sQuery = " `id_consecutivo` = &1 "
   'sQuery = " `id_ticketNrConsecutivo` = &1 "
   
   iNumber = 8666
   Inc Application.Busy
    For iInc = 60095 To 60633
      rResultOper = modVariables.c_Conn.Edit("tbl_consecutivo", sQuery, iInc)
        modVariables.c_Conn.Begin()
        rResultOper!chr_consecutivo = iNumber
        rResultOper.Update()
      
      'rResultOper = modVariables.c_Conn.Edit("tbl_ticket_cons", sQuery, iInc)
      '  modVariables.c_Conn.Begin()
      '  rResultOper!chr_ticketConsecutivo = iNumber
      '  rResultOper.Update()
      
      modVariables.c_Conn.Commit()
      Inc iNumber
    Next
    Dec Application.Busy

End

Public Sub Button4_Click()

Dim sQuery As String
Dim hResult As Result
Dim iInc As Integer

  'sQuery = "SELECT * FROM `tbl_ordenes` where DATE(`dt_horafecha_orden`) >= Date(\"2022-07-02 13:00:00\") order by `id_orden_id`"
'Print sQuery

  'Try hResult1 = modVariables.c_Conn.Exec(sQuery)
  Inc Application.Busy
  For iInc = 72587 To 72748
    hResult = Null
    'sQuery = "UPDATE `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_ordenes` SET `id_control_fecha` = '882' WHERE (`id_orden_id` = &1);"
    sQuery = "UPDATE `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_ordenes_cerradas` SET `id_control_fecha` = '882' WHERE (`id_orden_cerrada` = &1);"
    modVariables.c_Conn.Exec(sQuery, iInc)
    'sQuery = "`id_orden_cerrada` = &1"
    'modVariables.c_Conn.Begin()
    '  hResult = modVariables.c_Conn.Edit("tbl_ordenes_cerradas", sQuery, iInc)
    '  hResult!id_control_fecha = 330
    '  hResult.Update()
    'modVariables.c_Conn.Commit()
    'hResult = Null
  Next
  Dec Application.Busy
Catch 
  Dec Application.Busy
  Print Error.Where & " - " & Error.Text
End

Public Sub Button5_Click()

Dim sQuery As String
Dim hResult As Result
Dim sHTML As String

  sQuery = "SELECT * FROM db_tacosroy_trujano.vw_prods_x_orden where Activo = 0 and `Control Fecha` >= 444"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  sHTML = modUtils.exportHTMLFile(hResult)
  
  Dialog.Filter = ["*.xls", "Hoja de Cálculo Excel"]
  
  If Dialog.SaveFile() Then Return
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  File.Save(Dialog.Path, sHTML)

End

Public Sub Button6_Click()
Dim hResult As Result
Dim hResultCerrada As Result
Dim sQuery As String
Dim flTemporal As String[]
Dim iInc As Integer
  'id_orden_id = 63419 
  sQuery = "SELECT * FROM vw_info_ordenes_tickets where id_control_fecha >= 778 and id_control_fecha <= 781 and id_orden_id >= 63419 "
  Try hResultCerrada = modVariables.c_Conn.Exec(sQuery)
  For iInc = 0 To hResultCerrada.Count - 1
    hResultCerrada.MoveTo(iInc)
    flTemporal = FCobrar.sCalculaCosto(hResultCerrada["id_orden_id"])
    modVariables.c_Conn.Begin()
      hResult = modVariables.c_Conn.Create("tbl_ordenes_cerradas")
      hResult!id_orden_id = hResultCerrada["id_orden_id"]
      hResult!dt_horafecha_cierre_orden = DateAdd(hResultCerrada["dt_horafecha_apertura"], gb.Minute, 27)
      If flTemporal[1] = "" Then 
        hResult!fl_total = 0
      Else
        hResult!fl_total = flTemporal[1]
      Endif
      'hResult!fl_total = flTemporal[1]
      hResult!bool_factura = False
      hResult!chr_referencia_notas = hResultCerrada["chr_status_orden"]
      hResult!int_lvl_report = 1
      hResult!id_ticket_IDNr = hResultCerrada["chr_consecutivo"]
      hResult!id_control_fecha = hResultCerrada["id_control_fecha"]
      hResult!int_forma_pago = 1
      hResult.Update()
    modVariables.c_Conn.Commit()
    hResult = Null
    Inc iInc
  Next

End

Public Sub Button7_Click()

Dim myCSVfile As CsvFile
Dim myPath As String
Dim aFields As String[]
Dim myColName As String
Dim myField As Variant
Dim iOrconsToIns As Integer
Dim iOrdersToIns As Integer
Dim iConsecutivo As Integer
Dim sQuery As String
Dim hResult As Result
Dim colRecords As New Collection
Dim iRecords As Integer
Dim iInc As Integer

  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  myCSVfile = New CsvFile(myPath)
  iRecords = 0
  Do Until myCSVfile.Eof
    colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
    Inc iRecords                                    'count the number of records
  Loop
  aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
  sQuery = "Select id_cons from tbl_orcon order by id_orcon desc limit 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  iConsecutivo = hResult[0]
  hResult = Null 
  iInc = 0
  For Each myField In colRecords
    If (myField <> Null) Then
      myColName = aFields[1]
      If myColName = "id orden" Then 
        iOrdersToIns = CInt(myField["ID Orden"])
        Inc iConsecutivo
          sQuery = "INSERT INTO `tbl_orcon` (`id_orden`, `id_cons`) VALUES (&1, &2);"
          modVariables.c_Conn.Exec(sQuery, iOrdersToIns, iConsecutivo)
      Endif
    Endif
  Next 
End
