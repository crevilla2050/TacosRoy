' Gambas class file

Private myCSVfile As CsvFile
Private myPath As String

Private iRecords As Integer
Private colRecords As New Collection
Private aFields As String[]


Public Sub Form_Open()
  
  modVariables.cnfConfigFile = New Settings(User.Home &/ ".tacosroy/tacosroy.conf")
  modVariables.sPrefijoDB = modVariables.cnfConfigFile["DB/Prefijo"]
  modVariables.sCloudDirectory = modVariables.cnfConfigFile["Application/CloudDirectory"]

  modVariables.c_Conn = modConn.ConectarDB()
  
  End



Public Sub Button2_Click()

Dim sQuery As String
Dim rResultProds, rResultProdVar As Result
Dim rResultOper, rResultTemp As Result
Dim iInc As Integer

  sQuery = "SELECT * FROM `tbl_productos` where `id_categoria` = &1 and `int_activo` = 1 order by `id_categoria`, `id_producto`;"
  rResultProds = modVariables.c_Conn.Exec(sQuery, TextBox1.Text)
  
  For Each rResultProds
    sQuery = "SELECT * FROM `tbl_prods_variantes` where `id_producto` = &1"
    rResultProdVar = modVariables.c_Conn.Exec(sQuery, rResultProds["id_producto"])
    If rResultProdVar.Available Then
      For Each rResultProdVar
        rResultTemp = ""
        
        For iInc As Integer = 1 To 2
          Select Case rResultProdVar["id_variante"]
            Case 10 'Para llevar
              sQuery = " `id_producto_variante` = &1 and `id_tipo_precio` = &2 "
              rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResultProdVar["id_prods_variantes"], iInc)
              modVariables.c_Conn.Begin()
              'rResultOper!id_producto_variante = rResultProdVar[0]
              rResultOper!id_fecha_control = 18
              rResultOper!fl_costo_extra = textBox2.Text
              rResultOper!id_tipo_precio = iInc
              rResultOper.Update()
            modVariables.c_Conn.Commit()
            Case 17 'A domicilio
              sQuery = " `id_producto_variante` = &1 and `id_tipo_precio` = &2 "
              rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResultProdVar["id_prods_variantes"], iInc)
              modVariables.c_Conn.Begin()
              'rResultOper!id_producto_variante = rResultProdVar[0]
              rResultOper!id_fecha_control = 18
              rResultOper!fl_costo_extra = textBox3.Text
              rResultOper!id_tipo_precio = iInc
              rResultOper.Update()
            modVariables.c_Conn.Commit()
            Case 19 'Tortilla de Harina
              sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
              rResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, rResultProdVar["id_prods_variantes"], iInc)
              modVariables.c_Conn.Begin()
              'rResultOper!id_producto_variante = rResultProdVar[0]
              rResultOper!id_fecha_control = 18
              rResultOper!fl_costo_extra = textBox4.Text
              rResultOper!id_tipo_precio = iInc
              rResultOper.Update()
            modVariables.c_Conn.Commit()
            Default
              Print rResultProdVar["id_prods_variantes"] & ", " & rResultProdVar[2]
          End Select
        Next
      Next  
      rResultProdVar = Null
        'sQuery = "SELECT * FROM  tbl_costos_extra_var_prod where `id_producto_variante` = &1;"
        'rResultTemp = modVariables.c_Conn.Exec(sQuery, rResultProdVar["id_producto_variante"])
    Endif
  Next

End

Public Sub Button3_Click()
Dim iRecordsCount As Integer 
Dim iMyOrcon, iMyOrder, iMyConst As Integer
Dim bOrconFound, bOrderFound, bConstFound As Boolean
Dim sQuery As String
Dim myField As Variant
Dim myColName As String

  Inc Application.Busy
  myCSVfile = New CsvFile("/home/carlos/Downloads/reporte trujano bancos y facturas 1-7 agosto 2022.csv")
  Do Until myCSVfile.Eof
    colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
    Inc iRecords                                    'count the number of records
  Loop
  aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
  
  For iRecordsCount = 0 To colRecords.Count + 1
    For Each myField In colRecords
      If (myField <> Null) Then
        For Each myColName In aFields
          Select Case myColName
            Case "orcon"
              iMyOrcon = CInt(myField["orcon"])
              bOrconFound = True
            Case "id orden"
              iMyOrder = CInt(myField["id orden"])
              bOrderFound = True
            Case "id cons"
              iMyConst = CInt(myField["id cons"])
              bConstFound = True
            Default 
          End Select
          If bOrconFound And bOrderFound And bConstFound Then 
            sQuery = "INSERT INTO `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_orcon` (`id_orcon`, `id_orden`, `id_cons`) VALUES (&1, &2, &3);"
            Try modVariables.c_Conn.Exec(sQuery, iMyOrcon, iMyOrder, iMyConst)
          Endif
        Next 
      Endif
    Next
  Next 
  Dec Application.Busy
End

Public Sub Button4_Click()

Dim sQuery As String
Dim hResult As Result
Dim iInc, iJnc As Integer

  sQuery = "select tbl_orcon.id_orcon,  "
  sQuery &= " `tbl_orcon`.`id_orden` as `ID Orden`,  "
  sQuery &= " `tbl_orcon`.`id_cons` as `ID Cons`,   "
  sQuery &= " `tbl_ordenes_cerradas`.`id_orden_cerrada` as `ID ORC`,  "
  sQuery &= " `tbl_ordenes_cerradas`.`dt_horafecha_cierre_orden`,  "
  sQuery &= " `tbl_ordenes_cerradas`.`fl_total` as `Total`, "
  sQuery &= " `tbl_ordenes_cerradas`.`id_ticket_IDNr`,  "
  sQuery &= " `tbl_ordenes_cerradas`.`id_control_fecha`,    "
  sQuery &= " `tbl_ordenes`.`int_nr_comanda` as `Comanda`,  "
  sQuery &= " `tbl_ordenes_cerradas`.`int_forma_pago` as `ID Pago`   "
  sQuery &= " From tbl_orcon  "
  sQuery &= " left join tbl_ordenes_cerradas On tbl_orcon.id_orden = tbl_ordenes_cerradas.id_orden_cerrada "
  sQuery &= " left join `tbl_ordenes` on `tbl_ordenes`.`id_orden_id` = `tbl_ordenes_cerradas`.`id_orden_id`"
  sQuery &= " left join `tbl_consecutivo` on `tbl_orcon`.`id_cons` = `tbl_consecutivo`.`id_consecutivo`"
  sQuery &= " where `tbl_ordenes_cerradas`.`id_control_fecha` >= 1133 "
  sQuery &= " And `tbl_ordenes_cerradas`.`id_control_fecha` <= 1189  "
  sQuery &= " order by tbl_orcon.id_orden asc "
'Print sQuery

  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  Inc Application.Busy
  iJnc = 1
  For Each hResult
    sQuery = "UPDATE `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_orcon` SET `tbl_orcon`.`id_cons` = &1 WHERE (`id_orden` = &2);"
    modVariables.c_Conn.Exec(sQuery, iJnc, hResult["ID Orden"])
    Inc iJnc
  Next   

  'For iInc = 41600 To 9587
    
    'sQuery = "UPDATE `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_ordenes` SET `id_control_fecha` = '487' WHERE (`id_orden_id` = &1);"
  
    'sQuery = "`id_orden_cerrada` = &1"
    'modVariables.c_Conn.Begin()
    '  hResult = modVariables.c_Conn.Edit("tbl_ordenes_cerradas", sQuery, iInc)
    '  hResult!id_control_fecha = 330
    '  hResult.Update()
    'modVariables.c_Conn.Commit()
    'hResult = Null
  'Next
  Dec Application.Busy
Catch 
  Dec Application.Busy
  Print Error.Where & " - " & Error.Text
End

Public Sub Button5_Click()

Dim sQuery As String
Dim hResult As Result
Dim sHTML As String

  sQuery = "SELECT * FROM db_tacosroy_trujano.vw_prods_x_orden where Activo = 0 and `Control Fecha` >= 444"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  sHTML = modUtils.exportHTMLFile(hResult)
  
  Dialog.Filter = ["*.xls", "Hoja de CÃ¡lculo Excel"]
  
  If Dialog.SaveFile() Then Return
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  File.Save(Dialog.Path, sHTML)

End

Public Sub Button6_Click()
Dim hResult As Result
Dim hResultCerrada As Result
Dim sQuery As String
Dim flTemporal As String[]
Dim iInc As Integer
  'id_orden_id = 63419 
  sQuery = "SELECT * FROM vw_info_ordenes_tickets where id_control_fecha >= 778 and id_control_fecha <= 781 and id_orden_id >= 63419 "
  Try hResultCerrada = modVariables.c_Conn.Exec(sQuery)
  For iInc = 0 To hResultCerrada.Count - 1
    hResultCerrada.MoveTo(iInc)
    flTemporal = FCobrar.sCalculaCosto(hResultCerrada["id_orden_id"])
    modVariables.c_Conn.Begin()
      hResult = modVariables.c_Conn.Create("tbl_ordenes_cerradas")
      hResult!id_orden_id = hResultCerrada["id_orden_id"]
      hResult!dt_horafecha_cierre_orden = DateAdd(hResultCerrada["dt_horafecha_apertura"], gb.Minute, 27)
      If flTemporal[1] = "" Then 
        hResult!fl_total = 0
      Else
        hResult!fl_total = flTemporal[1]
      Endif
      'hResult!fl_total = flTemporal[1]
      hResult!bool_factura = False
      hResult!chr_referencia_notas = hResultCerrada["chr_status_orden"]
      hResult!int_lvl_report = 1
      hResult!id_ticket_IDNr = hResultCerrada["chr_consecutivo"]
      hResult!id_control_fecha = hResultCerrada["id_control_fecha"]
      hResult!int_forma_pago = 1
      hResult.Update()
    modVariables.c_Conn.Commit()
    hResult = Null
    Inc iInc
  Next

End

Public Sub Button7_Click()

Dim myCSVfile As CsvFile
Dim myPath As String
Dim aFields As String[]
Dim myColName As String
Dim myField As Variant
Dim iOrconsToIns As Integer
Dim iOrdersToIns As Integer
Dim iConsecutivo As Integer
Dim sQuery As String
Dim hResult As Result
Dim colRecords As New Collection
Dim iRecords As Integer
Dim iInc As Integer

  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  myCSVfile = New CsvFile(myPath)
  iRecords = 0
  Do Until myCSVfile.Eof
    colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
    Inc iRecords                                    'count the number of records
  Loop
  aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
  sQuery = "Select id_cons from tbl_orcon order by id_orcon desc limit 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  iConsecutivo = hResult[0]
  hResult = Null 
  iInc = 0
  For Each myField In colRecords
    If (myField <> Null) Then
      myColName = aFields[1]
      If myColName = "id orden" Then 
        iOrdersToIns = CInt(myField["ID Orden"])
        Inc iConsecutivo
          sQuery = "INSERT INTO `tbl_orcon` (`id_orden`, `id_cons`) VALUES (&1, &2);"
          modVariables.c_Conn.Exec(sQuery, iOrdersToIns, iConsecutivo)
      Endif
    Endif
  Next 
End

Public Sub Button8_Click()

Dim myPath As String
Dim hFile As File
Dim linea As String
  
  listaComandasTarjeta.Clear
  
  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  If myPath <> "" Then 
  hFile = Open myPath For Read
    While Not Eof(hFile)
      Line Input #hfile, linea
      listaComandasTarjeta.Add(linea)
    Wend
    Close #hFile
  Endif 

End

Public Sub Button1_Click()

Dim sQuery As String
Dim rsRecords As Result
Dim iJnc, iLnc As Integer
Dim sComandaTemp, sTotalTemp, sMyCharTemp As String

  Inc Application.Busy
  sQuery = "SELECT "
  sQuery &= "  `tbl_ordenes_cerradas`.`id_orden_cerrada` as `ID Orden`,"
  sQuery &= "  `tbl_ordenes`.`dt_horafecha_orden`,"
  sQuery &= "  `tbl_ordenes`.`int_nr_comanda` as `Comanda`,"
  sQuery &= "  `tbl_facturas`.`chr_nr_factura` as `Folio`,"
  sQuery &= "  `tbl_ordenes_cerradas`.`fl_total` as `Total`,"
  sQuery &= "  `tbl_ordenes_cerradas`.`int_forma_pago`"
  sQuery &= "  From `tbl_ordenes_cerradas` "
  sQuery &= "  left join `tbl_ordenes` on `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_ordenes`.`id_orden_id`"
  sQuery &= "  left join `tbl_facturas` on `tbl_facturas`.`id_orden` = `tbl_ordenes_cerradas`.`id_orden_cerrada` "
  sQuery &= "  where `tbl_ordenes`.`id_control_fecha` >= 399 and `tbl_ordenes`.`id_control_fecha` <= 404;"
  'Print sQuery
  Try rsRecords = modVariables.c_Conn.Exec(sQuery)
  
  If (rsRecords <> Null) Then
    For Each rsRecords
      iJnc = 0
      For Each listaComandasTarjeta.List
        sComandaTemp = Left(CStr(listaComandasTarjeta.List[iJnc]), 5)
        If CStr(rsRecords["Comanda"]) = sComandaTemp Then
          sQuery = "UPDATE `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_ordenes_cerradas` SET `int_forma_pago` = 4 WHERE (`id_orden_cerrada` = &1);" 
          Try modVariables.c_Conn.Exec(sQuery, rsRecords["ID Orden"])
          Print "sTotalTemp: " & sTotalTemp & " - IDOrden: " & rsRecords["ID Orden"]
          iLnc = 0
          For iLnc = Len(listaComandasTarjeta.List[iJnc]) To 1 Step -1
            sMyCharTemp = Mid(listaComandasTarjeta.List[iJnc], iLnc, 1)
            If sMyCharTemp = "," Then
              sTotalTemp = Mid(CStr(listaComandasTarjeta.List[iJnc]), iLnc + 1, (Len(listaComandasTarjeta.List[iJnc]) - iLnc))
              sQuery = "UPDATE `db_tacosroy_" & modVariables.sPrefijoDB & "`.`tbl_ordenes_cerradas` SET `fl_total` = &1 WHERE (`id_orden_cerrada` = &2);" 
              Try modVariables.c_Conn.Exec(sQuery, CFloat(sTotalTemp), rsRecords["ID Orden"])
              Break 
            Endif
          Next
        Endif   
        Inc iJnc
      Next
    Next
  Endif
  Dec Application.Busy

Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)

End
