' Gambas class file

Public myCSVfile As CsvFile
Public myPath As String

Private iRecords As Integer
Private colRecords As New Collection
Private aFields As String[]
Private iFoliosFacturas As Integer[]
Private fMyFacturas As New Float[]
Private iLastIndex As Integer

'Public Struct ListaFacturas
'  flTotal As Float
'  dtFecha As Date
'  bFoundInRS As Boolean
'End Struct


Public Sub btnPickVolunteer_Click()
Dim iInt As Integer

  myCSVfile = New CsvFile(myPath)
  Do Until myCSVfile.Eof
    colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
    Inc iRecords                                    'count the number of records
  Loop
  aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
  
  gridFacturas.Rows.Count = 0
  gridFacturas.Columns.Count = 0
  
  gridFacturas.Header = GridView.Horizontal
  gridFacturas.Grid = True
  gridFacturas.Columns.Count = aFields.Count
  
  For iInt = 0 To aFields.Count - 1
    gridFacturas.Columns[iInt].Text = myCSVfile.Fields[iInt]
    If myCSVfile.Fields[iInt] = "total" Or myCSVfile.Fields[iInt] = "fecha" Or myCSVfile.Fields[iInt] = "rfc" Then 
      gridFacturas.Columns[iInt].Width = 0
    Endif
  Next
   iLastIndex = 0
  'display some data from the CSV file
  If colRecords.Count > 0 Then 
    gridFacturas.Rows.Count = colRecords.Count 
    btnInject.Enabled = True
    Me.Text = "Buscar facturas: " & "Columnas: " & aFields.Count & ", Facturas encontradas: " & colRecords.Count 
  Else 
    gridFacturas.Rows.Count = 0
    btnInject.Enabled = False
  Endif 
  Dec Application.Busy
'  Me.Close

Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)
    
End

Public Sub btnPickFile_Click()

  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  If myPath <> "" Then 
    btnPickVolunteer.Enabled = True
  Else 
    btnPickVolunteer.Enabled = False
  Endif
Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)
End

Public Sub gridFacturas_Data(Row As Integer, Column As Integer)

  If Row Mod 2 = 0 Then gridFacturas.Data.Background = Color.RGB(115, 115, 115)

  If (colRecords[Row + 2] <> Null) Then 
    gridFacturas.Data.text = colRecords[Row + 2][CStr(aFields[Column])]
  Endif

Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)

End

Public Sub btnInject_Click()

Dim myColName As String
Dim myField As Variant
Dim myValue As Variant
Dim iInt, iJnc, iRecordsCount As Integer
Dim iSelFacturas As Integer
Dim myDate As Date
Dim myfTotal As Float
Dim sDay, sMonth, sYear As Integer
Dim bDateFound, bTotalFound, bFound, bAdded As Boolean
Dim sQuery As String


bfound = False
iLastIndex = 0
bTotalFound = False
bDateFound = False
bAdded = False
iInt = 0
iSelFacturas = 0
FTickets.iSelected.Clear

Inc Application.Busy
  
  'If (colRecords[Row + 2] <> Null) Then 
  '  gridFacturas.Data.text = colRecords[Row + 2][CStr(aFields[Column])]
  'Endif
    
  For iRecordsCount = 0 To colRecords.Count
    Print iRecordsCount
    lblStatus.Text = ""
    lblStatus.Text = "Registro: " & iRecordsCount & ", iInt: " & iInt
    lblStatus.Refresh
    For Each myField In colRecords
      If (myField <> Null) Then
        For Each myColName In aFields
          Select Case myColName
            Case "total", "total mxn"
              If (myField["total"] <> Null) Then 
                myfTotal = CFloat(myField["total"])
                bTotalFound = True
              Else 
                myfTotal = 0
                bTotalFound = False
              Endif 
            Case "fecha"
              'Hay que corregir la fecha, pues el sistema me da un dia de menos
              If (myField["fecha"] <> Null) Then 
                myValue = myField["fecha"]
                sDay = CInt(Left(myValue, 2))
                sMonth = CInt(Mid(myValue, 4, 2))
                sYear = CInt(Right(myValue, 4))
                myDate = CDate("01/01/1980 00:00:00")
                myDate = DateAdd(myDate, gb.Year, sYear - 1980)
                myDate = DateAdd(myDate, gb.Month, sMonth - 1)
                myDate = DateAdd(myDate, gb.Day, sDay)
                myDate = DateAdd(myDate, gb.Hour, -18)
                'myDate = DateAdd(myDate, gb.Minute, -59)
                bDateFound = True
              Else 
                myDate = CDate("01/01/1980 00:00:00")
                bDateFound = False
              Endif
            Default 
          End Select
          If bTotalFound And bDateFound Then 
            bFound = False
            FTickets.rsRecords.MoveFirst
            For Each FTickets.rsRecords 'read total and date from records, one at the time
              bAdded = False 
              iLastIndex = FTickets.rsRecords.Index
              'FTickets.rsRecords.MoveTo(iLastIndex)
              If (CFloat(myfTotal) = CFloat(FTickets.rsRecords["Total"])) Then
                If Year(myDate) >= Year(CDate(FTickets.rsRecords["Fecha Hora"])) And Month(myDate) >= Month(CDate(FTickets.rsRecords["Fecha Hora"])) And Day(myDate) >= Day(CDate(FTickets.rsRecords["Fecha Hora"])) Then
                  'iLastIndex = FTickets.rsRecords.Index
                  For iInt = 0 To FTickets.iSelected.Count - 1
                    If FTickets.iSelected[iInt] = iLastIndex Then bAdded = True
                  Next
                  If Not bAdded Then 
                    Print "myfTotal: " & CStr(myfTotal)
                    Print "CFloat(FTickets.rsRecords[\"Total\"]: " & CStr(FTickets.rsRecords["Total"])
                    FTickets.iSelected.Add(iLastIndex)
                    bFound = True 'reset bfound
                    bTotalFound = False 
                    bDateFound = False
                    bAdded = False
                    Dec Application.Busy
                  Endif 
                Endif
              Endif
              'Inc iLastIndex
              'If iLastIndex >= FTickets.rsRecords.Count Then iLastIndex -= FTickets.rsRecords.Count
              If bFound Or iInt >= colRecords.Count Then Break
            Next 
            If iInt >= colRecords.Count Then Break 
          Endif 
          If iInt >= colRecords.Count Then Break 
        Next 
        If iInt >= colRecords.Count Then Break 
      Endif
      If iInt >= colRecords.Count Then Break 
    Next
    If iInt >= colRecords.Count Then Break 
  Next 

  modUtils.escogeComandas()
  
Dec Application.Busy
Me.Close

Catch 
  Dec Application.Busy
  Print Error.Text
  Message.Error(Error.Where & ", " & Error.Text)
End



