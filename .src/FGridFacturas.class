' Gambas class file

Public myCSVfile As CsvFile
Public myPath As String

Private iRecords As Integer
Private colRecords As New Collection
Private aFields As String[]

Private iLastIndex As Integer

Public Sub btnPickVolunteer_Click()
Dim iInt As Integer

  myCSVfile = New CsvFile(myPath)
  Do Until myCSVfile.Eof
    colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
    Inc iRecords                                    'count the number of records
  Loop
  aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
  
  gridFacturas.Rows.Count = 0
  gridFacturas.Columns.Count = 0
  
  gridFacturas.Header = GridView.Horizontal
  gridFacturas.Grid = True
  gridFacturas.Columns.Count = aFields.Count
  
  For iInt = 0 To aFields.Count - 1
    gridFacturas.Columns[iInt].Text = myCSVfile.Fields[iInt]
  Next
   iLastIndex = 0
  'display some data from the CSV file
  If colRecords.Count > 0 Then 
    gridFacturas.Rows.Count = colRecords.Count 
    btnInject.Enabled = True
    Me.Text = "Buscar tickets: " & "Columnas: " & aFields.Count & ", Records encontrados: " & colRecords.Count 
  Else 
    gridFacturas.Rows.Count = 0
    btnInject.Enabled = False
  Endif 
  Dec Application.Busy
'  Me.Close

Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)
    
End

Public Sub doInjectFacturas()

  Dim myColName As String
  Dim myField As Collection
  Dim iInt As Integer
  Dim iRecordsCount As Integer
  Dim myComanda As Integer
  Dim bComandaFound, bFound, bAdded As Boolean
  Dim iLastIndex As Integer

  bFound = False
  iLastIndex = 0
  bAdded = False
  bComandaFound = False
  iInt = 0

  Print "Starting doInjectFacturas..."

  For iRecordsCount = 0 To colRecords.Count - 1
    Print "Processing record index: " & iRecordsCount
    lblStatus.Text = "Registro: " & iRecordsCount & ", iInt: " & iInt
    lblStatus.Refresh

    myField = colRecords[iRecordsCount]

    If myField <> Null Then
      bComandaFound = False
      For Each myColName In aFields
        Select Case LCase(myColName)
          Case "comanda"
            If myField.Exist("comanda") Then
              myComanda = CInt(myField["comanda"])
              bComandaFound = True
              Print "Found comanda: " & myComanda
            Endif
          Case Else
            ' Ignore other columns
        End Select

        If bComandaFound Then
          Print "Searching matches for comanda: " & myComanda
          FCargador.rsRecords.MoveFirst

          bFound = False
          For Each FCargador.rsRecords
            bAdded = False
            iLastIndex = FCargador.rsRecords.Index

            ' Check if index already added
            For iInt = 0 To FCargador.iSelected.Count - 1
              If FCargador.iSelected[iInt] = iLastIndex Then
                bAdded = True
                Break
              Endif
            Next

            If Not bAdded Then
              If CInt(FCargador.rsRecords["Comanda"]) = myComanda Then
                FCargador.iSelected.Add(iLastIndex)
                bFound = True
                Print "Added index: " & iLastIndex & " for comanda: " & myComanda
                Break
              Endif
            Endif
            If bFound Then Break
          Next

          bComandaFound = False
          bFound = False
          Break  ' Exit fields loop since comanda found and processed
        Endif
      Next
    Else
      Print "Warning: Null record at index " & iRecordsCount
    Endif
  Next

  Print "doInjectFacturas completed. Total selected: " & FCargador.iSelected.Count

End


Public Sub btnPickFile_Click()

  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  If myPath <> "" Then 
    btnPickVolunteer.Enabled = True
  Else 
    btnPickVolunteer.Enabled = False
  Endif
Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)
End

Public Sub btnInject_Click()

Inc Application.Busy

  doInjectFacturas()
  
Dec Application.Busy
Me.Close

Catch 
  Dec Application.Busy
  Print Error.Text
  Message.Error(Error.Where & ", " & Error.Text)
End

Public Sub gridFacturas_Data(Row As Integer, Column As Integer)

  If Row Mod 2 = 0 Then gridFacturas.Data.Background = Color.RGB(115, 115, 115)

  If (colRecords[Row + 2] <> Null) Then 
    gridFacturas.Data.text = colRecords[Row + 2][CStr(aFields[Column])]
  Endif

Catch 
  Print Error.Text
  Dec Application.Busy
  Message.Error(Error.Where & ", " & Error.Text)

End
