' Gambas module file

'Private c_Conn As Connection
'Private $rData As Result
Public $dNow As Date

Public Function checaEstadoTurno(Optional dDate As Date) As Integer

Dim qString As String
Dim hResult, hResultIns As Result

If dDate = Null Then dDate = Now

  qString = "SELECT * FROM `tbl_control_fechas` ORDER BY `dt_fecha_calendario` DESC limit 1;"
  'qString = "SELECT * FROM `tbl_control_fechas` where DATE(`dt_fecha_calendario`) = Date(Now()) ORDER BY `dt_fecha_calendario` DESC limit 1;"
  'qString = "SELECT * FROM `tbl_control_fechas` where `dt_fecha_calendario` = CURRENT_DATE();"
  Print qString
  Try hResult = modVariables.c_Conn.Exec(qString)
  If (hResult <> Null) And hResult.Available Then
    If hResult["dt_finaliza_labores"] = Null Then
      Dim dtLapso As Integer
      dtLapso = DateDiff(hResult["dt_comienzo_labores"], Now, gb.Hour)
      If dtLapso > 14 Then
        Message.Info("Han pasado más de 14 hrs. desde el último turno abierto\nEl programa se cerrará ahora.\nFavor de REINICIAR APP y abrir una cuenta nueva.") 
        qString = "UPDATE `tbl_control_fechas` SET `dt_finaliza_labores` = Now() WHERE (`id_control_fechas` = &1);"
        Try modVariables.c_Conn.Exec(qString, hResult["id_control_fechas"])
        'Creamos un respaldo de la base de datos
        modUtils.doSQLDump() 
        Return 0
      Else  
        If (Message.Question("La cuenta del dia: " & hResult["dt_comienzo_labores"] & " aun sigue abierta, desea cerrarla o continuar?", "Cerrar Cuenta", "Continuar")) = 1 Then
          qString = "UPDATE `tbl_control_fechas` SET `dt_finaliza_labores` = Now() WHERE (`id_control_fechas` = &1);"
          Try modVariables.c_Conn.Exec(qString, hResult["id_control_fechas"])
          'Creamos un respaldo de la base de datos
          modUtils.doSQLDump() 
          FMain1.btnNuevaOrden.Enabled = False
          FMain1.btnModifOrden.Enabled = False
          FMain1.btnCancelOrden.Enabled = False
          FMain1.btnCerrarOrden.Enabled = False
          FMain1.btnImrpimeCuenta.Enabled = False
          Return 0
        Else 
          Return hResult["id_control_fechas"]
        Endif
      Endif
      modVariables.i_idControlFecha = hResult["id_control_fechas"]
      modVariables.s_controlString = hResult["chr_control"]
      FMain1.btnNuevaOrden.Enabled = False
      FMain1.btnModifOrden.Enabled = False
      FMain1.btnCancelOrden.Enabled = False
      FMain1.btnCerrarOrden.Enabled = False
      FMain1.btnImrpimeCuenta.Enabled = False
    Else
      If Message.Question("El turno ha sido cerrado, desea abrir un turno nuevo?", "Si abrir", "Cancelar") = 1 Then
        
        FAuth.ShowModal
        If modVariables.i_UsuarioConectado <= 0 Then 
          Me.Close
          Return
        Else
          Inc Application.Busy
          'Creamos un respaldo de la base de datos
          modUtils.doSQLDump()
          Dec Application.Busy
        Endif
      
        hResultIns = Null
        modVariables.c_Conn.Begin()
        hResultIns = modVariables.c_Conn.Create("tbl_control_fechas")
        hResultIns!dt_fecha_calendario = Now()
        hResultIns!dt_comienzo_labores = Now()
        hResultIns.Update()
        modVariables.c_Conn.Commit()
        hResultIns = Null
        modVariables._cnnFechaInicio = Now()
        modVariables.iCurrControlFecha = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
        Return modVariables.iCurrControlFecha
      Else
        FMain1.btnModifOrden.Enabled = False
        FMain1.btnCancelOrden.Enabled = False
        FMain1.btnCerrarOrden.Enabled = False
        FMain1.btnImrpimeCuenta.Enabled = False
        FMain1.btnNuevaOrden.Enabled = False
        Return
      Endif
      
    Endif
   
  Else
    FMain1.btnModifOrden.Enabled = False
    FMain1.btnCancelOrden.Enabled = False
    FMain1.btnCerrarOrden.Enabled = False
    FMain1.btnImrpimeCuenta.Enabled = False
    FMain1.btnNuevaOrden.Enabled = False
    Message.Info("Debe abrir la cuenta del dia de hoy primero")
    Return
  Endif   
  
  
End


Public Sub CreateDirTree(sDir As String)

Dim s As String
Dim stmpDir As String = "/"
  
  If sdir Begins "/" Then sdir = Right(sdir, -1)
  
  For Each s In Split(sDir, "/")
    stmpDir &= s & "/"
    If Exist(stmpdir) Then Continue
    Mkdir stmpdir
  Next

 Catch
 Print "The directory " & stmpdir & "can't be created"

 End
 
Public Function findPrice(iIDProducto As Integer, iTipoPrecio As Integer, iControlFechaStart As Integer, Optional iControlFechaEnd As Integer) As Float

Dim sQuery As String
Dim hResultPrecio As Result
Dim flMyPrice As Float

  sQuery = "select"
  sQuery &= " ANY_VALUE( `tbl_control_fechas`.`id_control_fechas`) AS `IDCF`,"
  sQuery &= " ANY_VALUE( `tbl_productos`.`id_producto` ) as `ID Prod`,"
  sQuery &= " ANY_VALUE( `tbl_productos`.`chr_nombre_prod` ) as `Producto`,"
  sQuery &= " ANY_VALUE( `tbl_precios_productos`.`dbl_precio` ) as `Precio`,"
  sQuery &= " ANY_VALUE( `tbl_precios_productos`.`dat_fecha_precio_activo` ) as `Fecha Precio`,"
  sQuery &= " ANY_VALUE( `tbl_precios_productos`.`int_tipo_precio` ) as `Tipo Precio`,"
  sQuery &= " ANY_VALUE( `tbl_precios_productos`.`bit_activo` ) as `Activo`"
  sQuery &= " From `tbl_precios_productos` "
  sQuery &= " left join `tbl_productos` on `tbl_productos`.`id_producto` = `tbl_precios_productos`.`id_producto`"
  sQuery &= " left join `tbl_control_fechas` on DATE(`tbl_control_fechas`.`dt_fecha_calendario`) = DATE(`tbl_precios_productos`.`dat_fecha_precio_activo`)"
  sQuery &= " where "
  sQuery &= "  `tbl_productos`.`id_producto` = &1 "
  sQuery &= " group by `tbl_precios_productos`.`dat_fecha_precio_activo`"
  sQuery &= " order by `tbl_precios_productos`.`dat_fecha_precio_activo` Asc "
  
  flMyPrice = -1
  hResultPrecio = Null
  Try hResultPrecio = modVariables.c_Conn.Exec(sQuery, iIDProducto)
  
  If (hResultPrecio <> Null) And hResultPrecio.Available Then 
    For Each hResultPrecio
      If (hResultPrecio["IDCF"] <> Null) Then 
        If (hResultPrecio["IDCF"] >= iControlFechaStart) And (hResultPrecio["IDCF"] <= iControlFechaEnd And iTipoPrecio = hResultPrecio["Tipo Precio"]) Then 
          flMyPrice = hResultPrecio["Precio"]
        Endif
      Endif
    Next
    If flMyPrice = -1 Then 
      hResultPrecio.MoveFirst
      For Each hResultPrecio
        If (hResultPrecio["Activo"] = 1 And iTipoPrecio = hResultPrecio["Tipo Precio"]) Then 
        flMyPrice = hResultPrecio["Precio"]
      Endif
      Next
    Endif
  Else 
    Return -1
  Endif
   
  hResultPrecio = Null
  
  Return flMyPrice
  
Catch 
  Print Error.Text
  'Message.Error(Error.Text)
  
End


Public Function ifNull(vToTest As Variant, vToSet As Variant) As Variant
  
  If (vToTest = Null) Then 
    Return vToSet 
  Else 
    Return vToTest
  Endif
  
End


Public Sub doSQLDump()
Dim sFilePath, fileName, tempFile As String

 
  sFilePath = User.Home &/ "Dropbox/2020/TRdumps" &/ modVariables.sPrefijoDB
  fileName = "mysqldb_" & modVariables.sPrefijoDB & "_" & CStr(Format(Now, "yyyy-mm-dd_hh-nn-ss")) 
  tempFile = "mysqldump -u root -pt4a2x0a6 db_tacosroy_" & modVariables.sPrefijoDB & " tbl_consecutivo tbl_control_fechas tbl_gastos tbl_inventario tbl_ordenes tbl_ordenes_cerradas tbl_ordenes_descuento tbl_ordenes_personal tbl_precio_tipo_ordenes tbl_prods_orden_opciones tbl_prods_x_orden tbl_ticket_cons > " & sFilePath &/ fileName & ".sql"
  Print tempFile
  Inc Application.Busy
  Shell tempFile Wait
  Dec Application.Busy
  tempFile = "7za a -tzip -pt4a2x0a6 -mem=AES256 " & sFilePath &/ fileName & ".gz " & sFilePath &/ fileName & ".sql"
  Inc Application.Busy
  Shell tempFile Wait
  Dec Application.Busy
  If Not Error Then modVariables.cnfDBUpdates["Backups/backup_" & modVariables.sPrefijoDB] = "False"
  
  Try Kill sFilePath &/ fileName & ".sql"
  
  
  
Catch 
  Print (Error.Text & ", " & Error.Where)
  Message.Error(Error.Text & ", " & Error.Where)
  
End


Public Function exportHTMLFile(hResult As Result, Optional wBody As Boolean) As String
Dim tempHTML As String
Dim iInt, iJnt As Integer  
  If Not wBody Then 
    tempHTML = "<body>"
    tempHTML &= "<table cellspacing=\"0\" border=\"0\">" 
  Endif 
  
  tempHTML &= "<tr>" 
  For iInt = 0 To hResult.Fields.count - 1
    tempHTML &= "<td>" & hResult.Fields[iInt].Name & "</td>"
  Next
  tempHTML &= "</tr>" 
  hResult.MoveFirst
  For iJnt = 0 To hResult.Count - 1
    tempHTML &= "<tr>" 
    For iInt = 0 To hResult.Fields.count - 1
      tempHTML &= "<td>" & hResult[hResult.Fields[iInt].Name] & "</td>"
    Next 
    tempHTML &= "</tr>"
    hResult.MoveNext
  Next
  
  If Not wBody Then 
    tempHTML &= "</table>"
    tempHTML &= "</body>"
  Endif 

  Return tempHTML
End

Public Function insertaVariantePlatillo(idProdOrden As Integer, idPlatillo As Integer) As Boolean

Dim sQueryString As String
  
  sQueryString = "INSERT INTO `tbl_prods_orden_opciones` (`id_prod_x_orden`, `id_variante_platillo`) VALUES (&1, &2)" 
  Try modVariables.c_Conn.Exec(sQueryString, idProdOrden, idPlatillo)
   
  If Error Then 
    Message.Error(Error.Text & ", " & Error.Where)
  Else
    Return True
  Endif
  
Catch
  Message.Error(Error.Text & ", " & Error.Where)
  Return False
End


Public Function convierteFechaFormato(laFecha As Date) As String
 
  Return Year(laFecha) & "-" & Month(laFecha) & "-" & Day(laFecha)
  
End

Public Function convierteFechaFormatoHora(laFecha As Date) As String
Dim sTemp As String
  
  sTemp = Second(laFecha)
  If Len(sTemp) = 1 Then sTemp = "0" & sTemp
  Return Year(laFecha) & "-" & Month(laFecha) & "-" & Day(laFecha) & "_" & Hour(laFecha) & ":" & Minute(laFecha) & ":" & sTemp
  
End

Public Sub TimerClk_Timer() As String

  'Dim sTime As String
  
  'If Second(Now) = $i_iLast Then Return
  $dNow = Now
  modVariables.sTime = Format($dNow, "dddd dd mmmm yyyy, hh:nn:ss")
  Return CStr(modVariables.sTime)

End

Public Sub EnableDisableControls(cContainer As Container, tTag As String, bNewState As Boolean)
  
  Dim myControl As Control
  
  cContainer.Enabled = True
    For Each myControl In cContainer.Children
      If Object.GetProperty(myControl, "Tag") = tTag Then 
        'Print Object.GetProperty(myControl, "Name") & ": ON"
        Object.SetProperty(myControl, "Enabled", bNewState)
        'Print Object.GetProperty(myControl, bNewState)
      Endif
    Next
  
End

Public Sub CleanFormControls(cContainer As Container, tTag As String)
  
  Dim myControl As Control
  
  cContainer.Enabled = True
    For Each myControl In cContainer.Children
      If Object.GetProperty(myControl, "Tag") = tTag Then 
        'Print Object.GetProperty(myControl, "Name") & ": ON"
        If (Object.Is(Mycontrol, "DataControl")) Then 
          Try Object.SetProperty(myControl, "Value", "")
        Endif
        
        If (Object.Is(MyControl, "TextBox")) Then 
          Try Object.SetProperty(myControl, "Text", "")
        Endif
        
        If Error Then Print Error.Text
        'Print Object.GetProperty(myControl, bNewState)
      Endif
    Next
  
End

Public Sub ReadData(tbvData As Object, $rData As Result)

  Dim hField As ResultField
  Dim iInd As Integer
  'Dim iTemp As Integer

  Inc Application.Busy

  'tbvData.Rows.Count = 0

  tbvData.Columns.Count = $rData.Fields.Count

  For Each hField In $rData.Fields

    With hField

      Print .Name; ": "; .Type; " "; .Length; " "; .Result[0]

      tbvData.Columns[iInd].Text = .Name
      tbvData.Columns[iInd].Width = WidthFromType(tbvData, .Type, .Length, .Name)
      

    End With

    Inc iInd
  Next

  'tbvData.Rows.Count = $rData.Count
  
  tbvData.Refresh
Finally

  Dec Application.Busy

Catch

  Message.Error("Cannot exec request." & "\n\n" & DConv(Error.Text & ", " & Error.Where))

End

Private Function WidthFromType(hCtrl As Control, iType As Integer, iLength As Integer, sTitle As String) As Integer

  Dim iWidth As Integer

  Select Case iType

    Case gb.Boolean
      iWidth = hCtrl.Font.TextWidth(Str(False)) + 32

    Case gb.Integer
      iWidth = hCtrl.Font.TextWidth("1234567890") + 4

    Case gb.Long
      iWidth = hCtrl.Font.TextWidth("12345678901234567890") + 8

    Case gb.Float
      iWidth = hCtrl.Font.TextWidth(CStr(Pi) & "E+999") + 8

    Case gb.Date
      iWidth = hCtrl.Font.TextWidth(Str(Now)) + 16

    Case gb.String
      If iLength = 0 Then iLength = 64
      iLength = Min(32, iLength)
      iWidth = hCtrl.Font.TextWidth("X") * iLength + 4

  End Select

  iWidth = Max(iWidth, hCtrl.Font.TextWidth(sTitle) + 8)

  Return iWidth

End

Public Sub ShowImage(Row As Integer, picBox As PictureBox)
  
  Dim tempFile As String
  'Dim tempPicture As String
  'tempFile = Temp() & ".jpg"
  '$hClientes.MoveTo(Row)
  picBox.Picture = Null
  tempFile = Temp() & ".jpg"
  tempFile = User.Home &/ ".pictures" &/ CStr(Row + 1) & ".jpg"
  'tempPicture = $hClientes["foto_cliente"] 
  'File.Save(tempFile, tempPicture)
  picBox.Picture = Picture.Load(tempFile)
  
End
