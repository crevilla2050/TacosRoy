' Gambas class file

Public hConn As Connection
Public hResultOrdenes As Result
Public qString As String

Private tmpOrden_prods_precio As Result


Public Sub Form_Open()
  'Dim laFecha As String
  
  'Me.Maximized = True 
  
  'Abrimos la conexion que será utilizada en el proyecto
  modVariables.$hConn = modConn.ConectarDB()
  
  lblTimer.Text = modUtils.TimerClk_Timer()
  
  gridMainOrden.header = GridView.Horizontal
  gridMainOrden.grid = True
  gridMainOrden.Rows.count = 0
  gridMainOrden.Columns.count = 4
  gridMainOrden.Columns[0].text = "Orden"
  gridMainOrden.Columns[1].text = "Hora"
  gridMainOrden.Columns[2].text = "Mesa"
  gridMainOrden.Columns[3].text = "Status"
  
  gridMainOrden.Columns[0].width = 80
  gridMainOrden.Columns[1].width = 100
  gridMainOrden.Columns[2].width = 80
  gridMainOrden.Columns[3].width = 100

  gridOrdenDetails.header = GridView.Horizontal
  gridOrdenDetails.grid = True
  gridOrdenDetails.Rows.count = 0
  gridOrdenDetails.Columns.count = 6
  gridOrdenDetails.Columns[0].text = "Orden"
  gridOrdenDetails.Columns[1].text = "IDPO"
  gridOrdenDetails.Columns[2].text = "Producto"
  gridOrdenDetails.Columns[3].text = "IDPR"
  gridOrdenDetails.Columns[4].text = "Cantidad"
  gridOrdenDetails.Columns[5].text = "Precio"
  'gridOrdenDetails.Columns[6].text = "OrdenNR"
  
  gridOrdenDetails.Columns[0].width = 0
  gridOrdenDetails.Columns[1].width = 0
  gridOrdenDetails.Columns[2].width = 180
  gridOrdenDetails.Columns[3].width = 0
  gridOrdenDetails.Columns[4].width = 40
  gridOrdenDetails.Columns[5].width = 40
  'gridOrdenDetails.Columns[6].width = 40
  
  'Obtiene la lista de órdenes abiertas  
  qString = "SELECT `id_orden_id` as 'Orden', `dt_horafecha_orden` as 'Hora', `int_mesa` as 'Mesa', `chr_status_orden` as 'Status' From `tbl_ordenes` where `tbl_ordenes`.`chr_status_orden` = 'Abierta' order by Orden ASC"
  'qString = "SELECT" 
  Try hResultOrdenes = modVariables.$hConn.Exec(qString)
  If Error Then 
    Print Error.Text
  Else
    'Llena el grid con las ordenes abiertas
    gridMainOrden.Rows.Count = hResultOrdenes.Count
    'hResultOrdenes = Null
  Endif
  
  Catch
  Print Error.Text
  '
End

Public Sub Button7_Click()

  modVariables.$hConn.Close
  Me.Close

Catch
  Print Error.Text
End

Public Sub brnNuevaOrden_Click()

Dim qString As String
Dim tmpResult As Result

  If (Message.Question("Desea crear una nueva orden?", "Sí, crear", "NO, Cancelar") = 1) Then
    
    'Antes que nada, se debe elegir mesa
    FMesas.ShowModal
    If modVariables.$strMesaTemp = "" Or modVariables.$intMesero = 0 Then 
      Return
    Endif

    If Error Then 
      Message.Error(Error.Text & ", " & Error.Where) 
    Else
      'Primero checamos el consecutivo siguiente
      Try tmpResult = modVariables.$hConn.Exec("SELECT * FROM tbl_consecutivo order by id_consecutivo Desc Limit 1")
      If Error Then Print Error.Text
      modVariables.$intOrdenTmp = CInt(tmpResult[1])
      
      'Inserta nuevo consecutivo en tabla de consecutivos
      qString = "INSERT INTO `tbl_consecutivo` (`chr_consecutivo`) VALUES (&1)"
      Try modVariables.$hConn.Exec(qString, CInt(modVariables.$intOrdenTmp + 1))
      If Error Then Print Error.Text
      
      'Una vez obtenido el consecutivo, creamos una orden y guardamos el consecutivo
      qString = "INSERT INTO `tbl_ordenes` (`dt_horafecha_orden`, `int_mesa`, `int_consecutivo`, `chr_status_orden`) VALUES (&1, &2, &3, &4)"
      Try modVariables.$hConn.Exec(qString, modUtils.convierteFechaFormatoHora(Now), modVariables.$strMesaTemp, modVariables.$intOrdenTmp, "Abierta")
      If Error Then Print Error.Text
      modVariables.$intOrdenID = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
      
      'Le asignamos la orden a un mesero
      qString = "INSERT INTO `tbl_ordenes_personal` (`id_orden_id`, `id_personal`) VALUES (&1, &2)"
      Try modVariables.$hConn.Exec(qString, modVariables.$intOrdenTmp, modVariables.$intMesero)
      If Error Then Print Error.Text
      
      'Definimos el tipo de precios de esta orden
      qString = "INSERT INTO `tbl_precio_tipo_ordenes` (`id_orden`, `id_tipo_precio`) VALUES (&1, &2)"
      Try modVariables.$hConn.Exec(qString, modVariables.$intOrdenTmp, modVariables.$intTipoPrecio)
      
      
    Endif
    FComandasN.ShowModal
  Endif
  
  Catch
  Print Error.Text
  
End

Public Sub btnCancelOrden_Click()

  Dim sQuery As String

  If (Message.Question("Desea cancelar la orden seleccionada?" & gb.Cr & "Este paso es irreversible", "Sí, Cancelar", "No, Continuar") = 1) Then
    Print gridMainOrden.Row
    
    hResultOrdenes.MoveTo(gridMainOrden.Row)
    sQuery = "UPDATE  `tbl_ordenes` SET  `chr_status_orden` =  'Cancelada', `dt_horafecha_orden` = Now(), `chr_status_orden` = 'Cancelada' WHERE `tbl_ordenes`.`id_orden_id` =&1"
    gridMainOrden.Rows.Count = 0
    Try modVariables.$hConn.Exec(sQuery, hResultOrdenes[0])
    
    'Mostrar pantalla de cobrar con 0 pesos
    FCobrar.txtReferenciaPago.Text = "CANCELADA"
    FCobrar.txtReferenciaPago.Visible = True
    FCobrar.btnAplicaDesc.Visible = False
    FCobrar.lblDescuento.Visible = False
    FCobrar.txtDescuento.Visible = False
    FCobrar.cmbFormaPago.Enabled = False
    FCobrar.btnOK.Enabled = True
    
    FCobrar.ShowModal()
  
    If Error Then 
      Message.Error(Error.Text & ", " & Error.Where)
    Else
      sQuery = "SELECT `id_orden_id` as 'Orden', `dt_horafecha_orden` as 'Hora', `int_mesa` as 'Mesa', `chr_status_orden` as 'Status' From `tbl_ordenes` where `tbl_ordenes`.`chr_status_orden` = 'Abierta' order by Orden ASC"
      Try hResultOrdenes = modVariables.$hConn.Exec(sQuery)
      gridMainOrden.Rows.Count = 0
      gridMainOrden.Rows.Count = hResultOrdenes.Count
    Endif
  Endif
  
  Catch
  Print Error.Text
  
End

Public Sub btnCerrarOrden_Click()
  
  Dim intResp As Integer
  
  intresp = Message.Question("Desea cerrar/cobrar la orden No: " & modVariables.$intOrdenTmp & "?", "Cerrar", "Cancelar")
  Select Case intresp
    Case 1
      FCobrar.ShowModal
    Case Else
      Message("No se hara nada")
  End Select

End

Public Sub Button5_Click()

  FConfigs.ShowModal
  
End

Public Sub Timer1_Timer()
Dim sQueryString As String
Dim rResult As Result

  lblTimer.Text = modUtils.TimerClk_Timer()
  
End


Public Sub gridMainOrden_Data(Row As Integer, Column As Integer)

  Try hResultOrdenes.moveTo(Row)
  If Error Then 
    Print Error.Text 
  Else
    If row Mod 2 = 0 Then gridMainOrden.Data.Background = Color.RGB(115, 115, 115)
    gridMainOrden.Data.text = Str(hResultOrdenes[gridMainOrden.Columns[column].text])
  Endif
Catch
  Print Error.Text
End

Public Sub gridMainOrden_Click()

Dim qString As String
Dim intTempOrder As Integer

  gridOrdenDetails.Rows.Count = 0
  intTempOrder = hResultOrdenes.MoveTo(gridMainOrden.Row)
  modVariables.$intOrdenID = hResultOrdenes["Orden"]
  'modVariables.$intOrdenTmp = hResultOrdenes["OrdenNR"]
  modVariables.$strMesaTemp = hResultOrdenes[2]
  
  btnCancelOrden.Enabled = True
  btnModifOrden.Enabled = True
  btnCerrarOrden.Enabled = True

  qString = "Select * from vw_orden_prods_precio where `Orden` = &1 and `Activo` and `PRActivo` = 1 order by `HoraFecha` Asc"  
    Try tmpOrden_prods_precio = modVariables.$hConn.Exec(qString, hResultOrdenes[0])
    If Error Then 
      Message.Error(Error.Text & ", " & Error.Where) 
     Else 
      'Message(qString & ", " & hResultOrdenes[0])
      gridOrdenDetails.Rows.Count = tmpOrden_prods_precio.Count
    Endif
  
If gridMainOrden.Row > 0 Then btnImrpimeCuenta.Enabled = True

End

Public Sub gridMainOrden_KeyRelease()

Dim qString As String
Dim intTempOrder As Integer

  gridOrdenDetails.Rows.Count = 0
  intTempOrder = hResultOrdenes.MoveTo(gridMainOrden.Row)
  modVariables.$intOrdenID = hResultOrdenes["Orden"]
  'modVariables.$intOrdenTmp = hResultOrdenes["OrdenNR"]
  modVariables.$strMesaTemp = hResultOrdenes[2]
  
  btnCancelOrden.Enabled = True
  btnModifOrden.Enabled = True
  btnCerrarOrden.Enabled = True

  qString = "Select * from vw_orden_prods_precio where `Orden` = &1 and `Activo` = 1 order by `HoraFecha` Asc"  
    Try tmpOrden_prods_precio = modVariables.$hConn.Exec(qString, hResultOrdenes[0])
    If Error Then 
      Message.Error(Error.Text & ", " & Error.Where) 
     Else 
      'Message(qString & ", " & hResultOrdenes[0])
      gridOrdenDetails.Rows.Count = tmpOrden_prods_precio.Count
    Endif
  
If gridMainOrden.Row > 0 Then btnImrpimeCuenta.Enabled = True

End


Public Sub gridOrdenDetails_Data(Row As Integer, Column As Integer)

  Try tmpOrden_prods_precio.moveTo(Row)
  If Error Then Print Error.text
  
  Try gridOrdenDetails.Data.text = Str(tmpOrden_prods_precio[gridOrdenDetails.Columns[column].text])  
  If Error Then Print Error.text
  
  If row Mod 2 = 0 Then gridOrdenDetails.Data.Background = Color.RGB(115, 115, 115)

End

Public Sub Button4_Click()

 

End

Public Sub btnModifOrden_Click()

  If (Message.Question("Desea modificar la orden seleccionada?", "Sí, Modificar", "No, Cancelar") = 1) Then
    FComandasN.ShowModal
  Endif

End

Public Sub btnImrpimeCuenta_Click()

  Me.Enabled = False
  Inc Application.Busy
  PrinterCuenta.OutputFile = User.Home &/ "ticket.pdf"
  PrinterCuenta.Print()
  Dec Application.Busy
  Me.Enabled = True
  

End

Public Sub PrinterCuenta_Draw()

  Dim PRINT_MARGIN As Float
  Dim iInc As Integer
  Dim hImage As Image
  Dim sQuery As String
  Dim rResult, rResult2 As Result
  Dim rYPrint As Integer
  Dim rResultPromos As Result
  Dim fTotal, flTemporal As Float
  Dim myTicket As Integer
  Dim docV As String

  PRINT_MARGIN = 1
  iInc = 1
  
  sQuery = "Select Producto, Cantidad, Precio, (Cantidad * Precio) as Subtotal from vw_orden_prods_precio where `Orden` = &1 and `Activo` = 1 and `PRActivo` = 1 order by `HoraFecha` Asc"
  
  Try rResult = modVariables.$hConn.Exec(sQuery, modVariables.$intOrdenID)
  If Error Then Message.Error(Error.Text & ", " & Error.Where)
  
  hImage = Image.Load(User.Home &/ ".tacosroy/pictures" &/ "logoTicket.png")
  hImage.Opacity(0.3)
  Paint.MoveTo(1, 105)
  Paint.DrawImage(hImage, 12, 200, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  sQuery = "Select * From `tbl_ticket_cons` ORDER BY id_ticketNrConsecutivo DESC LIMIT 1"
  Try rResult2 = modVariables.$hConn.Exec(sQuery)
  myTicket = CInt(rResult2[1])
  
  Paint.Font = Font["Helvetica, Bold, 12"]
  docV = "Orden: " & modVariables.$intOrdenID & ", Ticket Nr.: " & myTicket 
  Paint.DrawRichText(docV, PRINT_MARGIN, 300 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  docV = "Mesa: " & modVariables.$strMesaTemp
  Paint.DrawRichText(docV, PRINT_MARGIN, 600 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  Paint.Font = Font["Helvetica, Regular, 10"]
  
  Paint.MoveTo(1, 405)
  docV = Format(Now, "dddd dd mmmm yyyy, hh:nn:ss")
  Paint.DrawRichText(docV, 1, rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  docV = Null
  
  Paint.Font = Font["Helvetica, Regular, 10"]
  docV = "Detalle de la orden:\n"
  Paint.DrawRichText(docV, PRINT_MARGIN, 2000 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
  Paint.Font = Font["Helvetica, Regular, 9"]
  Try rResult = modVariables.$hConn.Exec("Select * from vw_orden_prods_precio where `Orden` = &1 and `Activo` = 1 and `PRActivo` = 1 order by `HoraFecha`", modVariables.$intOrderID)
  If rResult <> Null Then
    
    fTotal = 0
    For Each rResult
      docV = ""
      
      sQuery = "Select * from tbl_promociones where id_producto = &1"
        Try rResultPromos = modVariables.$hConn.Exec(sQuery, rResult!IDPR)
        
        If rResultPromos <> Null Then 'Hay una promocion para este producto, checar validez de días.
          flTemporal = 0
          If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
            flTemporal = rResult!Precio - (rResult!Precio * rResultPromos!fl_descuento)
            flTemporal = (flTemporal * rResult!Cantidad)
            fTotal = ftotal + flTemporal
          Endif
        Else
          flTemporal = (rResult!Precio * rResult!Cantidad)
          fTotal = ftotal + flTemporal
          Endif
        rResultPromos = Null 

      docV = rResult["Cantidad"] & gb.Tab & gb.Tab & gb.Tab & rResult["Producto"] & gb.Cr & gb.Tab & "$" & CInt(flTemporal)
      Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2200 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
      Inc iInc  
    Next
  Endif
  
  Paint.Font = Font["Helvetica, Regular, 12"]
  docV = "Total a Pagar: $" & fTotal & ".00"
  Paint.DrawRichText(docV, PRINT_MARGIN, (iInc * 250) + 2400 + rYPrint, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  

End



Public Sub mnuConfig_Click()

  FConfigs.ShowModal

End

Public Sub mnuTools_Click()

  FReports.Show

End

Public Sub mnuSalir_Click()

  modVariables.$hConn.Close
  Me.Close

End

Public Sub mnuReTickets_Click()

  FReimpTickets.ShowModal

End

Public Sub mnuABCProds_Click()

  FProductos.ShowModal()

End
