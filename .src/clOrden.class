' Gambas class file

' Gambas class: clOrden

Property iNrOrden As Integer
Property iTipoPrecio As Integer
'Property OrderExists As Integer

Private i_NrOrden As Integer
Private i_TipoPrecio As Integer
Private i_IDProducto As Integer
Private i_sProductoTmp As Integer
Private i_Cantidad As Integer

Private i_items As New Integer[0, 0]
'Public aNames As New String[2, 2]

'Public Struct Orden
'  'i_OrdenNr As Integer
'  i_IdProducto As Integer[]
'  i_Cantidad As Integer[]  
'End Struct

Private Function iNrOrden_Read() As Integer

  Return i_NrOrden

End

Private Sub iNrOrden_Write(Value As Integer)

  i_NrOrden = Value

End

Private Function iTipoPrecio_Read() As Integer

  Return i_TipoPrecio

End

Private Sub iTipoPrecio_Write(Value As Integer)

  i_TipoPrecio = Value

End

Private Function OrderExists_Read() As Integer
  
  Return i_NrOrden
  
End


Private Sub OrderExists_Write(Value As Integer)
  
  i_NrOrden = OrderExists(Value)
  
End


Public Function OrderExists(IdOrden As Integer) As Integer
  Dim sQuery As String
  Dim hResult As Result
  
  sQuery = "SELECT * FROM `tbl_ordenes` where `id_orden_id` = &1"
  
  Try hResult = modVariables.c_Conn.Exec(sQuery, IdOrden)
  
  If hResult <> Null And hResult.Available Then
    i_NrOrden = CInt(hResult["id_orden_id"])
    Return i_NrOrden
  Else
    Return 0
  Endif
  
Catch
  Print Error.Where & ", " & Error.Text
  Return 0

End

Public Sub AddItems(i_IDProducto As Integer, i_Cantidad As Integer)
  
  'B.Add  (  [ "Hola", "Desde" , "Gambas" ] )
  i_items.Add([i_IDProducto, i_Cantidad])

Catch
  Print (Error.Text & ", " & Error.Where)
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Function ReadItems() As Integer[]
  
  Return i_items
  
End


Public Sub CommitItems()
  Dim sQuery As String
  Dim hResult, hResultCombos As Result
  Dim i_iLastOrdenProd As Integer
  
  
  Try modVariables.c_Conn.Begin()
  hResult = modVariables.c_Conn.Create("tbl_prods_x_orden")
  hResult!int_orden_id = i_NrOrden
  hResult!int_producto_id = i_IDProducto
  hResult!int_cantidad = i_Cantidad
  hResult!bool_activo = 1
  hResult!dt_horafecha_pedido = Now()
  hResult!bool_impreso = 0
  hResult!int_tipo_precio = i_TipoPrecio
  Try hResult.Update()
  Try modVariables.c_Conn.Commit()
  
  'i_items.Add([i_IDProducto, i_Cantidad])
  
  i_iLastOrdenProd = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
  hResult = Null
  
  sQuery = "SELECT * from vw_combos_productos where `ID Prod Rel` = &1 and Activo = 1"
  Print sQuery
  Try hResult = modVariables.c_Conn.Exec(sQuery, i_IDProducto)

  If hResult <> Null And hResult.Available Then 'es un combo, agregar productos del combo
  Dim iCombo As Integer
  iCombo = i_iLastOrdenProd
    For Each hResult
      i_iLastOrdenProd = 0
      hResultCombos = Null
      'sQuery = "INSERT INTO `tbl_prods_x_orden` (`int_orden_id`, `int_producto_id`, `int_cantidad`, `bool_activo`, `dt_horafecha_pedido`, `bool_impreso`) VALUES (&1, &2, 1, '1', Now(), 0);"
      'Try modVariables.c_Conn.Exec(sQuery, modVariables.i_intOrdenID, hResult["ID Producto"])
      
      Try modVariables.c_Conn.Begin()
      hResultCombos = modVariables.c_Conn.Create("tbl_prods_x_orden")
      hResultCombos!int_orden_id = i_NrOrden
      hResultCombos!int_producto_id = hResult["ID Producto"]
      hResultCombos!int_cantidad = hResult["Cant. x Combo"]
      hResultCombos!bool_activo = 1
      hResultCombos!dt_horafecha_pedido = Now()
      hResultCombos!bool_impreso = 0
      hResultCombos!int_tipo_precio = i_TipoPrecio
      Try hResultCombos.Update()
      Try modVariables.c_Conn.Commit()
      
      hResultCombos = Null
      
      'Checamos si alguna opción está habilitada
      i_iLastOrdenProd = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
     ' sQuery = "INSERT INTO `tbl_combos_ordenes` (`id_orden_id`,`id_combo_id` ,`id_prod_x_orden_combo`,`id_prod_x_orden_parte_combo`) VALUES (&1, &2, &3, &4)"
      'Try modVariables.c_Conn.Exec(sQuery, iCombo, hResult["ID Prod Rel"], hResult["ID Producto"], i_iLastOrdenProd)
      
      Try modVariables.c_Conn.Begin()
      hResultCombos = modVariables.c_Conn.Create("tbl_combos_ordenes")
      hResultCombos!id_orden_id = iCombo
      hResultCombos!id_combo_id = hResult["ID Prod Rel"]
      hResultCombos!id_prod_x_orden_combo = hResult["ID Producto"]
      hResultCombos!id_prod_x_orden_parte_combo = i_iLastOrdenProd
      Try hResultCombos.Update()
      Try modVariables.c_Conn.Commit()
      'lee variantes si las hay para este producto
      'productos_variantes(i_iLastOrdenProd)
    Next
  'Else
    'productos_variantes(i_iLastOrdenProd)
  Endif
  
  modVariables.b_FsAMProdsReturn = True
  
  hResult = Null
Catch
  Print (Error.Text & ", " & Error.Where)
  Message.Error(Error.Text & ", " & Error.Where)
  
End



