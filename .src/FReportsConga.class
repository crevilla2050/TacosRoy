' Gambas class file

Private sQueryString As String
Private rsRecords As Result
Private rsFormasPago As Result

Private iControlFechaStart As Integer
Private iControlFechaEnd As Integer
Private sHTML As String

Private fTotales As New Float[]

'Impresion de tickets y reportes
Private rYPrint As Integer
Private Const PRINT_MARGIN As Float = 5


Public Sub Form_Open()

  DateChooser1.MinValue = modVariables._cnnComienzoLabores
  dtFechaInicio.MinValue = modVariables._cnnComienzoLabores
  dtFechaFinal.MinValue = modVariables._cnnComienzoLabores
  
End

Public Sub btnBuscar_MouseUp()

Dim iInc, iJnc As Integer
Dim hResult As Result
Dim iControl As Integer

  If Mouse.Control Then 
    iControl = 1
  Else 
    iControl = 0
  Endif 
'Dim cResultado As Collection

'  cResultado = New Collection
  'get IndexPersonal
  sQueryString = "SELECT * FROM tbl_formas_pago where int_activo = 1;"
  Try rsFormasPago = modVariables.c_Conn.Exec(sQueryString)
  
  sQueryString = "SELECT `chr_var_value` from `tbl_configs` where `chr_var_name` = 'personal_index';"
  Try hResult = modVariables.c_Conn.Exec(sQueryString)
  modVariables.i_intIDPersonal = CInt(hResult[0])
  
  If radioFechaUnica.Value = True Then
    modVariables._cnnFechaInicio = DateChooser1.Value
    modVariables._cnnFechaFinal = DateChooser1.Value
  Else
    modVariables._cnnFechaInicio = dtFechaInicio.Value
    modVariables._cnnFechaFinal = dtFechaFinal.Value
  Endif
  
  sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_fecha_calendario`) >= DATE(&1) and Date(`dt_fecha_calendario`) <= DATE(&2);"
  'Print sQueryString
  Try hResult = modVariables.c_Conn.Exec(sQueryString, Format(modVariables._cnnFechaInicio, "yyyy-mm-dd"), Format(modVariables._cnnFechaFinal, "yyyy-mm-dd"))
  iInc = 0
  iJnc = 0
  If (hResult <> Null) And hResult.Available Then
    
    sHTML = "<table>"
    sHTML &= "<tr>"
    sHTML &= "<td>Fecha</td>"
    For Each rsFormasPago
      sHTML &= "<td>" & rsFormasPago[1] & "</td>" & gb.CrLf
    Next
    rsFormasPago = Null
    sHTML &= "</tr>"
    For iInc = 0 To (hResult.Count - 1)
      hResult.MoveTo(iInc)
      rsRecords = Null
      sHTML &= "<tr>"
      sQueryString = "SELECT m.id_forma_pago, "
      sQueryString &= "(Select `tbl_control_fechas`.`dt_fecha_calendario` FROM `tbl_control_fechas` WHERE `tbl_control_fechas`.`id_control_fechas` = &1) as `Fecha`,"
      sQueryString &= "m.chr_forma_pago, "
      If iControl = 1 Then 
        sQueryString &= "(Select IFNULL(SUM(`Total`),0) FROM vw_orconcentrado WHERE `ID Pago` = m.id_forma_pago and `Control Fecha` = &1) as `Total`"
      Else 
        sQueryString &= "(Select IFNULL(SUM(`Total`),0) FROM vw_por_tipo WHERE `ID Pago` = m.id_forma_pago and `Control Fecha` = &1) as `Total`"
      Endif 
      sQueryString &= " From tbl_formas_pago As m;"
      'Print sQueryString
      
      Try rsRecords = modVariables.c_Conn.Exec(sQueryString, hResult["id_control_fechas"])
      If (rsRecords <> Null) Then 
          sHTML &= "<td>" & Format(rsRecords["Fecha"], "yyyy-mm-dd") & "</td>" & gb.CrLf
          sHTML &= generaHTMLVentas(rsRecords)
      Endif
      sHTML &= "</tr>"
    Next
    sHTML &= "</table>"
  Else
    Message.Info("No se han encontrado registros")
    sHTML = ""
    'btnGeneraReporte.Enabled = False
    Return
  Endif
  
  'File.Save("/tmp/rest.tmp.html", sHTML)
  webGridConga.HTML = sHTML
  'btnGeneraReporte.Enabled = True

Catch 
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub radioFechaUnica_Click()

  frmFechaUnica.Visible = radioFechaUnica.Value
  frmFechaRango.Visible = Not radioFechaUnica.Value

End

Public Sub radioFechaRango_Click()

  frmFechaRango.Visible = radioFechaRango.Value
  frmFechaUnica.Visible = Not radioFechaRango.Value

End

Public Sub Button2_Click()

  If (Message.Question("¿En verdad desea Salir?", "Sí, Salir", "No, Cancelar")) = 1 Then 
    Me.Close
  Endif

End


Public Function generaHTMLVentas(rsRecords As Result) As String
  
  Dim tempHTML, sTableHeaders As String
  Dim iInt As Integer
  Dim jInt As Integer
  Dim fMyField As Field
  
  For Each rsRecords
    tempHTML &= "<td>" & Round(CFloat(rsRecords["Total"]), -2) & "</td>" & gb.CrLf
  Next
  
  'Print tempHTML
  Return tempHTML

Catch 
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub gridReportConga_Data(Row As Integer, Column As Integer)
  
  If (rsRecords <> Null) Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportConga.Data.Text = Str(rsRecords[Column])
    Endif
  Endif

Catch 
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnGeneraCuenta_Click()

Dim sTempFile, sFileName, sFinalFile, sPath, sCopyPath, sCommand As String

'Dim iPaginas, iInc As Integer

  Me.Enabled = False
  Inc Application.Busy
  
  sFileName = Format(Now, "yyyy-mm-dd_hh:nn:ss")
  sFinalFile = modVariables.sPrefijoDB & "-" & sFileName
  sPath = User.Home &/ modVariables.sCloudDirectory &/ "Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "mm") &/ Format(Now, "dd")
  
  If Not Exist(sPath) Then modUtils.CreateDirTree(sPath)
  sFileName = "cng_" & sFinalFile 
  sTempFile = sPath &/ sFileName & ".pdf"
  
  'PrinterCuenta.PaperWidth = 80
  PrinterCuenta.Count = 1
  
  'PrinterCuenta.PaperHeight = 1550
  
  PrinterCuenta.OutputFile = sTempFile
  'make document

  PrinterCuenta.Print() 
  'print it
  
  sCopyPath = User.Home &/ modVariables.sCloudDirectory &/ "Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "yyyy") &/ Format(Now, "mm") &/ Format(Now, "dd")
  
  If Not Exist(sCopyPath) Then modUtils.CreateDirTree(sCopyPath)
  If Exist(sTempFile) Then Copy sTempFile To sCopyPath &/ sFileName & ".pdf"
  Wait
  
  If Exist(sTempFile) Then Kill sTempFile
 
  'sCommand = "lpr " & sCopyPath & "/" & sFileName & ".pdf"
  'Shell sCommand Wait 
  'Print tempContents
  
  modUtils.saveExcelFile(sCopyPath & "/", sHtML)
  
  sCommand = "xreader " & sCopyPath &/ sFileName & ".pdf"
  Shell sCommand Wait
  'modUtils.doSQLDump()
  'sCommand = "nemo " & sCopyPath
  'Shell sCommand
  
  
  Me.Enabled = True
  Dec Application.Busy
  

Catch 
  Print Error.Where & ", " & Error.Text
  Message.Error(Error.Where & ", " & Error.Text)

End

Public Sub PrinterCuenta_Draw()

  sHTML = sGeneraCuentaHTML(iControlFechaStart, iControlFechaEnd)
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  Paint.Font = Font["Courier New,10"]
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
End

Public Function sGeneraCuentaHTML(iControlFechaStart As Integer, iControlFechaEnd As Integer) As String
  
  Dim sQuery As String
  Dim hResult, hResultCantidad, hResultPrecio As Result
  Dim sTemporal, sPersonalText, sDelString, sDelSigno, sDetallado As String
  Dim flMyPrice As Float
  Dim iInc, iInd, iIne, iIndexPersonal As Integer
  Dim iCantidadTotal As Integer

  Dim bFound As Boolean
    
  Dim sArray As String[] = Split(File.Load("Templates/conglomerado.html"), gb.Newline, "", True)
  
  sHTML = sArray.Join(gb.Newline)
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  sHTML = Replace(sHTML, "@@DiaComienzo@@", Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy"))
  
  If radioFechaRango.Value = True Then
    sHTML = Replace(sHTML, "@@DiaFin@@", "Al dia: " & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy"))
  Else
    sHTML = Replace(sHTML, "@@DiaFin@@", "")
  Endif
    
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)

  sHTML = Replace(sHTML, "@@NombreSuc@@", hResult["chr_nombre"])
  sHTML = Replace(sHTML, "@@DirSuc1@@", hResult["chr_dir1"])
  sHTML = Replace(sHTML, "@@DirSuc2@@", hResult["chr_dir2"])
  sHTML = Replace(sHTML, "@@DirSuc3@@", hResult["chr_dir3"])
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", hResult["chr_telefono1"])
  
  hResult = Null
  
  'Formas de pago
  sQuery = "SELECT * FROM tbl_formas_pago where int_activo = 1;"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  Dim iFormaPago As New Integer[hResult.Count]
  Dim sNombreFormaPago As New String[hResult.Count]
  Dim flCobroxFormaPago As New Float[hResult.Count] '[FormaPago, Activo]
      
      
  sTemporal = "<tr>"
  For iInc = 0 To hResult.Count - 1
    iFormaPago[iInc] = hResult["id_forma_pago"]
    sNombreFormaPago[iInc] = hResult["chr_forma_pago"]
    sTemporal &= "<td>" & sNombreFormaPago[iInc] & "</td>"
    hResult.MoveNext
  Next
  sTemporal &= "</tr>"
  hResult = Null
    
  'sTemporal &= "<tr><td>Por Forma de pago:</td></tr>" & gb.CrLf
  For iInc = 0 To hResult.Count - 1
    'flCobroxTiposPrecios[iInc, hResult["Activo"]]
    sTemporal &= "<tr>"
    If flCobroxFormaPago[iInc] <> 0 Then 
      sTemporal &= "<td>$" & flCobroxFormaPago[iInc] & ".00</td>" & gb.CrLf
    Else 
      sTemporal &= "<td>$0.00</td>" & gb.CrLf
    Endif
    sTemporal &= "</tr>"
  Next
  
  'sTemporal &= "</span>"
  sHTML = Replace(sHTML, "@@Detalle@@", sTemporal)
    
  hResult = Null
  hResultCantidad = Null
  hResultPrecio = Null
 
  
  Return sHTML
  sTemporal = Null
  
Catch
  Print Error.Where & "- " & Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End


