' Gambas class file

Public myCSVfile As CsvFile
Public myPath As String

Private iRecords As Integer
Private colRecords As New Collection
Private aFields As String[]
Private iFoliosFacturas As Integer[]

Public Sub Button1_Click()


Dim iInt As Integer

  myCSVfile = New CsvFile(myPath)
  Do Until myCSVfile.Eof
    colRecords[myCSVfile.Line] = myCSVfile.Read()   'read every line into a collection
    Inc iRecords                                    'count the number of records
  Loop
  aFields = myCSVfile.Fields      'get the field headers (i.e. "name", "rank" & "serialNo"
  
  gridFacturas.Rows.Count = 0
  gridFacturas.Columns.Count = 0
  
  gridFacturas.Header = GridView.Horizontal
  gridFacturas.Grid = True
  gridFacturas.Columns.Count = aFields.Count
  
  For iInt = 0 To aFields.Count - 1
    gridFacturas.Columns[iInt].Text = myCSVfile.Fields[iInt]
    'If myCSVfile.Fields[iInt] = "total" Or myCSVfile.Fields[iInt] = "fecha" Or myCSVfile.Fields[iInt] = "rfc" Then 
    '  gridFacturas.Columns[iInt].Width = 0
    'Endif
  Next
   FTickets.iLastIndex = 0
  'display some data from the CSV file
  If colRecords.Count > 0 Then 
    gridFacturas.Rows.Count = colRecords.Count - 2
    Button2.Enabled = True
    Me.Text = "Buscar facturas: " & "Columnas: " & aFields.Count & ", Facturas encontradas: " & CStr(colRecords.Count - 2)
  Else 
    gridFacturas.Rows.Count = 0
    Button2.Enabled = False
  Endif 
End

Public Sub btnPickFile_Click()

  FFilePick.ShowDialog
  myPath = modVariables.sFilePath
  
  If myPath <> "" Then 
    Button1.Enabled = True
  Else 
    Button1.Enabled = False
  Endif

End

Public Sub gridFacturas_Data(Row As Integer, Column As Integer)


  If Row Mod 2 = 0 Then gridFacturas.Data.Background = Color.RGB(115, 115, 115)

  If (colRecords[Row + 2] <> Null) Then 
    gridFacturas.Data.text = colRecords[Row + 2][CStr(aFields[Column])]
  Endif

Catch
  Print Error.Text

End

Public Sub Button2_Click()

Dim myColName As String
Dim myField As Variant
Dim myValue As Variant
Dim iInc, iJnc, iRecordsCount As Integer
Dim iSelFacturas As Integer
Dim myDate As Date
Dim myfTotal, fResTotal As Float
Dim sDay, sMonth, sYear As Integer
Dim bDateFound, bTotalFound, bFound, bAdded As Boolean


Inc Application.Busy

bfound = False
FTickets.iLastIndex = 0
bTotalFound = False
bDateFound = False
bAdded = False
iInc = 0
iSelFacturas = 0
'FTickets.iSelected.Clear
  Print "colRecords.Count: " & colRecords.Count
  For iRecordsCount = 0 To colRecords.Count
    
    lblStatus.Text = ""
    lblStatus.Text = "Registro: " & iRecordsCount & ", iInt: " & iInc
    'lblStatus.Refresh
    Inc Application.Busy
    For Each myField In colRecords
      Inc Application.Busy
      If (myField <> Null) Then
        For Each myColName In aFields
          Select Case myColName
            Case "total"
              If (myField["total"] <> Null) Then 
                myfTotal = CFloat(Round(myField["total"]))
                bTotalFound = True
              Else 
                myfTotal = 0
                bTotalFound = False
              Endif 
            Case "subtotal"
              If (myField["subtotal"] <> Null) Then 
                myfTotal = CFloat(Round(myField["total"]))
                bTotalFound = True
              Else 
                myfTotal = 0
                bTotalFound = False
              Endif 
            Default 
          End Select
          If bTotalFound Then 
            bFound = False
            'FTickets.rsRecords.MoveFirst
            'FTickets.rsRecords.MoveTo(iLastIndex)
            'For Each FTickets.rsRecords 'read total and date from records, one at the time
            For iJnc = FTickets.iLastIndex To FTickets.rsRecords.Count - 1
              Inc Application.Busy
              bAdded = False 
              FTickets.rsRecords.MoveTo(iJnc)
              'If Year(myDate) >= Year(CDate(FTickets.rsRecords["Fecha Hora"])) And Month(myDate) >= Month(CDate(FTickets.rsRecords["Fecha Hora"])) And Day(myDate) >= Day(CDate(FTickets.rsRecords["Fecha Hora"])) Then
              fResTotal = CFloat(FTickets.rsRecords["Total"])
                If myfTotal = fResTotal Or fResTotal <= 85 Or fResTotal = 0 Or FTickets.rsRecords["ID Pago"] <> 1 Then
                  Print "fResTotal: " & fResTotal
                  FTickets.iLastIndex = FTickets.rsRecords.Index
                  For iInc = 0 To FTickets.iSelected.Count - 1
                    If FTickets.iSelected[iInc] = FTickets.iLastIndex Then bAdded = True
                    Dec Application.Busy
                  Next
                  If Not bAdded Then 
                    FTickets.iSelected.Add(FTickets.iLastIndex)
                    bFound = True 'reset bfound
                    bTotalFound = False 
                    bAdded = True
                    Print "iLastIndex: " & FTickets.iLastIndex & "-" & FTickets.rsRecords.Index
                    Dec Application.Busy
                  Endif 
                Endif 
              'Endif
              'If iLastIndex >= FTickets.rsRecords.Count Then iLastIndex -= FTickets.rsRecords.Count
              If bFound Then 
                Inc FTickets.iLastIndex
                Dec Application.Busy
                Break
              Endif
              With FTickets
                For Each .listaComandasTarjeta.List
                  If (.rsRecords["Comanda"] <> Null) Then
                    If CStr(.rsRecords["Comanda"]) = CStr(.listaComandasTarjeta.List[iJnc]) Then
                      For iInc = 0 To .iSelected.Count - 1
                        If .iSelected[iInc] = FTickets.iLastIndex Then bAdded = True
                      Next
                      If Not bAdded Then 
                        .iSelected.Add(FTickets.iLastIndex)
                        bFound = True 'reset bfound
                        bTotalFound = False 
                        bDateFound = False
                        bAdded = False
                        Break 
                      Endif
                    Endif
                  Endif
                  Inc iJnc
                Next
              End With 
            Next 
          Endif
          If iInc >= colRecords.Count Then Break 
          Dec Application.Busy
        Next 
        Dec Application.Busy
      Endif
      Dec Application.Busy
    Next
    Dec Application.Busy
  Next 
Dec Application.Busy
'  Me.Close

Catch 
  Message.Error(Error.Where & ": " & Error.Text)
  Print Error.Text

End
