' Gambas class file

Private hResult As Result
Private sQuery As String
Private hResultVarCosto As Result
Private myIDProd As Integer

Public Sub Form_Open()

Dim myLabel As Label
Dim chkVariantes As CheckBox
Dim myTxtCostoExtra As Textbox 
Dim myTxtTipoCosto As TextBox
Dim hBoxTipoPrecio As HBox
Dim lblTipoCosto As Label
Dim iInc As Integer

'comentario temporal

  If modVariables.c_Conn = Null Then modVariables.c_Conn = modConn.ConectarDB()
  
  iInc = 0
  
  sQuery = "SELECT * FROM `tbl_tipos_precios` where `bit_activo` = 1"
  
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  For Each hResult
    cmbTiposPRecios.Add(hResult["chr_nombre_precio"], hResult["id_tipo_precio"])
  Next
  
  If modVariables.i_currProductoInteger <> 0 Then
    myIDProd = modVariables.i_currProductoInteger
  Else
    myIDProd = 156
  Endif

  hResult = Null
  sQuery = "SELECT * FROM `vw_variantes_x_platillo` where `ID Producto` = &1 AND `Tipo Precio` = '1' order by `ID Producto`, `Ordenar`;" 
  Try hResult = modVariables.c_Conn.Exec(sQuery, myIDProd)
  
  For Each hResult
    Inc iInc
    With hResult
      If iInc > 0 And iInc <= 10 Then
        chkVariantes = New CheckBox(VBoxCheck1) As "chkVariantePlatillo" & iInc
        myTxtCostoExtra = New TextBox(vBoxText1) As "txtCostoExtra" & iInc
      Else If iInc > 10 And iInc <= 20 Then
        chkVariantes = New CheckBox(VBoxCheck2) As "chkVariantePlatillo" & iInc
        myTxtCostoExtra = New TextBox(vBoxText2) As "txtCostoExtra" & iInc
      Else If iInc > 20 And iInc <= 30 Then
        chkVariantes = New CheckBox(VBoxCheck3) As "chkVariantePlatillo" & iInc
        myTxtCostoExtra = New TextBox(vBoxText3) As "txtCostoExtra" & iInc
      Endif


      chkVariantes.Text = .["Variante"]
      chkVariantes.AutoResize = True
      chkVariantes.Value = False
      chkVariantes.Tag = .["IDProdVar"]
      
      myTxtCostoExtra.Width = 160
      myTxtCostoExtra.Tag = .["IDProdVar"]
      myTxtCostoExtra.Height = chkVariantes.Height
      
      sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1 and `id_tipo_precio` =  &2"
      Try hResultVarCosto = modVariables.c_Conn.Exec(sQuery, hResult["IDProdVar"], cmbTiposPRecios.Index + 1)
      If hResultVarCosto.Available Then 
        If chkVariantes.Tag = hResult["IDProdVar"] Then
          chkVariantes.Value = True
        Endif
        myTxtCostoExtra.Text = hResultVarCosto["fl_costo_extra"]
      Endif
      
    End With
  Next
  
  hResult = Null
  sQuery = "SELECT * FROM `vw_products_catprecio` where `ID` = &1 and `Activo` = 1 order by `Tipo`"
  Try hResult = modVariables.c_Conn.Exec(sQuery, 166)
  iInc = 0
  
  For Each hResult
    Inc iInc
    With hResult
      hBoxTipoPrecio = New HBox(VBoxTipoCostos) As "hBoxTipoPrecio" & CStr(iInc)
      hBoxTipoPrecio.Expand = True
      lblTipoCosto = New Label(hBoxTipoPrecio) As "lblTipoCosto" & CStr(iInc)
      lblTipoCosto.Text = .["Tipo"]
      lblTipoCosto.AutoResize = True

      myTxtTipoCosto = New TextBox(hBoxTipoPrecio) As "myTxtTipoCosto" & CStr(iInc)
      myTxtTipoCosto.Text = .["Precio"]
      myTxtTipoCosto.Width = 160
      myTxtTipoCosto.Height = 120
    End With
  Next
  hResult = Null
Catch
  Message.Error(Error.Text)
End

Public Sub btnLoad_Click()
Dim myControl As Control
  Dim iInc As Integer
  
  sQuery = "SELECT * FROM `vw_variantes_x_platillo` where `ID Producto` = &1 and `Tipo Precio` = &2 order by `ID Producto`, `Ordenar`;" 
  Try hResult = modVariables.c_Conn.Exec(sQuery, myIDProd, cmbTiposPRecios.Index + 1)
  
  For Each myControl In VBoxCheck1.Children
    Object.SetProperty(myControl, "Value", False)
  Next
  For Each myControl In vBoxText1.Children
    Object.SetProperty(myControl, "Text", "")
  Next
  For Each myControl In VBoxCheck2.Children
    Object.SetProperty(myControl, "Value", False)
  Next
  For Each myControl In vBoxText2.Children
    Object.SetProperty(myControl, "Text", "")
  Next
  For Each myControl In VBoxCheck3.Children
    Object.SetProperty(myControl, "Value", False)
  Next
  For Each myControl In vBoxText3.Children
    Object.SetProperty(myControl, "Text", "")
  Next
  
  If hResult.Available Then
    For Each hResult
      For Each myControl In VBoxCheck1.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          If hResult["Costo Extra"] <> 0 Then
          Object.SetProperty(myControl, "Value", True)
          Object.SetProperty(myControl, "Text", hResult["Variante"])
          Endif
        Endif
      Next
      For Each myControl In vBoxText1.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          If hResult["Costo Extra"] <> 0 Then
            Object.SetProperty(myControl, "Text", hResult["Costo Extra"])
          Else
            Object.SetProperty(myControl, "Text", "")
          Endif
        Endif
      Next

      For Each myControl In VBoxCheck2.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Value", True)
        Endif
      Next
      For Each myControl In vBoxText2.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Text", hResult["Costo Extra"])
        Endif
      Next
 
      For Each myControl In VBoxCheck3.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Value", True)
        Endif
      Next
      For Each myControl In vBoxText3.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Text", hResult["Costo Extra"])
        Endif
      Next
    Next
  Endif

End
