' Gambas class file

Private hResult As Result
Private sQuery As String
Private hResultVarCosto As Result
Private myIDProd As Integer
Private myControlFecha As Integer

Public Sub Form_Open()

Dim myLabel As Label
Dim chkVariantes, chkTipoCosto As CheckBox
Dim myTxtCostoExtra As Textbox 
Dim myTxtTipoCosto As TextBox
Dim hBoxTipoPrecio, hBoxCheckText As HBox
Dim lblTipoCosto As Label
Dim iInc As Integer
Dim hResultTipoCostos As Result
Dim myControl, myCheckText As Control

'comentario temporal

  If modVariables.c_Conn = Null Then modVariables.c_Conn = modConn.ConectarDB()
  
  iInc = 0
  
  If modVariables.i_currProductoInteger <> 0 Then
    myIDProd = modVariables.i_currProductoInteger
  Else
    myIDProd = 156
  Endif
  
  If modVariables.i_idControlFecha <> 0 Then
    myControlFecha = modVariables.i_idControlFecha
  Else
    myControlFecha = 23
  Endif

  hResult = Null
  sQuery = "SELECT * FROM `vw_variantes_x_platillo` where `ID Producto` = &1 AND `Tipo Precio` = '1' order by `ID Producto`, `Ordenar`;" 
  Try hResult = modVariables.c_Conn.Exec(sQuery, myIDProd)
  If hResult <> Null And hResult.Available Then
    txtProd.Text = hResult["Producto"]
  
    For Each hResult
      Inc iInc
      With hResult
        If iInc > 0 And iInc <= 10 Then
          chkVariantes = New CheckBox(VBoxCheck1) As "chkVariantePlatillo" & iInc
          myTxtCostoExtra = New TextBox(vBoxText1) As "txtCostoExtra" 
        Else If iInc > 10 And iInc <= 20 Then
          chkVariantes = New CheckBox(VBoxCheck2) As "chkVariantePlatillo" & iInc
          myTxtCostoExtra = New TextBox(vBoxText2) As "txtCostoExtra" 
        Else If iInc > 20 And iInc <= 30 Then
          chkVariantes = New CheckBox(VBoxCheck3) As "chkVariantePlatillo" & iInc
          myTxtCostoExtra = New TextBox(vBoxText3) As "txtCostoExtra" 
        Endif
  
        chkVariantes.Text = .["Variante"]
        chkVariantes.AutoResize = True
        chkVariantes.Value = False
        chkVariantes.Tag = .["IDProdVar"]
        
        myTxtCostoExtra.Width = 160
        myTxtCostoExtra.Tag = .["IDProdVar"]
        myTxtCostoExtra.Height = chkVariantes.Height
        
        sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1 and `id_tipo_precio` =  &2"
        Try hResultVarCosto = modVariables.c_Conn.Exec(sQuery, hResult["IDProdVar"], cmbTiposPRecios.Index + 1)
        If hResultVarCosto.Available Then 
          If chkVariantes.Tag = hResult["IDProdVar"] Then
            chkVariantes.Value = True
          Endif
          myTxtCostoExtra.Text = hResultVarCosto["fl_costo_extra"]
        Endif
        
      End With
    Next
  Endif
  
  sQuery = "SELECT * FROM `vw_products_catprecio` where `ID` = 29 and `Activo` = 1 order by `IDTipo`;"
  Try hResultTipoCostos = modVariables.c_Conn.Exec(sQuery, myIDProd)
  
  For Each hResultTipoCostos
    cmbTiposPRecios.Add(hResultTipoCostos["Tipo"], hResultTipoCostos["ID Precio"])
    hBoxTipoPrecio = New HBox(VBoxTipoCostos) As "hBoxTipoPrecio" 'create container
    hBoxTipoPrecio.Expand = True
    
    chkTipoCosto = New CheckBox(hBoxTipoPrecio) As "hBoxTipoPrecio" & CStr(iInc)
    chkTipoCosto.Text = hResultTipoCostos["Tipo"]
    chkTipoCosto.Width = 150
    chkTipoCosto.Value = True
    chkTipoCosto.Tag = hResultTipoCostos["ID Precio"]

    myTxtTipoCosto = New TextBox(hBoxTipoPrecio) As "myTxtTipoCosto"
    myTxtTipoCosto.Text = hResultTipoCostos["Precio"]
    myTxtTipoCosto.Width = 160
    myTxtTipoCosto.Tag = hResultTipoCostos["ID Precio"]
  Next
  
  
  
  hResult = Null
Catch
  Message.Error(Error.Text)
End

Public Sub myTxtTipoCosto_KeyPress()
  
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
  
End

Public Sub txtCostoExtra_KeyPress()
  
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
  
End


Public Sub btnLoad_Click()
Dim myControl As Control
  Dim iInc As Integer
  
  sQuery = "SELECT * FROM `vw_variantes_x_platillo` where `ID Producto` = &1 and `Tipo Precio` = &2 order by `ID Producto`, `Ordenar`;" 
  Try hResult = modVariables.c_Conn.Exec(sQuery, myIDProd, cmbTiposPRecios.Index + 1)
  
  For Each myControl In VBoxCheck1.Children
    Object.SetProperty(myControl, "Value", False)
  Next
  For Each myControl In vBoxText1.Children
    Object.SetProperty(myControl, "Text", "")
  Next
  For Each myControl In VBoxCheck2.Children
    Object.SetProperty(myControl, "Value", False)
  Next
  For Each myControl In vBoxText2.Children
    Object.SetProperty(myControl, "Text", "")
  Next
  For Each myControl In VBoxCheck3.Children
    Object.SetProperty(myControl, "Value", False)
  Next
  For Each myControl In vBoxText3.Children
    Object.SetProperty(myControl, "Text", "")
  Next
  
  If hResult.Available Then
    For Each hResult
      For Each myControl In VBoxCheck1.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          If hResult["Costo Extra"] <> 0 Then
          Object.SetProperty(myControl, "Value", True)
          Object.SetProperty(myControl, "Text", hResult["Variante"])
          Endif
        Endif
      Next
      For Each myControl In vBoxText1.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          If hResult["Costo Extra"] <> 0 Then
            Object.SetProperty(myControl, "Text", hResult["Costo Extra"])
          Else
            Object.SetProperty(myControl, "Text", "")
          Endif
        Endif
      Next

      For Each myControl In VBoxCheck2.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Value", True)
        Endif
      Next
      For Each myControl In vBoxText2.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Text", hResult["Costo Extra"])
        Endif
      Next
 
      For Each myControl In VBoxCheck3.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Value", True)
        Endif
      Next
      For Each myControl In vBoxText3.Children
        If Object.GetProperty(myControl, "Tag") = hResult["IDProdVar"] Then
          Object.SetProperty(myControl, "Text", hResult["Costo Extra"])
        Endif
      Next
    Next
  Endif

End

Public Sub btnGuardar_Click()

Dim myControl As Control
Dim myText, myCheck As Control
Dim myContainer As HBox
Dim myCosto As Float
Dim hResultOper, hResultTemp As Result

  If Message.Question("Desea guardar los cambios hechos?", "Si, Guardar", "No, Me espero...") = 1 Then
    For Each myControl In VBoxCheck1.Children
      If Object.GetProperty(myControl, "Value") = True Then
        sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1  and `id_tipo_precio` = &2;"
        Try hResultTemp = modVariables.c_Conn.Exec(sQuery, Object.GetProperty(myControl, "Tag"), cmbTiposPRecios.Index + 1)
        hResultOper = Null
        If hResultTemp.Available And hResultTemp <> Null Then
          'Case "Update"
          sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
          modVariables.c_Conn.Begin()
          hResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, Object.GetProperty(myControl, "Tag"), cmbTiposPRecios.Index + 1)
        Else
          modVariables.c_Conn.Begin()
          hResultOper = modVariables.c_Conn.Create("tbl_costos_extra_var_prod")
          hResultOper!id_producto_variante = Object.GetProperty(myControl, "Tag")
          hResultOper!id_tipo_precio = cmbTiposPRecios.Index + 1
          'Case "Modificar"
        Endif
        
        For Each myText In vBoxText1.Children
          If Object.GetProperty(myText, "Tag") = Object.GetProperty(myControl, "Tag") Then
            hResultOper!fl_costo_extra = Object.GetProperty(myText, "Text")
          Endif
        Next
        hResultOper!id_fecha_control = myControlFecha
        hResultOper.Update()
        modVariables.c_Conn.Commit()
        hResultOper = Null
      Endif
    Next
    
    For Each myControl In VBoxCheck2.Children
      If Object.GetProperty(myControl, "Value") = True Then
        sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1  and `id_tipo_precio` = &2;"
        Try hResultTemp = modVariables.c_Conn.Exec(sQuery, Object.GetProperty(myControl, "Tag"), cmbTiposPRecios.Index + 1)
        hResultOper = Null
        If hResultTemp.Available And hResultTemp <> Null Then
          'Case "Update"
          sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
          modVariables.c_Conn.Begin()
          hResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, Object.GetProperty(myControl, "Tag"), cmbTiposPRecios.Index + 1)
        Else
          modVariables.c_Conn.Begin()
          hResultOper = modVariables.c_Conn.Create("tbl_costos_extra_var_prod")
          hResultOper!id_producto_variante = Object.GetProperty(myControl, "Tag")
          hResultOper!id_tipo_precio = cmbTiposPRecios.Index + 1
          'Case "Modificar"
        Endif
        
        For Each myText In vBoxText2.Children
          If Object.GetProperty(myText, "Tag") = Object.GetProperty(myControl, "Tag") Then
            hResultOper!fl_costo_extra = Object.GetProperty(myText, "Text")
          Endif
        Next
        hResultOper!id_fecha_control = myControlFecha
        hResultOper.Update()
        modVariables.c_Conn.Commit()
        hResultOper = Null
      Endif
    Next
    
    For Each myControl In VBoxCheck3.Children
      If Object.GetProperty(myControl, "Value") = True Then
        sQuery = "SELECT * FROM `tbl_costos_extra_var_prod` where `id_producto_variante` = &1  and `id_tipo_precio` = &2;"
        Try hResultTemp = modVariables.c_Conn.Exec(sQuery, Object.GetProperty(myControl, "Tag"), cmbTiposPRecios.Index + 1)
        hResultOper = Null
        If hResultTemp.Available And hResultTemp <> Null Then
          'Case "Update"
          sQuery = "`id_producto_variante` = &1 and `id_tipo_precio` = &2"
          modVariables.c_Conn.Begin()
          hResultOper = modVariables.c_Conn.Edit("tbl_costos_extra_var_prod", sQuery, Object.GetProperty(myControl, "Tag"), cmbTiposPRecios.Index + 1)
        Else
          modVariables.c_Conn.Begin()
          hResultOper = modVariables.c_Conn.Create("tbl_costos_extra_var_prod")
          hResultOper!id_producto_variante = Object.GetProperty(myControl, "Tag")
          hResultOper!id_tipo_precio = cmbTiposPRecios.Index + 1
          'Case "Modificar"
        Endif
        
        For Each myText In vBoxText3.Children
          If Object.GetProperty(myText, "Tag") = Object.GetProperty(myControl, "Tag") Then
            hResultOper!fl_costo_extra = Object.GetProperty(myText, "Text")
          Endif
        Next
        hResultOper!id_fecha_control = myControlFecha
        hResultOper.Update()
        modVariables.c_Conn.Commit()
        hResultOper = Null
      Endif
    Next

    myControl = Null
    hResultTemp = Null
    hResultOper = Null
    
    For Each myContainer In VBoxTipoCostos.Children
      For Each myCheck In myContainer.Children
        If Object.Is(myCheck, "CheckBox") = True Then 'See if control is checkbox
          If Object.GetProperty(myCheck, "Value") = True Then 'Price checked, update it
            For Each myText In myContainer.Children 'look for textbox in container
              If Object.Is(myText, "TextBox") = True Then 'Found one!
                If Object.GetProperty(myText, "Text") <> "" Then 'There is some text there
                  sQuery = "SELECT * FROM `tbl_precios_productos` where `id_producto` = &1 and `bit_activo` = 1 order by `int_tipo_precio`;"
                  Try hResultTemp = modVariables.c_Conn.Exec(sQuery, myIDProd)
                  If hResultTemp <> Null And hResultTemp.Available Then
                    For Each hResultTemp
                      If hResultTemp["int_tipo_precio"] = Object.GetProperty(myCheck, "Text") Then
                        hResult = Null
                        sQuery = "SELECT * FROM `tbl_precios_productos` where `id_precio` = &1"
                        Try hResult = modVariables.c_Conn.Exec(sQuery, CInt(Object.GetProperty(myText, "Tag")))
                        'deactivate previously active prices for this product
                        If hResult.Available Then
                          For Each hResult
                            sQuery = "UPDATE `tbl_precios_productos` SET "
                            sQuery &= "`bit_activo` = 0 "
                            sQuery &= "where `id_precio` = &1;"
                            'Print sQuery
                            modVariables.c_Conn.Exec(sQuery, hResultTemp["id_precio"])
                          Next
                        Endif
                        modVariables.c_Conn.Begin()
                        hResultOper = modVariables.c_Conn.Create("tbl_precios_productos")
                        hResultOper!id_producto = myIDProd
                        hResultOper!dbl_precio = Object.GetProperty(myText, "Text")
                        hResultOper!int_tipo_precio = hResultTemp["int_tipo_precio"]
                        hResultOper!bit_activo = 1
                        hResultOper!dat_fecha_precio_activo = Now()
                        hResultOper.Update()
                        modVariables.c_Conn.Commit()
                        hResultOper = Null
                      Endif
                    Next
                  Endif
                Else
                  Message.Error("Introduzca un precio por favor")
                  Object.Call(myText, "getFocus")
                  Return
                Endif
              Endif
            Next
          Endif
        Endif
      Next
    Next
  Endif

Catch
  Message.Error(Error.Text)
  
End

Public Sub btnCerrar_Click()

  Me.Close()

End
