' Gambas class file

Private sQueryString As String
Private rsRecords As Result
Private rsInsumos As Result
Private rsInventario As Result
Private iControlFechaStart As Integer
Private iControlFechaEnd As Integer
Private sHTML As String

'Impresion de tickets y reportes
Private rYPrint As Integer
Private Const PRINT_MARGIN As Float = 5

Public Sub Form_Open()

  gridReportIzq.header = GridView.Horizontal
  gridReportIzq.grid = True
  gridReportIzq.Rows.count = 0
  gridReportIzq.Columns.count = 11
  gridReportIzq.Columns[0].text = "ID Orden"
  gridReportIzq.Columns[1].text = "TicketNR"
  gridReportIzq.Columns[2].text = "Comanda"
  gridReportIzq.Columns[3].text = "Fecha y Hora"
  gridReportIzq.Columns[4].text = "Total"
  gridReportIzq.Columns[5].text = "Mesa"
  gridReportIzq.Columns[6].text = "Estado"
  gridReportIzq.Columns[7].text = "Referencia"
  gridReportIzq.Columns[8].text = "Control Fecha"
  gridReportIzq.Columns[9].text = "Indexed"
  gridReportIzq.Columns[10].text = "Tipo Pago"
  
  gridReportIzq.Columns[0].width = 80
  gridReportIzq.Columns[1].width = 80
  gridReportIzq.Columns[2].width = 80
  gridReportIzq.Columns[3].width = 180
  gridReportIzq.Columns[4].width = 100
  gridReportIzq.Columns[5].width = 100
  gridReportIzq.Columns[6].width = 100
  gridReportIzq.Columns[8].width = 60
  gridReportIzq.Columns[9].width = 0
  gridReportIzq.Columns[10].width = 150
  
  
  gridReportMesero.Header = GridView.Horizontal
  gridReportMesero.Grid = True
  gridReportMesero.Rows.count = 0
  gridReportMesero.Columns.count = 12
  gridReportMesero.Columns[0].Text = "ID Orden"
  gridReportMesero.Columns[1].Text = "TicketNR"
  gridReportMesero.Columns[2].Text = "Comanda"
  gridReportMesero.Columns[3].Text = "Fecha y Hora"
  gridReportMesero.Columns[4].Text = "Total"
  gridReportMesero.Columns[5].Text = "Mesa"
  gridReportMesero.Columns[6].Text = "Estado"
  gridReportMesero.Columns[7].Text = "Referencia"
  gridReportMesero.Columns[8].Text = "Control Fecha"
  gridReportMesero.Columns[9].Text = "Indexed"
  gridReportMesero.Columns[10].Text = "Tipo Pago"
  
  DateChooser1.MinValue = modVariables._cnnComienzoLabores
  dtFechaInicio.MinValue = modVariables._cnnComienzoLabores
  dtFechaFinal.MinValue = modVariables._cnnComienzoLabores
  DateChooser4.MinValue = modVariables._cnnComienzoLabores
  DateChooser5.MinValue = modVariables._cnnComienzoLabores
  DateChooser6.MinValue = modVariables._cnnComienzoLabores
  
  
  sQueryString = "SELECT * fom vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2;" 
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString, modVariables.i_idControlFecha, modVariables.i_idControlFecha)
  gridReportIzq.Rows.Count = 0
  If (rsRecords <> Null) Then gridReportIzq.Rows.Count = rsRecords.Count
  
End


Public Sub radioFechaUnica_Click()

  frmFechaUnica.Visible = radioFechaUnica.Value
  frmFechaRango.Visible = Not radioFechaUnica.Value

End

Public Sub radioFechaRango_Click()

  frmFechaRango.Visible = radioFechaRango.Value
  frmFechaUnica.Visible = Not radioFechaRango.Value

End

Public Sub Button2_Click()

  If (Message.Question("¿En verdad desea Salir?", "Sí, Salir", "No")) = 1 Then 
    Me.Close
  Endif

End


Public Sub btnGeneraUnica_Click()

  Dim tempContents As String

  If radioFechaUnica.value = True Then 
    tempContents = generaHTMLVentas(iControlFechaStart)
  Else
    tempContents = generaHTMLVentas(iControlFechaStart, iControlFechaEnd)
  Endif
  
  'Print tempContents
  Dialog.Filter = ["*.xls", "Hoja de Cálculo Excel"]
  
  If Dialog.SaveFile() Then Return
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  File.Save(Dialog.Path, tempContents)

Catch
    Message.Info(Error.Text & ", " & Error.Where)
    btnGeneraUnica.Enabled = False
    
End

Public Function generaHTMLVentas(fechaInicio As Integer, Optional fechaFinal As Integer) As String
  
  Dim tempHTML, sTableHeaders As String
  Dim iInt As Integer
  Dim jInt As Integer
  Dim sQuery As String
  Dim rResult As Result
  Dim rResultSuma As Result
  
  tempHTML = "<body><table>" & gb.CrLf
  tempHTML &= "<Tr><td colspan=\"14\">Reporte de ventas</td>" & gb.CrLf
  tempHTML &= "</tr>" & gb.CrLf
  
  If fechaFinal <> 0 Then
    
    tempHTML &= "<Tr><td colspan=\"" & rsRecords.Fields.Count & "\">Reporte de Ventas por mesero, del periodo:</td><td>" 
    tempHTML &= "<tr><td colspan=\"5\">" & Format(dtFechaInicio.Value, "dddd dd mmmm yyyy, hh:nn:ss") & " </td><td>al</td><td colspan=\"8\">" & Format(dtFechaFinal.Value, "dddd dd mmmm yyyy, hh:nn:ss") & "</td></tr>"
    jInt = iInt + 9
  Else
    tempHTML &= "<Tr><td colspan=\"8\">Reporte de Ventas por mesero del dia:</td><td colspan=\"6\">" & Format(dtFechaInicio.Value, "dddd dd mmmm yyyy, hh:nn:ss") & "</td>"
    jInt = iInt + 8
  Endif
  
  rsRecords.MoveFirst
  
  If (rsRecords <> Null) And rsRecords.Available Then
    For Each rsRecords
      tempHTML &= sTableHeaders
      jInt += 1

      Inc jInt
      rResult = Null
      sQuery = "SELECT"
      sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`int_orden_id`) AS `Orden`," 
      sQuery &= "        ANY_VALUE(`tbl_ordenes`.`int_nr_comanda`) as `Comanda`," 
      sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`id_prod_x_orden`) AS `IDPO`,"
      sQuery &= "        ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`," 
      sQuery &= "        ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
      sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`) AS `Cantidad`,"
      sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`," 
      sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio` * `tbl_prods_x_orden`.`int_cantidad`) AS `Subtotal`," 
      sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
      sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
      sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`id_control_fecha`) AS `Control Fecha`,"
      sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`bool_activo`) AS `Activo`," 
      sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `Tipo Pago`,"
      sQuery &= "        ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`" 
      sQuery &= "    From "
      sQuery &= "        `tbl_ordenes_cerradas`"
      sQuery &= "      LEFT JOIN `tbl_prods_x_orden` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_ordenes_cerradas`.`id_orden_id`"
      sQuery &= "      LEFT JOIN `tbl_ordenes` ON `tbl_ordenes`.`id_orden_id` = `tbl_ordenes_cerradas`.`id_orden_id`"
      sQuery &= "      LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
      sQuery &= "      LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
      sQuery &= "      LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
      sQuery &= "      LEFT JOIN `tbl_precios_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`"
      sQuery &= "         And `tbl_prods_x_orden`.`int_tipo_precio` = `tbl_precios_productos`.`int_tipo_precio`"
      sQuery &= "      WHERE "
      sQuery &= "            `tbl_productos`.`int_activo` = 1" 
      sQuery &= "            And `tbl_precios_productos`.`bit_activo` = 1" 
      sQuery &= "            And `tbl_prods_x_orden`.`int_orden_id` = &1"
      sQuery &= "            order by `Tipo Precio`"
      
      Try rResult = modVariables.c_Conn.Exec(sQuery, rsRecords["ID Orden"])

      If (rResult <> Null) And (rResult.Available) Then
        sTableHeaders = "<tr>"
        For jInt = 0 To rResult.Fields.Count - 1
          sTableHeaders &= "<td>" & rResult.Fields[jInt].Name & "</td>"
        Next
        sTableHeaders &= "</tr>"
        tempHTML &= sTableHeaders
        For Each rResult
          tempHTML &= "<tr>" 
          For jInt = 0 To rsRecords.Fields.Count - 1
            tempHTML &= "<td>" & rResult[jInt] & "</td>"
          Next
          tempHTML &= "</tr>"
          Inc jInt
        Next
        tempHTML &= "<tr>"
      Endif
    Next 
    Endif
  tempHTML &= "<Tr><td colspan=\"" & CStr(jInt + 1) & "\">&nbsp;</td></tr>"
  tempHTML &= "</table>"
  'Endif '
  
  Inc jInt
  '===Inventarios e Insumos utilizados
  'Primero, sacamos el listado de los insumos posibles
  sQueryString = "SELECT * FROM `tbl_insumos` where `bit_activo` = 1 order by `id_insumo`"
  Try rResult = modVariables.c_Conn.Exec(sQueryString)
  
  If (rResult <> Null) And rResult.Available Then
    tempHTML &= "<table>"
    If fechaFinal <> Null Then
      tempHTML &= "<Tr><td colspan=\"4\">Reporte de Insumos usados, e Inventarios del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & dtFechaInicio.Value & " </td><td>al</td><td>" & dtFechaFinal.Value & "</td></tr>"
      jInt = iInt + 14
    Else
      tempHTML &= "<Tr><td colspan=\"4\">Reporte de Insumos usados, e Inventarios del dia:</td><td>" & Format(dtFechaInicio.Value, "yyyy-mm-dd") & "</td>"
      jInt = iInt + 13
    Endif
    tempHTML &= "</tr>"
    tempHTML &= "<Tr><td width='250'>Nombre</td>"
    tempHTML &= "<td>Inicio de periodo</td>"
    tempHTML &= "<td>Utilizados</td>"
    tempHTML &= "</tr>"
    
    Inc jInt
    
    For Each rResult
      If fechaFinal <> 0 Then
        sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and `Control Fecha` >= &2 And `Control Fecha` <= &3"
        Try rResultSuma = modVariables.c_Conn.Exec(sQuerystring, rResult["id_insumo"], fechaInicio, fechaFinal)
        sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and `id_control_fecha` >= &2 And `id_control_fecha` <= &3"
        Try rsInventario = modVariables.c_Conn.Exec(sQueryString, rResult["id_insumo"], fechaInicio, fechaFinal)
      Else
        sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and `Control Fecha` = &2"
        Try rResultSuma = modVariables.c_Conn.Exec(sQuerystring, rResult["id_insumo"], fechaInicio)
        sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and `id_control_fecha` = &2"
        Try rsInventario = modVariables.c_Conn.Exec(sQueryString, rResult["id_insumo"], fechaInicio)
      Endif
      
      If (rResultSuma[0] <> Null) Then
        tempHTML &= "<tr>"
        tempHTML &= "<td>" & rResult["chr_nombre_insumo"] & "</td>"
        If (rsInventario <> Null) And (rsInventario[0] <> Null) Then 
          tempHTML &= "<td>" & rsInventario[0] & "</td>"
        Else
          tempHTML &= "<td>0</td>"
        Endif
        tempHTML &= "<td>" & rResultSuma[0] & "</td>"
        tempHTML &= "</tr>"
        Inc jInt
        rResultSuma = Null
        rsInventario = Null
      Endif
    Next
    tempHTML &= "</table>"
  Endif
  
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  
  rResult = Null
  
  sQueryString = "SELECT * FROM  tbl_gastos where `dt_horafecha` >= &1 and `dt_horafecha` <= &2 order by `dt_horafecha` Asc"
  Try rResult = modVariables.c_Conn.Exec(sQueryString, fechaInicio, fechaFinal)
  If (rResult <> Null) And rResult.Available Then
    tempHTML &= "<table>"
    If fechaFinal <> 0 Then
      tempHTML &= "<Tr><td colspan=\"5\">Reporte de gastos del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & fechaInicio & " </td><td>al</td><td>" & fechaFinal & "</td></tr>"
      jInt = iInt + 9
    Else
      tempHTML &= "<Tr><td colspan=\"3\">Reporte de Gastos del dia:</td><td>" & fechaInicio & "</td>"
      jInt = iInt + 8
    Endif
    tempHTML &= "<tr>"
    tempHTML &= "<td>Hora/Fecha</td>"
    tempHTML &= "<td>Cantidad</td>"
   tempHTML &= "<td>Concepto</td>"
    
    For Each rResult
      tempHTML &= "<tr>"
      tempHTML &= "<td>" & rResult["dt_horafecha"] & "</td>"
      tempHTML &= "<td>$" & rResult["fl_cantidad"] & "</td>"
      tempHTML &= "<td>" & rResult["chr_concepto_gasto"] & "</td>"
      tempHTML &= "<td></td></tr>"
    Next
    tempHTML &= "</table>"
  Endif  
  
  tempHTML &= "</body>"

  'Print tempHTML
  Return tempHTML

Catch 
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub gridReportIzq_Data(Row As Integer, Column As Integer)
  
  If (rsRecords <> Null) Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportIzq.Data.Text = Str(rsRecords[Column])
    Endif
  Endif

Catch 
  
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnBuscar_MouseUp()

Dim sQueryInsumos As String
Dim sQueryInventario As String
Dim hResult As Result
'Dim iControlF As Integer
'Dim iInc As Integer

  rsRecords = Null
  rsInsumos = Null
  rsInventario = Null
    
  If radioFechaUnica.Value = True Then
    modVariables._cnnFechaInicio = DateChooser1.Value
    modVariables._cnnFechaFinal = DateChooser1.Value
  Else
    modVariables._cnnFechaInicio = dtFechaInicio.Value
    modVariables._cnnFechaFinal = dtFechaFinal.Value
  Endif
  
  sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_fecha_calendario`) >= DATE(&1) and Date(`dt_fecha_calendario`) <= DATE(&2);"
  'Print sQueryString
  Try hResult = modVariables.c_Conn.Exec(sQueryString, Format(modVariables._cnnFechaInicio, "yyyy-mm-dd"), Format(modVariables._cnnFechaFinal, "yyyy-mm-dd"))

  If (hResult <> Null) And hResult.Available Then
    iControlFechaStart = hResult["id_control_fechas"]
    hResult.MoveLast
    iControlFechaEnd = hResult["id_control_fechas"]
  Else
    Message.Info("No se han encontrado registros")
    Return
  Endif
  
  If Mouse.Control Then
    'sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2;"
  Else
    'sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2 and `Indexed` = '1';"
  Endif

  sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where `Control Fecha` >= &1 AND `Control Fecha` <= &2 order by HoraFecha ASC"
  sQueryInventario = "SELECT * FROM `tbl_inventario` where id_control_fecha >= &1 AND id_control_fecha <= &2 and order by dt_fecha_insumo ASC"
  rsRecords = Null
  rsInsumos = Null
  rsInventario = Null
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString, iControlFechaStart, iControlFechaEnd)
  Try rsInsumos = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  Try rsInventario = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  
  If (rsRecords <> Null) And rsRecords.Available Then
    gridReportIzq.Rows.Count = 0
    gridReportIzq.Rows.Count = rsRecords.Count
    Label4.Text = "Se han encontrado " & rsRecords.Count & " ordenes cerradas"
    'GridView1.Refresh
    btnGeneraUnica.Enabled = True
    btnGeneraCuenta.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica.Enabled = False
    btnGeneraCuenta.Enabled = False
    Label4.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)

End

Public Sub btnBuscarMesero_Click()

Dim sQuery As String
'Dim sQueryInventario As String
Dim hResult As Result

  rsRecords = Null
    
  If radioFechaUnica2.Value = True Then
    modVariables._cnnFechaInicio = DateChooser4.Value
    modVariables._cnnFechaFinal = DateChooser4.Value    
  Else
    modVariables._cnnFechaInicio = DateChooser5.Value
    modVariables._cnnFechaFinal = DateChooser6.Value
    
  Endif
  
  hResult = Null
  sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_fecha_calendario`) >= DATE(&1) and Date(`dt_fecha_calendario`) <= DATE(&2);"
  Try hResult = modVariables.c_Conn.Exec(sQueryString, Format(modVariables._cnnFechaInicio, "yyyy-mm-dd"), Format(modVariables._cnnFechaFinal, "yyyy-mm-dd"))

  If (hResult <> Null) And hResult.Available Then
    iControlFechaStart = hResult["id_control_fechas"]
    hResult.MoveLast
    iControlFechaEnd = hResult["id_control_fechas"]
  Else
    Message.Info("No se han encontrado registros")
    Return
  Endif
  
  hResult = Null
  
    sQuery = "SELECT  ANY_VALUE(SUM(`tbl_prods_x_orden`.`int_cantidad`*`tbl_precios_productos`.`dbl_precio`)) as `Total`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
    sQuery &= "        SUM(ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`)) AS `Cantidad`,"
    sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`,"
    sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
    sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
    sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `ID TPago`,"
    sQuery &= "        ANY_VALUE( `tbl_formas_pago`.`chr_forma_pago`) AS `Tipo Pago`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`"
    sQuery &= "        From"
    sQuery &= "        `tbl_prods_x_orden`"
    sQuery &= "        LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
    sQuery &= "        LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
    sQuery &= "        LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
    sQuery &= "        LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id`"
    sQuery &= "        left join `tbl_formas_pago` ON `tbl_ordenes_cerradas`.`int_forma_pago` = `tbl_formas_pago`.`id_forma_pago`"
    sQuery &= "        LEFT JOIN `tbl_precios_productos` ON (((`tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`)"
    sQuery &= "            And ( `tbl_precios_productos`.`int_tipo_precio` = 1)))"
    sQuery &= "        WHERE" 
    sQuery &= "        `tbl_productos`.`int_activo` = 1" 
    sQuery &= "            And `tbl_prods_x_orden`.`bool_activo` = '1'"  
    sQuery &= "            And `tbl_precios_productos`.`bit_activo` = 1" 
    sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` >= &1" 
    sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` <= &2" 
    sQuery &= "            And `tbl_tipos_precios`.`id_tipo_precio` = 3"
    sQuery &= "         group BY `ID Prod`, `Tipo Precio`, `ID TPago`"
    sQuery &= "         order by `Tipo Precio`, `ID TPago`, `Ordenar`"
    
  Try rsRecords = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)

  If rsRecords.Available Then
    gridReportMesero.Rows.Count = 0
    gridReportMesero.Rows.Count = rsRecords.Count
    Label4.Text = "Se han encontrado " & rsRecords.Count & " movimientos"
    gridReportMesero.Refresh
    btnGeneraUnica2.Enabled = True
    'btnGeneraCuenta2.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica2.Enabled = False
    'btnGeneraCuenta2.Enabled = False
    Label4.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)

End

Public Sub gridReportMesero_Data(Row As Integer, Column As Integer)

  If (rsRecords <> Null) Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportMesero.Data.Text = Str(rsRecords[Column])
      If Error Then Print Error.Text & ", " & Error.Where
    Endif
  Endif

End


Public Sub radioFechaRango2_Click()

  frmFechaUnica2.Visible = radioFechaUnica2.Value
  frmFechaRango2.Visible = Not radioFechaUnica2.Value

End

Public Sub radioFechaUnica2_Click()

  frmFechaUnica2.Visible = radioFechaUnica2.Value
  frmFechaRango2.Visible = Not radioFechaUnica2.Value

End

Public Sub DateChooser4_Click()

  If DateChooser4.Value > 0 Then btnBuscarMesero.Enabled = True

End

Public Sub DateChooser5_Click()

  If DateChooser5.Value > 0 Then btnBuscarMesero.Enabled = True

End

Public Sub DateChooser6_Click()

  If DateChooser6.Value > 0 Then btnBuscarMesero.Enabled = True

End


Public Sub btnGeneraCuenta_Click()

Dim sTempFile, sFileName, sFinalFile, sPath, sCopyPath, sCommand, sFileManager As String
Dim sExcelFilePath As String
Dim iPaginas, iInc As Integer

  Me.Enabled = False
  Inc Application.Busy
  
  sFileName = Format(Now, "yyyy-mm-dd_hh:nn:ss")
  sFinalFile = modVariables.sPrefijoDB & "-" & sFileName
  sPath = User.Home &/ "Tickets/Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "mm") &/ Format(Now, "dd")
  
  If Not Exist(sPath) Then modUtils.CreateDirTree(sPath)
  sFileName = "cuenta_" & sFinalFile & ".pdf"
  sTempFile = sPath &/ sFileName
  
  PrinterCuenta.PaperWidth = 80
  PrinterCuenta.Count = 1
  
  PrinterCuenta.PaperHeight = 1600
  
  PrinterCuenta.OutputFile = sTempFile
  PrinterCuenta.Print() 
    
  sCopyPath = User.Home &/ "Dropbox/2020/Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "mm") &/ Format(Now, "dd")
  
  If Not Exist(sCopyPath) Then modUtils.CreateDirTree(sCopyPath)
  
  If Exist(sTempFile) Then Copy sTempFile To sCopyPath & "/" & sFileName
  Wait
  
  sExcelFilePath = sCopyPath & "/" & sFileName & ".html"
  
  File.Save(sExcelFilePath, sHtML)
  'sCommand = "libreoffice --headless --convert-to pdf " & sExcelFilePath & " --outdir " & sCopyPath & "/"
  sCommand = "lpr " & sTempFile 
  
  Shell sCommand Wait 
  'sCommand = "lpr " & sCopyPath & "/" & sFileName & ".pdf"
  'Shell sCommand Wait 
  'Print tempContents
  Dialog.Filter = ["*.xls", "Hoja de Cálculo Excel"]
  If Exist(User.Home &/ modVariables.sCloudDirectory &/ "Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "mm") &/ Format(Now, "dd")) = False Then 
    modUtils.CreateDirTree(User.Home &/ modVariables.sCloudDirectory &/ "Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "mm") &/ Format(Now, "dd"))
  Endif
  Dialog.Path = User.Home &/ modVariables.sCloudDirectory &/ "Cuentas" &/ modVariables.sPrefijoDB &/ Format(Now, "mm") &/ Format(Now, "dd") & "/"
  If Dialog.SaveFile() Then 
    Dec Application.Busy
    Return
  Endif
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  If Exist(Dialog.Path) Then Kill Dialog.Path
  If Exist(sExcelFilePath) Then Copy sExcelFilePath To Dialog.Path
  Wait 
  
  sCommand = "xdg-mime query default inode/directory" 
  Shell sCommand To sFileManager
  For iInc = 1 To Len(sFileManager)
    If Mid(sFileManager, iInc, 1) = "." Then 
      sFileManager = Left(sFileManager, iInc - 1)
    Endif
  Next
  'Print sFileManager
  
  sCommand = sFileManager & " " & Dialog.Path
  Shell sCommand
  
  sCommand = "xreader " & sCopyPath & "/" & sFileName
  Shell sCommand
  
  'File.Save(Dialog.Path, sHTML)
  'modUtils.doSQLDump()
  
  Me.Enabled = True
  Dec Application.Busy
  

Catch 
  Print Error.Where & ", " & Error.Text
  Message.Error(Error.Where & ", " & Error.Text)

End

Public Sub PrinterCuenta_Draw()

  sHTML = sGeneraCuentaHTML(iControlFechaStart, iControlFechaEnd)
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  Paint.Font = Font["Courier New,10"]
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
End

Public Function sGeneraCuentaHTML(iControlFechaStart As Integer, iControlFechaEnd As Integer) As String
  
  Dim sQuery As String
  Dim hResult, hResultCantidad, hResultPrecio As Result
  Dim sTemporal, sPersonalText, sDelString, sDelSigno, sDetallado As String
  Dim flMyPrice As Float
  Dim iInc, iInd, iIne, iIndexPersonal As Integer
  Dim iCantidadTotal As Integer

  Dim bFound As Boolean
    
  Dim sArray As String[] = Split(File.Load("Templates/cuenta.html"), gb.Newline, "", True)
  
  sHTML = sArray.Join(gb.Newline)
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  sHTML = Replace(sHTML, "@@DiaComienzo@@", Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy"))
  
  If radioFechaRango.Value = True Then
    sHTML = Replace(sHTML, "@@DiaFin@@", "Al dia: " & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy"))
  Else
    sHTML = Replace(sHTML, "@@DiaFin@@", "")
  Endif
    
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)

  sHTML = Replace(sHTML, "@@NombreSuc@@", hResult["chr_nombre"])
  sHTML = Replace(sHTML, "@@DirSuc1@@", hResult["chr_dir1"])
  sHTML = Replace(sHTML, "@@DirSuc2@@", hResult["chr_dir2"])
  sHTML = Replace(sHTML, "@@DirSuc3@@", hResult["chr_dir3"])
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", hResult["chr_telefono1"])
  
  hResult = Null
  
  'get IndexPersonal
  sQuery = "SELECT `chr_var_value` from `tbl_configs` where `chr_var_name` = 'personal_index';"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  iIndexPersonal = CInt(hResult[0])
  hResult = Null
  
  'nombres de grupos para parte del resumen
  sQuery = "SELECT * FROM tbl_grupos_def where bit_activo = 1;"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  iInc = hResult.Count
  
  Dim sGrupo As New String[iInc]
  Dim iCantidadxGrupo As New Integer[iInc]
  Dim flAcumuladoxGrupo As New Float[iInc]
      
  For iInc = 0 To hResult.Count - 1
    sGrupo[iInc] = (hResult["chr_nombre_grupo"])
    hResult.MoveNext
  Next
  
  'Tipo precio
  sQuery = "SELECT * from `tbl_tipos_precios`"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  Dim iTipoPrecios As New Integer[hResult.Count]
  Dim sNombresTiposPrecios As New String[hResult.Count]
  Dim flCobroxTiposPrecios As New Float[hResult.Count, 2] '[TipoPrecio, Activo]

  For iInc = 0 To hResult.Count - 1
    For iInd = 0 To 1
      flCobroxTiposPrecios[iInc, iInd] = 0
    Next
    sNombresTiposPrecios[iInc] = hResult["chr_nombre_precio"]
    iTipoPrecios[iInc] = hResult["id_tipo_precio"]
    If hResult["id_tipo_precio"] = iIndexPersonal Then sPersonalText = CStr(hResult["chr_nombre_precio"])
    hResult.MoveNext
  Next
  
  hResult = Null
  
  'Formas de pago
  sQuery = "SELECT * FROM tbl_formas_pago where int_activo = 1;"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  Dim iFormaPago As New Integer[hResult.Count]
  Dim sNombreFormaPago As New String[hResult.Count]
  Dim flCobroxFormaPago As New Float[hResult.Count, 2] '[FormaPago, Activo]
      
  For iInc = 0 To hResult.Count - 1
    iFormaPago[iInc] = hResult["id_forma_pago"]
    sNombreFormaPago[iInc] = hResult["chr_forma_pago"]
    hResult.MoveNext
  Next
  hResult = Null
  
  'Lista de productos
  sQuery = "SELECT * FROM `tbl_productos` where `int_activo` = 1 order by `fl_ordenar`, `id_producto`"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  Dim iProductos As New Integer[hResult.Count]

  For iInc = 0 To hResult.Count - 1
    iProductos[iInc] = hResult["id_producto"]
    hResult.MoveNext
  Next
  hResult = Null
  
  'get data
  sQuery = "SELECT  "
  sQuery &= "  ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`,"
  sQuery &= "  ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
  sQuery &= "  ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`) AS `Cantidad`,"
  sQuery &= "  ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `ID TPago`,"
  sQuery &= "  ANY_VALUE( `tbl_formas_pago`.`chr_forma_pago`) AS `Tipo Pago`,"
  sQuery &= "  ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`,"
  sQuery &= "  ANY_VALUE( `tbl_productos`.`id_grupo_def`) AS `Grupo`, "
  sQuery &= "  ANY_VALUE( `tbl_grupos_def`.`chr_nombre_grupo`) AS `Agrupar`, "
  sQuery &= "  ANY_VALUE( `tbl_precio_tipo_ordenes`.`id_tipo_precio`) AS `ID Tipo Precio`,"
  sQuery &= "  ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) as `Tipo Precio`,"
  sQuery &= "  ANY_VALUE( `tbl_control_fechas`.`id_control_fechas`) as `IDCF`,"
  sQuery &= "  ANY_VALUE( `tbl_prods_x_orden`.`bool_activo`) AS `Activo`"
  sQuery &= "  From"
  sQuery &= "  `tbl_prods_x_orden`"
  sQuery &= "  LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
  sQuery &= "  LEFT JOIN `tbl_ordenes` ON `tbl_ordenes`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id` " 
  sQuery &= "  LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_ordenes`.`id_orden_id`"
  sQuery &= "  left join `tbl_precio_tipo_ordenes` on `tbl_precio_tipo_ordenes`.`id_orden` = `tbl_ordenes`.`id_orden_id` "
  sQuery &= "  left join `tbl_tipos_precios` on `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
  sQuery &= "  left join `tbl_formas_pago` ON `tbl_ordenes_cerradas`.`int_forma_pago` = `tbl_formas_pago`.`id_forma_pago`"
  sQuery &= "  LEFT JOIN `tbl_control_fechas` on `tbl_control_fechas`.`id_control_fechas` = `tbl_ordenes`.`id_control_fecha`"
  sQuery &= "  left join `tbl_grupos_def` on `tbl_productos`.`id_grupo_def` = `tbl_grupos_def`.`id_grupos_def`"
  sQuery &= "  WHERE "
  sQuery &= "       `tbl_ordenes`.`id_control_fecha` >= &1"
  sQuery &= "       And `tbl_ordenes`.`id_control_fecha` <= &2"
  sQuery &= "        order by `ID Tipo Precio`, `IDCF`, `Ordenar`, `ID TPago`, `Ordenar`"

  Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
  
  If (hResult <> Null) And hResult.Available Then 
    sTemporal = "<tr style=\"width: 80mm;\"><td>Prod.</td><td>Cant.</td><td>Total</td></tr>"
    For Each hResult
      'get Price
      If (hResult["ID Prod"] <> Null) And (hResult["ID Tipo Precio"]) Then
        flMyPrice = modUtils.findPrice(hResult["ID Prod"], hResult["ID Tipo Precio"], iControlFechaStart, iControlFechaEnd)
      Else 
        flMyPrice = 0
      Endif 
      If hResult["Activo"] = "1" Then 
        sDelString = "style= \"font-size: medium;\""
      Else If hResult["Activo"] = "0"
        sDelString = "style= \"font-size: medium; text-decoration: line-through;\""
      Endif
      bFound = False
      For iInc = 0 To sGrupo.Length - 1
        'bFound = False
        If sGrupo[iInc] = hResult["Agrupar"] Then 
          If hResult["Activo"] = 1 Then
            iCantidadxGrupo[iInc] += hResult["Cantidad"]
            flAcumuladoxGrupo[iInc] += flMyPrice * hResult["Cantidad"]
            bFound = True
          Endif
        Endif
        If bFound = True Then Break 
      Next
      iCantidadTotal += hResult["Cantidad"]
    Next
    bFound = False
    'prepare for print general
    For iInc = 0 To sGrupo.Length - 1
      sTemporal &= "<tr style=\"width: 80mm;\"><td " & sDelString & " > " & sGrupo[iInc] & "</td></tr><tr><td align=\"right\"" & sDelString & ">" & gb.CrLf
      sTemporal &= "x " & iCantidadxGrupo[iInc] & "</td><td colspan=\"2\" align=\"left\" " & sDelString & ">&nbsp;$" & flAcumuladoxGrupo[iInc] & ".00</td></tr/>" & gb.CrLf
    Next
    
    sHTML = Replace(sHTML, "@@DetalleResumido@@", sTemporal)
    sHTML = Replace(sHTML, "@@iCantidadTotal@@", CStr(iCantidadTotal))
    
    sTemporal = "<tr style=\"width: 80mm;\"><td colspan =\"4\">Detalle por producto:</td></tr>"
    sTemporal &= "<tr style=\"width: 80mm;\"><td>Prod.</td><td>Cant.</td><td>Tipo Precio</td><td>Total</td></tr>"
    
    'Obtener por forma de pago
    hResult.MoveFirst
    For Each hResult
      bFound = False
      For iInc = 0 To iFormaPago.Length - 1
        If iFormaPago[iInc] = hResult["ID TPago"] Then
          If (hResult["ID Prod"] <> Null) Then
            flMyPrice = modUtils.findPrice(hResult["ID Prod"], 1, iControlFechaStart, iControlFechaEnd)
          Else 
            flMyPrice = 0
          Endif
          flCobroxFormaPago[iInc, hResult["Activo"]] += flMyPrice * hResult["Cantidad"]
          bFound = True
        Endif
        If bFound Then Break
      Next
    Next
   
    'prepare for print detallado
    For iInc = 0 To iTipoPrecios.Length - 1 'Normal o empleado
      For iInd = 0 To iProductos.Length - 1 'Productos
        For iIne = 1 To 0 Step -1 'Activos o inactivos
          hResult = Null
          sQuery = "SELECT  "
          sQuery &= "  ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`,"
          sQuery &= "  ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
          sQuery &= "  sum( `tbl_prods_x_orden`.`int_cantidad`) AS `Cantidad`,"
          sQuery &= "  ANY_VALUE( `tbl_precio_tipo_ordenes`.`id_tipo_precio`) AS `ID Tipo Precio`,"
          sQuery &= "  ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) as `Tipo Precio`,"
          sQuery &= "  ANY_VALUE( `tbl_control_fechas`.`id_control_fechas`) as `IDCF`,"
          sQuery &= "  ANY_VALUE( `tbl_prods_x_orden`.`bool_activo`) AS `Activo`"
          sQuery &= "   From"
          sQuery &= "  `tbl_prods_x_orden`"
          sQuery &= "  LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
          sQuery &= "  LEFT JOIN `tbl_ordenes` ON `tbl_ordenes`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id` " 
          sQuery &= "  LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_ordenes`.`id_orden_id`"
          sQuery &= "  left join `tbl_precio_tipo_ordenes` on `tbl_precio_tipo_ordenes`.`id_orden` = `tbl_ordenes`.`id_orden_id` "
          sQuery &= "  left join `tbl_tipos_precios` on `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
          sQuery &= "  LEFT JOIN `tbl_control_fechas` on `tbl_control_fechas`.`id_control_fechas` = `tbl_ordenes`.`id_control_fecha`"
          sQuery &= "  left join `tbl_grupos_def` on `tbl_productos`.`id_grupo_def` = `tbl_grupos_def`.`id_grupos_def`"
          sQuery &= "  WHERE "
          sQuery &= "  `tbl_prods_x_orden`.`int_producto_id` = &1"
          sQuery &= "  And `tbl_ordenes`.`id_control_fecha` >= &2"
          sQuery &= "      And `tbl_ordenes`.`id_control_fecha` <= &3"
          sQuery &= "       And `tbl_prods_x_orden`.`bool_activo` = &4"
          sQuery &= "       And `tbl_precio_tipo_ordenes`.`id_tipo_precio` = &5"
          
          Try hResult = modVariables.c_Conn.Exec(sQuery, iProductos[iInd], iControlFechaStart, iControlFechaEnd, iIne, iTipoPrecios[iInc])
          
          If (hResult <> Null) And hResult.Available Then 
            If (hResult["Cantidad"] <> Null) Then
              flMyPrice = modUtils.findPrice(iProductos[iInd], 1, iControlFechaStart, iControlFechaEnd)
              If iIne = 1 Then 
                sDelSigno = " +"
                sDelString = "style= \"font-size: medium;\""
              Else If iIne = 0
                sDelSigno = " -"
                sDelString = "style= \"font-size: medium; text-decoration: line-through;\""
              Endif
              sTemporal &= "<tr style=\"width: 80mm;\"><td width=\"33%\" " & sDelString & " > " & hResult["Producto"] & " </td><td width=\"12%\" align=\"left\" " & sDelString & ">" & gb.CrLf
              sTemporal &= sDelSigno & hResult["Cantidad"] & "</td><td width=\"20%\" align=\"right\" " & sDelString & ">" & sNombresTiposPrecios[iInc] & "</td><td align=\"right\" " & sDelString & "> $" & CStr(flMyPrice * CFloat(hResult["Cantidad"])) & ".00</td></tr/>"
              
              flCobroxTiposPrecios[iInc, iIne] += flMyPrice * CFloat(hResult["Cantidad"])
              
            Endif 
          Endif
          hResult = Null
        Next
      Next
    Next
    
    sHTML = Replace(sHTML, "@@Detalle@@", sTemporal)
    'File.Save(User.home &/ "temp/myfile.html", sHTML)
    hResult = Null
    sTemporal = "<span>"

    sTemporal &= "<br/>Por forma de pago:<br/>" & gb.CrLf
    For iInc = 0 To iFormaPago.Length - 1
      For iInd = 1 To 0 Step -1
        Select Case iInd
          Case 0
            sDetallado = " (Borrado) "
          Case 1
            sDetallado = ""
        End Select
        If flCobroxFormaPago[iInc, iInd] <> 0 Then 
          sTemporal &= sNombreFormaPago[iInc] & sDetallado & ": $" & flCobroxFormaPago[iInc, iInd] & ".00<br/>" & gb.CrLf
          If iInc = 0 Then 
            'obtiene descuentos
            sQuery = "SELECT sum(`fl_total`) from tbl_ordenes_cerradas where id_control_fecha >= &1 and id_control_fecha <= &2 and int_forma_pago = 2"
            Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
            If (hResult[0] <> Null) And hResult.Available Then
              sHTML = Replace(sHTML, "@@Descuento@@", "Descuentos: $" & CStr(flCobroxFormaPago[iInc, iInd] - hResult[0]) & ".00")
            Else
              sHTML = Replace(sHTML, "@@Descuento@@", "Descuentos: $0.00")
            Endif
          Endif
        Else 
          sTemporal &= sNombreFormaPago[iInc] & sDetallado & ": $0.00<br/>" & gb.CrLf
        Endif
        
      Next
    Next
    
    sTemporal &= "<br/><br/>Por Tipo de Precio:<br/>" & gb.CrLf
    
    For iInc = 0 To iTipoPrecios.Length - 1
      'flCobroxTiposPrecios[iInc, hResult["Activo"]]
      For iInd = 1 To 0 Step -1
        Select Case iInd
          Case 0
            sDetallado = " (Borrado) "
          Case 1
            sDetallado = ""
        End Select
        If flCobroxTiposPrecios[iInc, iInd] <> 0 Then 
          sTemporal &= sNombresTiposPrecios[iInc] & sDetallado & ": $" & flCobroxTiposPrecios[iInc, iInd] & ".00<br/>" & gb.CrLf
        Else 
          sTemporal &= sNombresTiposPrecios[iInc] & sDetallado & ": $0.00<br/>" & gb.CrLf
        Endif
      Next   
    Next
    
    sTemporal &= "</span>"
    sHTML = Replace(sHTML, "@@Acumulado@@", sTemporal)
    
  Else 
    sHTML = Replace(sHTML, "@@Detalle@@", "SIN MOVIMIENTOS PARA ESTA FECHA")
  Endif
    
  hResult = Null
  hResultCantidad = Null
  hResultPrecio = Null
  
  Return sHTML
  
Catch
  Print Error.Where & "- " & Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
  
End


