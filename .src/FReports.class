' Gambas class file

Private sQueryString As String
Private rsRecords As Result
Private rsInsumos As Result
Private rsInventario As Result
Private rsCuenta As Result
Private rsVentaProductos As Result
Private iControlFecha As Integer
Private iControlFechaStart As Integer
Private iControlFechaEnd As Integer

'Impresion de tickets y  reportes
Private rYPrint As Integer
Private docV As New String[2]
Private Const PRINT_MARGIN As Float = 1

Private hResultControlFechas As Result


Public Sub Form_Open()


  gridReportIzq.header = GridView.Horizontal
  gridReportIzq.grid = True
  gridReportIzq.Rows.count = 0
  gridReportIzq.Columns.count = 5
  gridReportIzq.Columns[0].text = "ID Orden"
  gridReportIzq.Columns[1].text = "Fecha y Hora"
  gridReportIzq.Columns[2].text = "Total"
  gridReportIzq.Columns[3].text = "Factura"
  gridReportIzq.Columns[4].text = "Referencia"

  gridReportIzq.Columns[0].width = 80
  gridReportIzq.Columns[1].width = 50
  gridReportIzq.Columns[2].width = 300
  gridReportIzq.Columns[3].width = 150
  gridReportIzq.Columns[4].width = 100

  sQueryString = "SELECT id_orden_id as `ID Orden`, dt_horafecha_cierre_orden as `Fecha y Hora`, fl_total as `Total`, bool_factura as `Factura`, chr_referencia_notas as `Referencia` FROM `tbl_ordenes_cerradas` "
    
  sQueryString &= "where `int_lvl_report` = 1 order by `dt_horafecha_cierre_orden` Asc"
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString)
  gridReportIzq.Rows.Count = 0
  gridReportIzq.Rows.Count = rsRecords.Count
  
End


Public Sub radioFechaUnica_Click()

  frmFechaUnica.Visible = radioFechaUnica.Value
  frmFechaRango.Visible = Not radioFechaUnica.Value

End

Public Sub radioFechaRango_Click()

  frmFechaRango.Visible = radioFechaRango.Value
  frmFechaUnica.Visible = Not radioFechaRango.Value

End

Public Sub Button2_Click()

  If (Message.Question("¿En verdad desea Salir?", "Sí, Salir", "No")) = 1 Then 
  
  Me.Close
  Endif

End


Public Sub btnGeneraUnica_Click()

  Dim tempContents As String
  
  'hFile = Open User.Home & "/reporteTemp.xls" For Write Create
  If radioFechaUnica.value = True Then 
    tempContents = generaHTMLVentas(iControlFecha)
  Else
    tempContents = generaHTMLVentas(iControlFechaStart, iControlFechaEnd)
  Endif
  
  'Print #hFile, tempContents
  Print tempContents
  
  Dialog.Filter = ["*.xls", "Hoja de Cálculo Excel"]
  
  
  If Dialog.SaveFile() Then Return
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  File.Save(Dialog.Path, tempContents)
  Catch
    Message.Info(Error.Text & ", " & Error.Where)
  
  'hFile.Close
  
  btnGeneraUnica.Enabled = False

End

Public Function generaHTMLVentas(fechaInicio As Integer, Optional fechaFinal As Integer) As String
  
  Dim tempHTML As String
  Dim iInt As Integer
  Dim jInt As Integer
  Dim sQueryString As String
  Dim rResult As Result
  Dim rResultSuma As Result
  
  tempHTML = "<body><table>" 
  tempHTML &= "<Tr><td colspan=6>Reporte de ventas</td>"
  tempHTML &= "</tr>"
  tempHTML &= "<Tr width='0'><td>ID</td>"
'  tempHTML &= "<td>Orden Nr.</td>"
  tempHTML &= "<td>Fecha y Hora</td>"
  tempHTML &= "<td>Total $</td>"
  tempHTML &= "<td width='80'>Factura</td>"
  tempHTML &= "<td width='200'>Referencia</td>"
  tempHTML &= "</tr>"
  
  For iInt = 0 To rsRecords.Count - 1
    rsRecords.MoveTo(iInt)
    tempHTML &= "<tr>"
    For jInt = 0 To rsRecords.Fields.Count - 1
      tempHTML &= "<td>" & rsRecords[jInt] & "</td>"
    Next
    tempHTML &= "</tr>"
  Next
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "</table>"
  
  tempHTML &= "<table>"
  
  If fechaFinal <> 0 Then
    tempHTML &= "<Tr><td colspan=5>Reporte de Ventas por mesero, del periodo:</td><td>" 
    tempHTML &= "<tr><td>&nbsp;</td><td>" & Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy, hh:nn:ss") & " </td><td>al</td><td>" & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy, hh:nn:ss") & "</td></tr>"
    jInt = iInt + 9
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2 and `Estado` <> 'Empleado' and `Estado` <> 'CANCELADA' order by `Orden`"
    Try rResult = modVariables.c_Conn.Exec(sQueryString, fechaInicio, fechaFinal)
  Else
    tempHTML &= "<Tr><td colspan=5>Reporte de Ventas por mesero del dia:</td><td>" & Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy, hh:nn:ss") & "</td>"
    jInt = iInt + 8
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` = &1 and `Estado` <> 'Empleado' and `Estado` <> 'CANCELADA' order by `Orden`"
    Try rResult = modVariables.c_Conn.Exec(sQueryString, fechaInicio)
  Endif
  tempHTML &= "<tr>"
  tempHTML &= "<td>Orden</td>"
  tempHTML &= "<td>Cierre</td>"
  tempHTML &= "<td>Atendio</td>"
  tempHTML &= "<td>Mesa</td>"
  tempHTML &= "<td>Total</td>"
  tempHTML &= "</tr>"
  jInt += 1
  If rResult <> Null And rResult.Available
    For Each rResult
      tempHTML &= "<tr>"
      tempHTML &= "<td>" & rResult["Orden"] & "</td>"
      tempHTML &= "<td>" & rResult["Cierre"] & "</td>"
      tempHTML &= "<td>" & rResult["Atendio"] & "</td>"
      tempHTML &= "<td>" & rResult["Mesa"] & "</td>"
      tempHTML &= "<td>" & rResult["Total"] & "</td>"
      tempHTML &= "<td></td></tr>"
      Inc jInt
    Next
    tempHTML &= "</table>"
  Endif '
  
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  Inc jInt
  '===Inventarios e Insumos utilizados
  'Primero, sacamos el listado de los insumos posibles
  sQueryString = "SELECT * FROM `tbl_insumos` where `bit_activo` = 1 order by `id_insumo`"
  Try rResult = modVariables.c_Conn.Exec(sQueryString)
  
  If rResult <> Null And rResult.Available Then
    tempHTML &= "<table>"
    If fechaFinal <> Null Then
      tempHTML &= "<Tr><td colspan=4>Reporte de Insumos usados, e Inventarios del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & DateChooser2.Value & " </td><td>al</td><td>" & DateChooser3.Value & "</td></tr>"
      jInt = iInt + 14
    Else
      tempHTML &= "<Tr><td colspan=4>Reporte de Insumos usados, e Inventarios del dia:</td><td>" & DateChooser1.Value & "</td>"
      jInt = iInt + 13
    Endif
    tempHTML &= "</tr>"
    tempHTML &= "<Tr><td width='250'>Nombre</td>"
    tempHTML &= "<td>Inicio de periodo</td>"
    tempHTML &= "<td>Utilizados</td>"
    tempHTML &= "</tr>"
    
    Inc jInt
    
    For Each rResult
      If fechaFinal <> 0 Then
        sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and `Control Fecha` >= &2 And `Control Fecha` <= &3"
        Try rResultSuma = modVariables.c_Conn.Exec(sQuerystring, rResult["id_insumo"], fechaInicio, fechaFinal)
        sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and date(`dt_fecha_insumo`) >= Date(&2) And Date(`dt_fecha_insumo`) <= Date(&3)"
        Try rsInventario = modVariables.c_Conn.Exec(sQueryString, rResult["id_insumo"], modVariables._cnnFechaInicio, modVariables._cnnFechaFinal)
      Else
        sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and `Control Fecha` = &2"
        Try rResultSuma = modVariables.c_Conn.Exec(sQuerystring, rResult["id_insumo"], fechaInicio)
        sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and date(dt_fecha_insumo) = Date(&2)"
        Try rsInventario = modVariables.c_Conn.Exec(sQueryString, rResult["id_insumo"], modVariables._cnnFechaInicio)
      Endif
      If rResultSuma[0] <> Null Then
        tempHTML &= "<tr>"
        tempHTML &= "<td>" & rResult["chr_nombre_insumo"] & "</td>"
        If rsInventario[0] <> Null Then 
          tempHTML &= "<td>" & rsInventario[0] & "</td>"
        Else
          tempHTML &= "<td>0</td>"
        Endif
        tempHTML &= "<td>" & rResultSuma[0] & "</td>"
        tempHTML &= "</tr>"
        Inc jInt
        rResultSuma = Null
        rsInventario = Null
      Endif
    Next
    tempHTML &= "</table>"
  Endif
  
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  
  sQueryString = "SELECT * FROM  tbl_gastos where `dt_horafecha` >= &1 and `dt_horafecha` <= &2 order by `dt_horafecha` Asc"
  Try rResult = modVariables.c_Conn.Exec(sQueryString, modVariables._cnnFechaInicio, modVariables._cnnFechaFinal)
  If rResult <> Null And rResult.Available Then
    tempHTML &= "<table>"
    If fechaFinal <> 0 Then
      tempHTML &= "<Tr><td colspan=5>Reporte de gastos del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & modVariables._cnnFechaInicio & " </td><td>al</td><td>" & modVariables._cnnFechaFinal & "</td></tr>"
      jInt = iInt + 9
    Else
      tempHTML &= "<Tr><td colspan=3>Reporte de Gastos del dia:</td><td>" & modVariables._cnnFechaInicio & "</td>"
      jInt = iInt + 8
    Endif
    tempHTML &= "<tr>"
    tempHTML &= "<td>Hora/Fecha</td>"
    tempHTML &= "<td>Cantidad</td>"
   tempHTML &= "<td>Concepto</td>"
    
    For Each rResult
      tempHTML &= "<tr>"
      tempHTML &= "<td>" & rResult["dt_horafecha"] & "</td>"
      tempHTML &= "<td>$" & rResult["fl_cantidad"] & "</td>"
      tempHTML &= "<td>" & rResult["chr_concepto_gasto"] & "</td>"
      tempHTML &= "<td></td></tr>"
    Next
    tempHTML &= "</table>"
  Endif  
  
  tempHTML &= "</body>"

  'Print tempHTML
  Return tempHTML

Catch 
  Message.Error(Error.Text & ", " & Error.Where)

End
Public Sub gridReportIzq_Data(Row As Integer, Column As Integer)
  
  If rsRecords <> Null Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportIzq.Data.Text = Str(rsRecords[Column])
      If Error Then Print Error.Text & ", " & Error.Where
    Endif
  Endif

End

Public Sub btnBuscar_MouseUp()
Dim sQueryInsumos As String
Dim sQueryInventario As String
Dim hResult As Result
Dim iControlF As Integer
Dim iInc As Integer

  rsRecords = Null
  rsInsumos = Null
  rsInventario = Null
    
  If radioFechaUnica.Value = True Then
    modVariables._cnnFechaInicio = DateChooser1.Value
    modVariables._cnnFechaFinal = DateChooser1.Value
  Else
    modVariables._cnnFechaInicio = DateChooser2.Value
    modVariables._cnnFechaFinal = DateChooser3.Value
  Endif
  
    
  sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_fecha_calendario`) >= DATE(&1) and Date(`dt_fecha_calendario`) <= DATE(&2);"
  Try hResult = modVariables.c_Conn.Exec(sQueryString, modUtils.convierteFechaFormato(modVariables._cnnFechaInicio), modUtils.convierteFechaFormatoHora(modVariables._cnnFechaFinal))

  If hResult <> Null And hResult.Available Then
    iControlFechaStart = hResult["id_control_fechas"]
    hResult.MoveLast
    iControlFechaEnd = hResult["id_control_fechas"]
  Else
    Message.Info("No se han encontrado registros")
    Return
  Endif
  
  If Mouse.Control Then
    sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 order by dt_horafecha_cierre_orden, id_orden_id ASC"
  Else
    sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
  Endif

  sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where `Control Fecha` >= &1 AND `Control Fecha` <= &2 order by HoraFecha ASC"
  sQueryInventario = "SELECT * FROM `tbl_inventario` where id_control_fecha >= &1 AND id_control_fecha <= &2 and order by dt_fecha_insumo ASC"
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString, iControlFechaStart, iControlFechaEnd)
  Try rsInsumos = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  Try rsInventario = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  
  If rsRecords.Available Then
    gridReportIzq.Rows.Count = 0
    gridReportIzq.Rows.Count = rsRecords.Count
    Label4.Text = "Se han encontrado " & rsRecords.Count & " movimientos"
    'GridView1.Refresh
    btnGeneraUnica.Enabled = True
    btnGeneraCuenta.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica.Enabled = False
    btnGeneraCuenta.Enabled = False
    Label4.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)

End


Public Sub PrinterCuenta_Draw()

    'Dim documento As New ClassLaTex
  'Dim tex As String
  Dim sQuery As String
  Dim hResult, hResultCantidad, hResultPrecio As Result
  
  Dim sTemporal As String[]
  Dim hImage As Image
  Dim rResultPromos As Result
  Dim flTemporal, flTotal As Float
  Dim iInc As Integer
  Dim tText As String
  Dim iCantidad As Integer
  Dim flPrecio As Float
  
  Dim hFile As File
  Dim sLine As String
    
  hFile = Open Application.Path &/ "Templates/ticketventa.html" For Input
  Print hFile
  iInc = 1
  
  'hImage = Image.Load(User.Home &/ ".tacosroy/pictures" &/ "logoTicket.png")
  'hImage.Opacity(0.3)
  'Paint.MoveTo(1, 105)
  'Paint.DrawImage(hImage, 12, 600, hImage.Width * 7, hImage.Height * 7)
  
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  'Print rYPrint
  'PrinterCuenta.Paper.Custom

  'Paint.Height = 300
  docV[0] = ""
  
  Paint.Font = Font["Courier New,9"]
  docV[0] = "Cuenta del dia: " & Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy") & "<br>"
  If radioFechaRango.Value = True Then
    docV[0] &= "Al dia: " & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy") & "<br>"
  Endif
    
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  docV[0] &= hResult["chr_nombre"] & "<br>"
  docV[0] &= hResult["chr_dir1"] & "<br>"
  docV[0] &= hResult["chr_dir2"] & "<br>"
  docV[0] &= hResult["chr_dir3"] & " - " & hResult["chr_telefono1"] & "<br>"

  'If radioFechaUnica.Value = True Then
  '  sQuery = "SELECT * FROM vw_prods_x_orden WHERE `Control Fecha` = '&1' AND `Activo` = '1' group BY `ID Prod`, `Tipo Precio`"
  '  Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFecha)
  'Else
  sQuery = "SELECT * FROM vw_prods_x_orden WHERE `Control Fecha` >= '&1' AND `Control Fecha` <= '&2' AND `Activo` = '1' group BY `ID Prod` , `Tipo Precio`"
  Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
  'Endif
  
  If hResult <> Null And hResult.Available Then
    docV[0] &= "Detalle de ventas:<br>"
    Paint.Font = Font["Courier,Regular,8"]
    flTemporal = 0 
    flTotal = 0
    iInc = 0
    'sQueryInsumos.MoveTo[0]
    
    For Each hResult 'ordenes cerradas
      sQuery = "SELECT sum(`Cantidad`) as `Cantidad` FROM vw_prods_x_orden where `ID Prod` = &1 and `Control Fecha` = '&2' and `Tipo Precio` = &3"
      Try hResultCantidad = modVariables.c_Conn.Exec(sQuery, hResult["ID Prod"], hResult["Control Fecha"], hResult["Tipo Precio"])
      
      If hResultCantidad <> Null And hResultCantidad.Available Then
        sQuery = "SELECT `Precio`, `Tipo` from vw_products_catprecio where `ID` = &1 and `IDTipo` = &2 and `Activo` = 1"
        Try hResultPrecio = modVariables.c_Conn.Exec(sQuery, hResult["ID Prod"], hResult["Tipo Precio"])
        If hResultPrecio <> Null And hResultPrecio.Available Then
          docV[0] &= hResult["Producto"] & gb.Tab & "    x    " & hResultCantidad["Cantidad"] & " = " & gb.Tab & "$" 
          If hResultCantidad[0] = Null Then iCantidad = 0 Else iCantidad = hResultCantidad[0] 
          If hResultPrecio[0] = Null Then flPrecio = 0 Else flPrecio = hResultPrecio[0] 
          flTemporal = CFloat(iCantidad * flPrecio)
          flTotal += flTemporal
          docV[0] &= CStr(flTemporal) & " - (" & hResultPrecio["Tipo"] & ")" & "<br>"
        Endif
        hResultPrecio = Null
      Endif
      hResultCantidad = Null
      hResultPrecio = Null
    Next
    
  Else
    Paint.Font = Font["Helvetica, Bold, 10"]
    docV[0] &= "SIN MOVIMIENTOS PARA ESTA FECHA"
    Paint.DrawRichText(docV[0], PRINT_MARGIN, rYPrint + 200, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  Endif
  iInc += 1
  Paint.Font = Font["Helvetica,Bold, 10"]
  docV[0] &= "<p>Total: $" & flTotal & "</p>"
  PrinterCuenta.PaperWidth = 80
  Paint.DrawRichText(docV[0], PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub btnGeneraCuenta_Click()

Dim tempContents As String

  'tempContents = generaCuenta(rsRecords)
  PrinterCuenta.Count = 1
  PrinterCuenta.PaperWidth = 80
  PrinterCuenta.PaperHeight = 1000
  Me.Enabled = False
  Inc Application.Busy
  'PrinterCuenta.Configure
  PrinterCuenta.Print
  PrinterCuenta.OutputFile = User.Home &/ "Tickets/cuenta_" & modVariables.i_intTicketNR & "-" & modUtils.convierteFechaFormatoHora(Now) & ".pdf"
  Dec Application.Busy
  Me.Enabled = True

End


Public Sub btnBuscarMesero_Click()

Dim sQueryInsumos As String
Dim sQueryInventario As String
Dim hResult As Result

  rsRecords = Null
  rsInsumos = Null
  rsInventario = Null
    
  If radioFechaUnica2.Value = True Then
    modVariables._cnnFechaInicio = DateChooser4.Value
    sQueryString = "SELECT * FROM tbl_control_fechas where Date(`dt_fecha_calendario`) = DATE(&1);"
    Try hResult = modVariables.c_Conn.Exec(sQueryString, modVariables._cnnFechaInicio)
    If hResult <> Null And hResult.Available Then
      iControlFecha = hResult["id_control_fechas"]
    Else
      Message.Warning("No se han encontrado registros")
      Return
    Endif
    
    hResult = Null
    
    sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas FROM tbl_ordenes_cerradas where id_control_fecha = &1 and chr_referencia_notas = 'Empleado' order by id_orden_id ASC " ""
    
    'sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where `Fecha Control` = &1 order by `HoraFecha`"
    'sQueryInventario = "SELECT * FROM `tbl_inventario` where Date(dt_fecha_insumo) = DATE(&1) order by `dt_fecha_insumo`"
    
    Try rsRecords = modVariables.c_Conn.Exec(sQueryString, iControlFecha)
    'Try rsInsumos = modVariables.c_Conn.Exec(sQueryInsumos, iControlFecha)
    'Try rsInventario = modVariables.c_Conn.Exec(sQueryInsumos, modVariables._cnnFechaInicio)
    
  
  Else 'rango de fechas
    modVariables._cnnFechaInicio = DateChooser5.Value
    modVariables._cnnFechaFinal = DateChooser6.Value
    hResult = Null
    sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_comienzo_labores`) >= DATE(&1) and Date(`dt_finaliza_labores`) <= DATE(&2);"
    Try hResult = modVariables.c_Conn.Exec(sQueryString, modUtils.convierteFechaFormatoHora(modVariables._cnnFechaInicio), modUtils.convierteFechaFormatoHora(modVariables._cnnFechaFinal))

    If hResult <> Null And hResult.Available Then
      iControlFechaStart = hResult["id_control_fechas"]
      hResult.MoveLast
      iControlFechaEnd = hResult["id_control_fechas"]
    Else
      Message.Info("No se han encontrado registros")
      Return
    Endif
    
    sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 and chr_referencia_notas = 'Empleado' order by dt_horafecha_cierre_orden, id_orden_id ASC"

    'sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where `Control Fecha` >= &1 AND `Control Fecha` <= &2 order by HoraFecha ASC"
    'sQueryInventario = "SELECT * FROM `tbl_inventario` where id_control_fecha >= &1 AND id_control_fecha <= &2 and order by dt_fecha_insumo ASC"
    
    Try rsRecords = modVariables.c_Conn.Exec(sQueryString, iControlFechaStart, iControlFechaEnd)
    'Try rsInsumos = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
    'Try rsInventario = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  Endif
  
  
  If rsRecords.Available Then
    gridReportMesero.Rows.Count = 0
    gridReportMesero.Rows.Count = rsRecords.Count
    Label4.Text = "Se han encontrado " & rsRecords.Count & " movimientos"
    'GridView1.Refresh
    'btnGeneraUnica2.Enabled = True
    'btnGeneraCuenta2.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica2.Enabled = False
    btnGeneraCuenta2.Enabled = False
    Label4.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)


End

Public Sub gridReportMesero_Data(Row As Integer, Column As Integer)

  If rsRecords <> Null Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportMesero.Data.Text = Str(rsRecords[Column])
      If Error Then Print Error.Text & ", " & Error.Where
    Endif
  Endif

End

Public Sub PrinterCuenta2_Draw()
Dim sQuery As String
Dim hResult As Result

  docV[0] = ""
  Paint.Font = Font["Courier New,9"]
  docV[0] = "Consumo por empleado del dia: " & Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy") & "<br>"
  If radioFechaRango.Value = True Then
    docV[0] &= "Al dia: " & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy") & "<br>"
  Endif
  
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  
  docV[0] &= hResult["chr_nombre"] & "<br>"
  docV[0] &= hResult["chr_dir1"] & "<br>"
  docV[0] &= hResult["chr_dir2"] & "<br>"
  docV[0] &= hResult["chr_dir3"] & " - " & hResult["chr_telefono1"] & "<br>"

  If radioFechaUnica2.Value = True Then
    sQuery = "SELECT * FROM vw_prods_x_orden WHERE `Control Fecha` = '&1' AND `Activo` = '1' and `CHRTipoPrecio` = 'Personal' group BY `ID Prod`, `Tipo Precio`"
    Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFecha)
  Else
    sQuery = "SELECT * FROM vw_prods_x_orden WHERE `Control Fecha` >= '&1' AND `Control Fecha` <= '&2' AND `Activo` = '1' and `CHRTipoPrecio` = 'Personal' group BY `ID Prod` , `Tipo Precio`"
    Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
  Endif

Catch
  Message.Error(Error.Text)
  Return
End

Public Sub radioFechaRango2_Click()

  frmFechaUnica2.Visible = radioFechaUnica2.Value
  frmFechaRango2.Visible = Not radioFechaUnica2.Value

End

Public Sub radioFechaUnica2_Click()

  frmFechaUnica2.Visible = radioFechaUnica2.Value
  frmFechaRango2.Visible = Not radioFechaUnica2.Value

End

