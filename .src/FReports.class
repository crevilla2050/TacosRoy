' Gambas class file

Private sQueryString As String
Private rsRecords As Result
Private rsInsumos As Result
Private rsInventario As Result

Public Sub _new()

End

Public Sub Form_Open()


  gridReportIzq.header = GridView.Horizontal
  gridReportIzq.grid = True
  gridReportIzq.Rows.count = 0
  gridReportIzq.Columns.count = 5
  gridReportIzq.Columns[0].text = "id_orden_id"
  gridReportIzq.Columns[1].text = "dt_horafecha_cierre_orden"
  gridReportIzq.Columns[2].text = "fl_total"
  gridReportIzq.Columns[3].text = "bool_factura"
  gridReportIzq.Columns[4].text = "chr_referencia_notas"

  gridReportIzq.Columns[0].width = 80
  gridReportIzq.Columns[1].width = 50
  gridReportIzq.Columns[2].width = 300
  gridReportIzq.Columns[3].width = 150
  gridReportIzq.Columns[4].width = 100

  sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas FROM `tbl_ordenes_cerradas` where `int_lvl_report` = 1 order by `dt_horafecha_cierre_orden` Asc"
  
  Try rsRecords = modVariables.$hConn.Exec(sQueryString)
  gridReportIzq.Rows.Count = 0
  gridReportIzq.Rows.Count = rsRecords.Count
  
End


Public Sub radioFechaUnica_Click()

  frmFechaUnica.Visible = radioFechaUnica.Value
  frmFechaRango.Visible = Not radioFechaUnica.Value

End

Public Sub radioFechaRango_Click()

  frmFechaRango.Visible = radioFechaRango.Value
  frmFechaUnica.Visible = Not radioFechaRango.Value

End

Public Sub Button2_Click()

  If (Message.Question("¿En verdad desea Salir?", "Sí, Salir", "No")) = 1 Then 
  
  Me.Close
  Endif

End


Public Sub btnGeneraUnica_Click()

  Dim tempContents As String
  
  'hFile = Open User.Home & "/reporteTemp.xls" For Write Create

  tempContents = generaHTMLVentas(rsRecords, modVariables._cnnFechaInicio, modVariables._cnnFechaFinal)
  
  'Print #hFile, tempContents
  Print tempContents
  
  Dialog.Filter = ["*.xls", "Hoja de Cálculo Excel"]
  
  
  If Dialog.SaveFile() Then Return
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  File.Save(Dialog.Path, tempContents)
  Catch
    Message.Info(Error.Text & ", " & Error.Where)
  
  'hFile.Close
  
  btnGeneraUnica.Enabled = False

End

Public Function generaHTMLVentas(datosVentas As Result, fechaInicio As Date, Optional fechaFinal As Date) As String
  
  Dim tempHTML As String
  Dim iInt As Integer
  Dim jInt As Integer
  Dim sQueryString As String
  Dim rResult As Result
  Dim rResultSuma As Result
  
  tempHTML = "<body><table>" 
  tempHTML &= "<Tr><td colspan=6>Reporte de ventas</td>"
  tempHTML &= "</tr>"
  tempHTML &= "<Tr width='0'><td>ID</td>"
'  tempHTML &= "<td>Orden Nr.</td>"
  tempHTML &= "<td>Fecha y Hora</td>"
  tempHTML &= "<td>Total $</td>"
  tempHTML &= "<td width='80'>Factura</td>"
  tempHTML &= "<td width='200'>Referencia</td>"
  tempHTML &= "</tr>"
  
  For iInt = 0 To datosVentas.Count - 1
    datosVentas.MoveTo(iInt)
    tempHTML &= "<tr>"
    For jInt = 0 To datosVentas.Fields.Count - 1
      tempHTML &= "<td>" & datosVentas[jInt] & "</td>"
    Next
  Next
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>Totales:</td>"
  tempHTML &= "<td>=SUMA(C3:C" & CInt(iInt + 2) & ")</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "</table>"
  
  tempHTML &= "<table>"
  sQueryString = "SELECT * FROM `db_tacosRoy`.`vw_ordenes_x_mesero` where `Cierre` >= &1 and `Cierre` <= &2 and `Estado` = 'PAGADA' order by `Orden`"
  Try rResult = modVariables.$hConn.Exec(sQueryString, modUtils.convierteFechaFormato(fechaInicio), modUtils.convierteFechaFormato(fechaFinal))
  
  If fechaFinal <> Null Then
    tempHTML &= "<Tr><td colspan=5>Reporte de Ventas por mesero, del periodo:</td><td>" 
    tempHTML &= "<tr><td>&nbsp;</td><td>" & fechaInicio & " </td><td>al</td><td>" & fechaFinal & "</td></tr>"
    jInt = iInt + 9
  Else
    tempHTML &= "<Tr><td colspan=5>Reporte de Ventas por mesero del dia:</td><td>" & fechaInicio & "</td>"
    jInt = iInt + 8
  Endif
  tempHTML &= "<tr>"
  tempHTML &= "<td>Orden</td>"
  tempHTML &= "<td>Cierre</td>"
  tempHTML &= "<td>Atendio</td>"
  tempHTML &= "<td>Mesa</td>"
  tempHTML &= "<td>Total</td>"
  
  For Each rResult
    tempHTML &= "<tr>"
    tempHTML &= "<td>" & rResult["Orden"] & "</td>"
    tempHTML &= "<td>" & rResult["Cierre"] & "</td>"
    tempHTML &= "<td>" & rResult["Atendio"] & "</td>"
    tempHTML &= "<td>" & rResult["Mesa"] & "</td>"
    tempHTML &= "<td>" & rResult["Total"] & "</td>"
    tempHTML &= "<td></td></tr>"
  Next
  tempHTML &= "</table>"

  '===Inventarios e Insumos utilizados
  'Primero, sacamos el listado de los insumos posibles
  sQueryString = "SELECT * FROM `tbl_insumos` order by `id_insumo`"
  Try rResult = modVariables.$hConn.Exec(sQueryString)
  
  tempHTML &= "<table>"
  If fechaFinal <> Null Then
    tempHTML &= "<Tr><td colspan=4>Reporte de Insumos usados, e Inventarios del periodo:</td><td>" 
    tempHTML &= "<tr><td>&nbsp;</td><td>" & fechaInicio & " </td><td>al</td><td>" & fechaFinal & "</td></tr>"
    jInt = iInt + 14
  Else
    tempHTML &= "<Tr><td colspan=4>Reporte de Insumos usados, e Inventarios del dia:</td><td>" & fechaInicio & "</td>"
    jInt = iInt + 13
  Endif
  tempHTML &= "</tr>"
  tempHTML &= "<Tr><td width='250'>Nombre</td>"
  tempHTML &= "<td>Utilizados</td>"
  tempHTML &= "<td>Inicio de periodo</td>"
  tempHTML &= "<td>Final del periodo</td>"
  tempHTML &= "</tr>"
  
  For Each rResult
    If fechaFinal <> Null Then
      sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and Date(`HoraFecha`) >= Date(&2) And Date(`HoraFecha`) <= Date(&3)"
      Try rResultSuma = modVariables.$hConn.Exec(sQuerystring, rResult["id_insumo"], modUtils.convierteFechaFormato(fechaInicio), modUtils.convierteFechaFormato(fechaFinal))
      sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and date(`dt_fecha_insumo`) >= Date(&2) And Date(`dt_fecha_insumo`) <= Date(&3)"
      Try rsInventario = modVariables.$hConn.Exec(sQueryString, rResult["id_insumo"], modUtils.convierteFechaFormato(fechaInicio), modUtils.convierteFechaFormato(fechaFinal))
    Else
      sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and Date(`HoraFecha`) = Date(&2)"
      Try rResultSuma = modVariables.$hConn.Exec(sQuerystring, rResult["id_insumo"], modUtils.convierteFechaFormato(fechaInicio))
      sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and date(dt_fecha_insumo) = Date(&2)"
      Try rsInventario = modVariables.$hConn.Exec(sQueryString, rResult["id_insumo"], modUtils.convierteFechaFormato(fechaInicio))
    Endif
    
    tempHTML &= "<tr>"
    tempHTML &= "<td>" & rResult["chr_nombre_insumo"] & "</td>"
    tempHTML &= "<td>" & rResultSuma[0] & "</td>"
    tempHTML &= "<td>" & rsInventario[0] & "</td>"
    tempHTML &= "<td>=(C" & CInt(jInt - 2) & "-B" & CInt(jInt - 2) & ")</td>"
    tempHTML &= "<td></td>"
    tempHTML &= "</td>"
    Inc jInt
  Next
  tempHTML &= "</table>"
  
  
  sQueryString = "SELECT * FROM db_tacosRoy.tbl_gastos where `dt_horafecha` >= &1 and `dt_horafecha` <= &2 order by `dt_horafecha` Asc"
  Try rResult = modVariables.$hConn.Exec(sQueryString, modUtils.convierteFechaFormato(fechaInicio), modUtils.convierteFechaFormato(fechaFinal))
  If rResult <> Null Then
    tempHTML &= "<table>"
    If fechaFinal <> Null Then
      tempHTML &= "<Tr><td colspan=5>Reporte de gastos del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & fechaInicio & " </td><td>al</td><td>" & fechaFinal & "</td></tr>"
      jInt = iInt + 9
    Else
      tempHTML &= "<Tr><td colspan=3>Reporte de Gastos del dia:</td><td>" & fechaInicio & "</td>"
      jInt = iInt + 8
    Endif
    tempHTML &= "<tr>"
    tempHTML &= "<td>Hora/Fecha</td>"
    tempHTML &= "<td>Cantidad</td>"
    tempHTML &= "<td>Concepto</td>"
    
    For Each rResult
      tempHTML &= "<tr>"
      tempHTML &= "<td>" & rResult["dt_horafecha"] & "</td>"
      tempHTML &= "<td>$" & rResult["fl_cantidad"] & "</td>"
      tempHTML &= "<td>" & rResult["chr_concepto_gasto"] & "</td>"
      tempHTML &= "<td></td></tr>"
    Next
    tempHTML &= "</table>"
  Endif  
  
  tempHTML &= "</body>"

  'Print tempHTML
  Return tempHTML
  
  modVariables._cnnConnection.Close
End


Public Sub gridReportIzq_Data(Row As Integer, Column As Integer)
  
  If Row >= 0 Then
    rsRecords.moveTo(Row)
    Try gridReportIzq.Data.Text = Str(rsRecords[Column])
    If Error Then Print Error.Text & ", " & Error.Where
  Endif

End

Public Sub btnBuscar_MouseUp()
Dim sQueryInsumos As String
Dim sQueryInventario As String

    If radioFechaUnica.Value = True Then
    modVariables._cnnFechaInicio = DateChooser1.Value
    If Mouse.Control Then
      sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas FROM tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) = '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' order by dt_horafecha_cierre_orden, id_orden_id ASC"
    Else
      sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas FROM tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) = '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    Endif
    sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where Date(HoraFecha) = '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' order by `HoraFecha`"
    sQueryInventario = "SELECT * FROM `tbl_inventario` where Date(dt_fecha_insumo) = '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' order by `dt_fecha_insumo`"
  Else
    modVariables._cnnFechaInicio = DateChooser2.Value
    modVariables._cnnFechaFinal = DateChooser3.Value
    If Mouse.Control Then
      sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_horafecha_cierre_orden) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' order by dt_horafecha_cierre_orden, id_orden_id ASC"
    Else
      sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where Date(dt_horafecha_cierre_orden) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_horafecha_cierre_orden) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    Endif
    sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where Date(HoraFecha) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(HoraFecha) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' order by HoraFecha ASC"
    sQueryInventario = "SELECT * FROM `tbl_inventario` where Date(dt_fecha_insumo) >= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaInicio) & "' AND Date(dt_fecha_insumo) <= '" & modUtils.convierteFechaFormato(modVariables._cnnFechaFinal) & "' and order by dt_fecha_insumo ASC"
    
  Endif
  
  'Print sQueryString
  'Print sQueryInsumos
  'Print sQueryInventario
  
  Try rsRecords = modVariables.$hConn.Exec(sQueryString)
  Try rsInsumos = modVariables.$hConn.Exec(sQueryInsumos)
  Try rsInventario = modVariables.$hConn.Exec(sQueryInsumos)
  
  If rsRecords.Available Then
    gridReportIzq.Rows.Count = 0
    gridReportIzq.Rows.Count = rsRecords.Count
   
    Label1.Text = "Se han encontrado " & rsRecords.Count & " movimientos"
    'GridView1.Refresh
    btnGeneraUnica.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica.Enabled = False
    Label1.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)

End
