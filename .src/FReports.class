' Gambas class file

Private sQueryString As String
Private rsRecords As Result
Private rsInsumos As Result
Private rsInventario As Result
'Private rsCuenta As Result
'Private rsVentaProductos As Result
Private iControlFecha As Integer
Private iControlFechaStart As Integer
Private iControlFechaEnd As Integer

'Impresion de tickets y reportes
Private rYPrint As Integer
Private docV As New String[2]
Private Const PRINT_MARGIN As Float = 1


Public Sub Form_Open()

  gridReportIzq.header = GridView.Horizontal
  gridReportIzq.grid = True
  gridReportIzq.Rows.count = 0
  gridReportIzq.Columns.count = 5
  gridReportIzq.Columns[0].text = "ID Orden"
  gridReportIzq.Columns[1].text = "Fecha y Hora"
  gridReportIzq.Columns[2].text = "Total"
  gridReportIzq.Columns[3].text = "Mesa"
  gridReportIzq.Columns[4].text = "Referencia"

  gridReportIzq.Columns[0].width = 80
  gridReportIzq.Columns[1].width = 50
  gridReportIzq.Columns[2].width = 300
  gridReportIzq.Columns[3].width = 150
  gridReportIzq.Columns[4].width = 100
  
  gridReportMesero.Header = GridView.Horizontal
  gridReportMesero.Grid = True
  gridReportMesero.Rows.count = 0
  gridReportMesero.Columns.count = 10
  gridReportMesero.Columns[0].Text = "Total"
  gridReportMesero.Columns[1].Text = "ID Prod"
  gridReportMesero.Columns[2].Text = "Producto"
  gridReportMesero.Columns[3].Text = "Cantidad"
  gridReportMesero.Columns[4].Text = "Precio"
  gridReportMesero.Columns[5].Text = "Tipo Precio"
  gridReportMesero.Columns[6].Text = "CHRTipoPrecio"
  gridReportMesero.Columns[7].Text = "ID TPago"
  gridReportMesero.Columns[8].Text = "Tipo Pago"
  gridReportMesero.Columns[9].Text = "Ordenar"
  
  DateChooser1.MinValue = modVariables._cnnComienzoLabores
  dtFechaInicio.MinValue = modVariables._cnnComienzoLabores
  dtFechaFinal.MinValue = modVariables._cnnComienzoLabores
  DateChooser4.MinValue = modVariables._cnnComienzoLabores
  DateChooser5.MinValue = modVariables._cnnComienzoLabores
  DateChooser6.MinValue = modVariables._cnnComienzoLabores

  sQueryString = "SELECT id_orden_id as `ID Orden`, dt_horafecha_cierre_orden as `Fecha y Hora`, fl_total as `Total`, bool_factura as `Factura`, chr_referencia_notas as `Referencia` FROM `tbl_ordenes_cerradas` where Date(dt_horafecha_cierre_orden) >= &1 "
    
  sQueryString &= " and `int_lvl_report` = 1 order by `dt_horafecha_cierre_orden` Asc"
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString)
  gridReportIzq.Rows.Count = 0
  If (rsRecords <> Null) Then gridReportIzq.Rows.Count = rsRecords.Count
  
End


Public Sub radioFechaUnica_Click()

  frmFechaUnica.Visible = radioFechaUnica.Value
  frmFechaRango.Visible = Not radioFechaUnica.Value

End

Public Sub radioFechaRango_Click()

  frmFechaRango.Visible = radioFechaRango.Value
  frmFechaUnica.Visible = Not radioFechaRango.Value

End

Public Sub Button2_Click()

  If (Message.Question("¿En verdad desea Salir?", "Sí, Salir", "No")) = 1 Then 
    Me.Close
  Endif

End


Public Sub btnGeneraUnica_Click()

  Dim tempContents As String

  If radioFechaUnica.value = True Then 
    tempContents = generaHTMLVentas(iControlFecha)
  Else
    tempContents = generaHTMLVentas(iControlFechaStart, iControlFechaEnd)
  Endif
  
  'Print tempContents
  Dialog.Filter = ["*.xls", "Hoja de Cálculo Excel"]
  
  If Dialog.SaveFile() Then Return
  If Right(Dialog.Path, 4) <> ".xls" Then Dialog.Path &= ".xls"
  File.Save(Dialog.Path, tempContents)

Catch
    Message.Info(Error.Text & ", " & Error.Where)
    btnGeneraUnica.Enabled = False
    
End

Public Function generaHTMLVentas(fechaInicio As Integer, Optional fechaFinal As Integer) As String
  
  Dim tempHTML As String
  Dim iInt As Integer
  Dim jInt As Integer
  Dim sQueryString, sQuery As String
  Dim rResult As Result
  Dim rResultSuma As Result
  
  tempHTML = "<body><table>" 
  tempHTML &= "<Tr><td colspan=6>Reporte de ventas</td>"
  tempHTML &= "</tr>"
  tempHTML &= "<Tr width='0'><td>ID</td>"
'  tempHTML &= "<td>Orden Nr.</td>"
  tempHTML &= "<td>Fecha y Hora</td>"
  tempHTML &= "<td>Total</td>"
  tempHTML &= "<td width='80'>Mesa</td>"
  tempHTML &= "<td width='200'>Referencia</td>"
  tempHTML &= "<td width='200'>Atendio</td>"
  tempHTML &= "<td width='200'>Control Fecha</td>"
  tempHTML &= "<td width='200'>Referencia</td>"
  tempHTML &= "<td width='200'>Index</td>"
  tempHTML &= "<td width='200'>Tipo Pago</td>"
  tempHTML &= "</tr>"
  
  For iInt = 0 To rsRecords.Count - 1
    rsRecords.MoveTo(iInt)
    tempHTML &= "<tr>"
    For jInt = 0 To rsRecords.Fields.Count - 1
      tempHTML &= "<td>" & rsRecords[jInt] & "</td>"
    Next
    tempHTML &= "</tr>"
  Next
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  tempHTML &= "</table>"
  
  tempHTML &= "<table>"
  
  If fechaFinal <> 0 Then
    tempHTML &= "<Tr><td colspan=5>Reporte de Ventas por mesero, del periodo:</td><td>" 
    tempHTML &= "<tr><td>&nbsp;</td><td>" & Format(dtFechaInicio.Value, "dddd dd mmmm yyyy, hh:nn:ss") & " </td><td>al</td><td>" & Format(dtFechaFinal.Value, "dddd dd mmmm yyyy, hh:nn:ss") & "</td></tr>"
    jInt = iInt + 9
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2 and `Estado` <> 'Empleado' and `Estado` <> 'CANCELADA' order by `Orden`"
    Try rResult = modVariables.c_Conn.Exec(sQueryString, fechaInicio, fechaFinal)
  Else
    tempHTML &= "<Tr><td colspan=5>Reporte de Ventas por mesero del dia:</td><td>" & Format(dtFechaInicio.Value, "dddd dd mmmm yyyy, hh:nn:ss") & "</td>"
    jInt = iInt + 8
    
    'sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` = &1 and `Estado` <> 'Empleado' and `Estado` <> 'CANCELADA' order by `Orden`"
    'Try rResult = modVariables.c_Conn.Exec(sQueryString, fechaInicio)
    
  Endif
  
  rsRecords.MoveFirst

  If (rsRecords <> Null) And rsRecords.Available Then
    For Each rsRecords
      tempHTML &= "<tr>"
      tempHTML &= "<td>Orden</td>"
      tempHTML &= "<td>Cierre</td>"
      tempHTML &= "<td>Atendio</td>"
      tempHTML &= "<td>Mesa</td>"
      tempHTML &= "<td>Total</td>"
      tempHTML &= "<td>Referencia</td>"
      tempHTML &= "</tr>"
      jInt += 1
      tempHTML &= "<tr>"
      tempHTML &= "<td>" & rsRecords["Orden"] & "</td>"
      tempHTML &= "<td>" & rsRecords["Cierre"] & "</td>"
      tempHTML &= "<td>" & rsRecords["Atendio"] & "</td>"
      tempHTML &= "<td>" & rsRecords["Mesa"] & "</td>"
      tempHTML &= "<td>" & rsRecords["Total"] & "</td>"
      tempHTML &= "<td>" & rsRecords["Referencia"] & "</td>"
      tempHTML &= "<td></td></tr>"
      Inc jInt
      If chkDetallado.Value = True Then
        rResult = Null
        sQuery = "SELECT"
        sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`int_orden_id`) AS `Orden`," 
        sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`id_prod_x_orden`) AS `IDPO`,"
        sQuery &= "        ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`," 
        sQuery &= "        ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
        sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`) AS `Cantidad`,"
        sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`," 
        sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio` * `tbl_prods_x_orden`.`int_cantidad`) AS `Subtotal`," 
        sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
        sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
        sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`id_control_fecha`) AS `Control Fecha`,"
        sQuery &= "        ANY_VALUE( `tbl_prods_x_orden`.`bool_activo`) AS `Activo`," 
        sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `Tipo Pago`,"
        sQuery &= "        ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`" 
        sQuery &= "    From"
        sQuery &= "        `tbl_ordenes_cerradas`"
        sQuery &= "		LEFT JOIN `tbl_prods_x_orden` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_ordenes_cerradas`.`id_orden_id`"
        sQuery &= "        LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
        sQuery &= "        LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
        sQuery &= "        LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
        sQuery &= "        LEFT JOIN `tbl_precios_productos` ON (((`tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`)"
        sQuery &= "            And ( `tbl_prods_x_orden`.`int_tipo_precio` = `tbl_precios_productos`.`int_tipo_precio`)))"
        sQuery &= "        WHERE" 
        sQuery &= "            `tbl_productos`.`int_activo` = 1" 
        sQuery &= "            And `tbl_prods_x_orden`.`bool_activo` = '1'"  
        sQuery &= "            And `tbl_precios_productos`.`bit_activo` = 1" 
        sQuery &= "            And `tbl_prods_x_orden`.`int_orden_id` = &1"
        sQuery &= "            order by `Tipo Precio`"
        Try rResult = modVariables.c_Conn.Exec(sQuery, rsRecords["Orden"])
        If (rResult <> Null) And rResult.Available Then
          tempHTML &= "<tr><td colspan=\"8\">Detalle de orden</td></tr><tr>"
          tempHTML &= "<td>IDPO</td>"
            tempHTML &= "<td>ID Prod</td>"
            tempHTML &= "<td>Producto</td>"
            tempHTML &= "<td>Cantidad</td>"
            tempHTML &= "<td>Precio </td>"
            tempHTML &= "<td>Subtotal</td>"
            tempHTML &= "<td>Tipo Precio</td>"
            tempHTML &= "<td>Tipo Pago</td>"
            tempHTML &= "<td></td></tr>"
          For Each rResult
            tempHTML &= "<td>" & rResult["IDPO"] & "</td>"
            tempHTML &= "<td>" & rResult["ID Prod"] & "</td>"
            tempHTML &= "<td>" & rResult["Producto"] & "</td>"
            tempHTML &= "<td>" & rResult["Cantidad"] & "</td>"
            tempHTML &= "<td>" & rResult["Precio"] & "</td>"
            tempHTML &= "<td>" & rResult["Subtotal"] & "</td>"
            tempHTML &= "<td>" & rResult["Tipo Precio"] & "</td>"
            tempHTML &= "<td>" & rResult["Tipo Pago"] & "</td>"
            tempHTML &= "<td></td></tr>"
            Inc jInt
          Next
          tempHTML &= "<tr>"
        Endif
      Endif
    Next
  Endif
  tempHTML &= "</table>"
  'Endif '
  
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  Inc jInt
  '===Inventarios e Insumos utilizados
  'Primero, sacamos el listado de los insumos posibles
  sQueryString = "SELECT * FROM `tbl_insumos` where `bit_activo` = 1 order by `id_insumo`"
  Try rResult = modVariables.c_Conn.Exec(sQueryString)
  
  If (rResult <> Null) And rResult.Available Then
    tempHTML &= "<table>"
    If fechaFinal <> Null Then
      tempHTML &= "<Tr><td colspan=4>Reporte de Insumos usados, e Inventarios del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & dtFechaInicio.Value & " </td><td>al</td><td>" & dtFechaFinal.Value & "</td></tr>"
      jInt = iInt + 14
    Else
      tempHTML &= "<Tr><td colspan=4>Reporte de Insumos usados, e Inventarios del dia:</td><td>" & DateChooser1.Value & "</td>"
      jInt = iInt + 13
    Endif
    tempHTML &= "</tr>"
    tempHTML &= "<Tr><td width='250'>Nombre</td>"
    tempHTML &= "<td>Inicio de periodo</td>"
    tempHTML &= "<td>Utilizados</td>"
    tempHTML &= "</tr>"
    
    Inc jInt
    
    For Each rResult
      If fechaFinal <> 0 Then
        sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and `Control Fecha` >= &2 And `Control Fecha` <= &3"
        Try rResultSuma = modVariables.c_Conn.Exec(sQuerystring, rResult["id_insumo"], fechaInicio, fechaFinal)
        sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and date(`dt_fecha_insumo`) >= Date(&2) And Date(`dt_fecha_insumo`) <= Date(&3)"
        Try rsInventario = modVariables.c_Conn.Exec(sQueryString, rResult["id_insumo"], fechaInicio, fechaFinal)
      Else
        sQueryString = "SELECT Sum(`Usado`) FROM `vw_insumos_usados_x_orden` where `InsumoID` = &1 and `Control Fecha` = &2"
        Try rResultSuma = modVariables.c_Conn.Exec(sQuerystring, rResult["id_insumo"], fechaInicio)
        sQueryString = "SELECT Sum(`int_cantidad`) FROM `tbl_inventario` where id_insumo_id = &1 and date(dt_fecha_insumo) = Date(&2)"
        Try rsInventario = modVariables.c_Conn.Exec(sQueryString, rResult["id_insumo"], fechaInicio)
      Endif
      'If rResultSuma[0] <> Null Then
      '  tempHTML &= "<tr>"
      '  tempHTML &= "<td>" & rResult["chr_nombre_insumo"] & "</td>"
      '  If rsInventario <> Null And rsInventario[0] <> Null Then 
      '    tempHTML &= "<td>" & rsInventario[0] & "</td>"
      '  Else
      '    tempHTML &= "<td>0</td>"
      '  Endif
      '  tempHTML &= "<td>" & rResultSuma[0] & "</td>"
      '  tempHTML &= "</tr>"
      '  Inc jInt
      '  rResultSuma = Null
      '  rsInventario = Null
      'Endif
    Next
    tempHTML &= "</table>"
  Endif
  
  tempHTML &= "<Tr><td>&nbsp;</td>"
  tempHTML &= "<td>&nbsp;</td></tr>"
  
  sQueryString = "SELECT * FROM  tbl_gastos where `dt_horafecha` >= &1 and `dt_horafecha` <= &2 order by `dt_horafecha` Asc"
  Try rResult = modVariables.c_Conn.Exec(sQueryString, fechaInicio, fechaFinal)
  If (rResult <> Null) And rResult.Available Then
    tempHTML &= "<table>"
    If fechaFinal <> 0 Then
      tempHTML &= "<Tr><td colspan=5>Reporte de gastos del periodo:</td><td>" 
      tempHTML &= "<tr><td>&nbsp;</td><td>" & fechaInicio & " </td><td>al</td><td>" & fechaFinal & "</td></tr>"
      jInt = iInt + 9
    Else
      tempHTML &= "<Tr><td colspan=3>Reporte de Gastos del dia:</td><td>" & fechaInicio & "</td>"
      jInt = iInt + 8
    Endif
    tempHTML &= "<tr>"
    tempHTML &= "<td>Hora/Fecha</td>"
    tempHTML &= "<td>Cantidad</td>"
   tempHTML &= "<td>Concepto</td>"
    
    For Each rResult
      tempHTML &= "<tr>"
      tempHTML &= "<td>" & rResult["dt_horafecha"] & "</td>"
      tempHTML &= "<td>$" & rResult["fl_cantidad"] & "</td>"
      tempHTML &= "<td>" & rResult["chr_concepto_gasto"] & "</td>"
      tempHTML &= "<td></td></tr>"
    Next
    tempHTML &= "</table>"
  Endif  
  
  tempHTML &= "</body>"

  'Print tempHTML
  Return tempHTML

Catch 
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub gridReportIzq_Data(Row As Integer, Column As Integer)
  
  If (rsRecords <> Null) Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportIzq.Data.Text = Str(rsRecords[Column])
    Endif
  Endif

Catch 
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnBuscar_MouseUp()

Dim sQueryInsumos As String
Dim sQueryInventario As String
Dim hResult As Result
'Dim iControlF As Integer
'Dim iInc As Integer

  rsRecords = Null
  rsInsumos = Null
  rsInventario = Null
    
  If radioFechaUnica.Value = True Then
    modVariables._cnnFechaInicio = DateChooser1.Value
    modVariables._cnnFechaFinal = DateChooser1.Value
  Else
    modVariables._cnnFechaInicio = dtFechaInicio.Value
    modVariables._cnnFechaFinal = dtFechaFinal.Value
  Endif
  
  sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_fecha_calendario`) >= DATE(&1) and Date(`dt_fecha_calendario`) <= DATE(&2);"
  Print sQueryString
  Try hResult = modVariables.c_Conn.Exec(sQueryString, Format(modVariables._cnnFechaInicio, "yyyy-mm-dd"), Format(modVariables._cnnFechaFinal, "yyyy-mm-dd"))

  If (hResult <> Null) And hResult.Available Then
    iControlFechaStart = hResult["id_control_fechas"]
    hResult.MoveLast
    iControlFechaEnd = hResult["id_control_fechas"]
  Else
    Message.Info("No se han encontrado registros")
    Return
  Endif
  
  If Mouse.Control Then
    'sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2;"
  Else
    'sQueryString = "SELECT id_orden_id, dt_horafecha_cierre_orden, fl_total, bool_factura, chr_referencia_notas From tbl_ordenes_cerradas where `id_control_fecha` >= &1 and `id_control_fecha` <= &2 and int_lvl_report = 1 order by dt_horafecha_cierre_orden, id_orden_id ASC"
    sQueryString = "SELECT * FROM vw_ordenes_x_mesero where `Control Fecha` >= &1 and `Control Fecha` <= &2 and `Indexed` = '1';"
  Endif

  sQueryInsumos = "SELECT * FROM `vw_insumos_usados_x_orden` where `Control Fecha` >= &1 AND `Control Fecha` <= &2 order by HoraFecha ASC"
  sQueryInventario = "SELECT * FROM `tbl_inventario` where id_control_fecha >= &1 AND id_control_fecha <= &2 and order by dt_fecha_insumo ASC"
  rsRecords = Null
  rsInsumos = Null
  rsInventario = Null
  
  Try rsRecords = modVariables.c_Conn.Exec(sQueryString, iControlFechaStart, iControlFechaEnd)
  Try rsInsumos = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  Try rsInventario = modVariables.c_Conn.Exec(sQueryInsumos, iControlFechaStart, iControlFechaEnd)
  
  If (rsRecords <> Null) And rsRecords.Available Then
    gridReportIzq.Rows.Count = 0
    gridReportIzq.Rows.Count = rsRecords.Count
    Label4.Text = "Se han encontrado " & rsRecords.Count & " ordenes cerradas"
    'GridView1.Refresh
    btnGeneraUnica.Enabled = True
    btnGeneraCuenta.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica.Enabled = False
    btnGeneraCuenta.Enabled = False
    Label4.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)

End


Public Sub PrinterCuenta_Draw()

    'Dim documento As New ClassLaTex
  'Dim tex As String
  Dim sQuery As String
  Dim hResult, hResultResumido, hResultCantidad, hResultPrecio, hResultEmpleado As Result
  
  Dim sTemporal, sPersonalText As String
  'Dim hImage As Image
  'Dim rResultPromos As Result
  Dim flTemporal, flTotal, flEfectivo, flDescuento, flEmpleados, flTarjeta As Float
  Dim iInc, iIndexPersonal As Integer
 ' Dim tText As String
  Dim iCantidad As Integer
  Dim iCantidadTotal As Integer
  'Dim flPrecio As Float
    
  Dim sArray As String[] = Split(File.Load("Templates/cuenta.html"), gb.Newline, "", True)
  Dim sHTML As String
  
  sHTML = sArray.Join(gb.Newline)
  
  rYPrint = PRINT_MARGIN - (PrinterCuenta.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Courier New,10"]
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  
  sHTML = Replace(sHTML, "@@DiaComienzo@@", Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy"))
  
  If radioFechaRango.Value = True Then
    sHTML = Replace(sHTML, "@@DiaFin@@", "Al dia: " & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy"))
  Else
    sHTML = Replace(sHTML, "@@DiaFin@@", "")
  Endif
    
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)

  sHTML = Replace(sHTML, "@@NombreSuc@@", hResult["chr_nombre"])
  sHTML = Replace(sHTML, "@@DirSuc1@@", hResult["chr_dir1"])
  sHTML = Replace(sHTML, "@@DirSuc2@@", hResult["chr_dir2"])
  sHTML = Replace(sHTML, "@@DirSuc3@@", hResult["chr_dir3"])
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", hResult["chr_telefono1"])
  
  hResult = Null
  
  'iIndexPersonal
  sQuery = "SELECT `chr_var_value` from `tbl_configs` where `chr_var_name` = 'personal_index';"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  iIndexPersonal = CInt(hResult[0])
  hResult = Null
  
  'sPersonalText
  sQuery = "SELECT `chr_nombre_precio` from `tbl_tipos_precios` where `id_tipo_precio` = '&1';"
  Try hResult = modVariables.c_Conn.Exec(sQuery, iIndexPersonal)
  sPersonalText = CStr(hResult[0])
  hResult = Null
  
  'Resumen de tacos por grupo
  sQuery = "SELECT  "
  sQuery &= "  ANY_VALUE(SUM( `tbl_prods_x_orden`.`int_cantidad`*`tbl_precios_productos`.`dbl_precio`)) as `Total`,"
  sQuery &= "     SUM(ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`)) AS `Cantidad`,"
  sQuery &= "     ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`,"
  sQuery &= "     ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
  sQuery &= "     ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
  sQuery &= "     ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `ID TPago`,"
  sQuery &= "     ANY_VALUE( `tbl_formas_pago`.`chr_forma_pago`) AS `Tipo Pago`,"
  sQuery &= "     ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`,"
  sQuery &= "     IFNULL(ANY_VALUE(`tbl_grupos_def`.`chr_nombre_grupo`), \"Otros\") AS `Agrupar`"
  sQuery &= "     From"
  sQuery &= "     `tbl_prods_x_orden`"
  sQuery &= "     LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
  sQuery &= "     LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
  sQuery &= "     LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
  sQuery &= "     LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id`"
  sQuery &= "     left join `tbl_formas_pago` ON `tbl_ordenes_cerradas`.`int_forma_pago` = `tbl_formas_pago`.`id_forma_pago`"
  sQuery &= "     LEFT JOIN `tbl_precios_productos` ON (((`tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`)"
  sQuery &= "         And ( `tbl_prods_x_orden`.`int_tipo_precio` = `tbl_precios_productos`.`int_tipo_precio`)))"
  sQuery &= "     left join `tbl_grupos_def` on `tbl_productos`.`id_grupo_producto` = `tbl_grupos_def`.`id_grupos_def`"
  sQuery &= "     WHERE"
  sQuery &= "     `tbl_productos`.`int_activo` = 1 "
  sQuery &= "         And `tbl_prods_x_orden`.`bool_activo` = '1'  "
  sQuery &= "         And `tbl_precios_productos`.`bit_activo` = 1 "
  sQuery &= "         And `tbl_ordenes_cerradas`.`id_control_fecha` >= &1 "
  sQuery &= "         And `tbl_ordenes_cerradas`.`id_control_fecha` <= &2 "
  sQuery &= "      group BY `Agrupar`, `Tipo Precio`"
  sQuery &= "      order by `Tipo Precio`, `ID TPago`, `Ordenar`"

  Try hResultResumido = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
  If (hResultResumido <> Null) And hResultResumido.Available Then 
    sTemporal = "<tr><td>Prod.</td><td>Cant.</td><td>Tipo P.</td><td>Total</td></tr>"
    For Each hResultResumido
      sTemporal &= "<tr><td width = \"45%\">" & hResultResumido["Agrupar"] & "</td><td>" & hResultResumido["Cantidad"] & "</td><td>" & hResultResumido["CHRTipoPrecio"] & "</td><td>$" & hResultResumido["Total"] & ".00</td><td></tr>"
    Next
    
  Endif
  sHTML = Replace(sHTML, "@@DetalleResumido@@", sTemporal)
  hResultResumido = Null
  sTemporal = "<tr><td colspan = 5>Detalle por producto:</td></tr>"
  
  'main cachucha
  sQuery = "  SELECT  ANY_VALUE(SUM(`tbl_prods_x_orden`.`int_cantidad`*`tbl_precios_productos`.`dbl_precio`)) as `Total`,"
  sQuery &= "        ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`,"
  sQuery &= "        ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
  sQuery &= "        SUM(ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`)) AS `Cantidad`,"
  sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`,"
  sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
  sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
  sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `ID TPago`,"
  sQuery &= "        ANY_VALUE( `tbl_formas_pago`.`chr_forma_pago`) AS `Tipo Pago`,"
  sQuery &= "        ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`"
  sQuery &= "        From"
  sQuery &= "        `tbl_prods_x_orden`"
  sQuery &= "        LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
  sQuery &= "        LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
  sQuery &= "        LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
  sQuery &= "        LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id`"
  sQuery &= "        left join `tbl_formas_pago` ON `tbl_ordenes_cerradas`.`int_forma_pago` = `tbl_formas_pago`.`id_forma_pago`"
  sQuery &= "        LEFT JOIN `tbl_precios_productos` ON (((`tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`)"
  sQuery &= "            And ( `tbl_prods_x_orden`.`int_tipo_precio` = `tbl_precios_productos`.`int_tipo_precio`)))"
  sQuery &= "        WHERE" 
  sQuery &= "        `tbl_productos`.`int_activo` = 1" 
  sQuery &= "            And `tbl_prods_x_orden`.`bool_activo` = '1'"  
  sQuery &= "            And `tbl_precios_productos`.`bit_activo` = 1" 
  sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` >= &1" 
  sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` <= &2" 
  sQuery &= "         group BY `ID Prod`, `Tipo Precio`, `ID TPago`"
  sQuery &= "         order by `Tipo Precio`, `ID TPago`, `Ordenar`"
  
  Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
  
  If (hResult <> Null) And hResult.Available Then
    Print "Count: " & hResult.Count
    flTemporal = 0 
    flTotal = 0
    flEfectivo = 0
    flDescuento = 0
    flEmpleados = 0
    iInc = 0
    iCantidadTotal = 0
    sTemporal = ""
    
    sHTML = Replace(sHTML, "@@NumMovs@@", CStr(hResult.Count))
    '
    For Each hResult 'ordenes cerradas
      
      If hResult["Cantidad"] = Null Then 
        iCantidad = 0 
      Else 
        iCantidad = hResult["Cantidad"] 
        iCantidadTotal += iCantidad
      Endif 
      
      flTemporal = CFloat(hResult["Total"])
      
      Select Case hResult["ID TPago"]
        Case 1
          sTemporal &= "<tr><td colspan=\"2\">" & hResult["Producto"] & "</td></tr><tr><td align = \"left\">"
          If hResult["Tipo Precio"] = iIndexPersonal Then
            hResultEmpleado = Null
            sQuery = "SELECT * FROM `tbl_precios_productos` where `id_producto` = &1 and int_tipo_precio = 1 and bit_activo = 1;"
            Try hResultEmpleado = modVariables.c_Conn.Exec(sQuery, hResult["ID Prod"])
            If (hResultEmpleado <> Null) And hResultEmpleado.Available Then 
              flEmpleados += CFloat(hResultEmpleado["dbl_precio"]) * CFloat(hResult["Cantidad"]) 
            Else
              flEmpleados += 0
            Endif
            sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(CFloat(hResultEmpleado["dbl_precio"]) * CFloat(hResult["Cantidad"])) & "</td></tr/>" 
          Else
            flEfectivo += flTemporal 
            sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
          Endif
        Case 2
          sTemporal &= "<tr><td colspan=\"2\">" & hResult["Producto"] & "*</td></tr><tr><td align = \"left\">"
          flDescuento += flTemporal 
          sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["Tipo Pago"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
        Case 3
          sTemporal &= "<tr><td colspan=\"2\">" & hResult["Producto"] & "</td></tr><tr><td align = \"left\">"
          
          If hResult["Tipo Precio"] = iIndexPersonal Then
            hResultEmpleado = Null
            sQuery = "SELECT * FROM `tbl_precios_productos` where `id_producto` = &1 and int_tipo_precio = 1 and bit_activo = 1;"
            Try hResultEmpleado = modVariables.c_Conn.Exec(sQuery, hResult["ID Prod"])
            If (hResultEmpleado <> Null) And hResultEmpleado.Available Then 
              flTemporal = CFloat(hResultEmpleado["dbl_precio"]) * CFloat(hResult["Cantidad"]) 
              flEmpleados += flTemporal
            Else
              flEmpleados += 0
            Endif
            'sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & flEmpleados & "</td></tr/>" 
          Else
            flEmpleados += flTemporal
          Endif
          sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
          hResultEmpleado = Null
        Case 4
          sTemporal &= "<tr><td colspan=\"2\">" & hResult["Producto"] & "</td></tr><tr><td align = \"left\">"
          flTarjeta += flTemporal
          sTemporal &= "x " & iCantidad & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(flTemporal) & "</td></tr/>" 
      End Select
      
    Next

    sHTML = Replace(sHTML, "@@Detalle@@", sTemporal)
    sHTML = Replace(sHTML, "@@Efectivo@@", "Efectivo: $" & flEfectivo & ".00")
    sHTML = Replace(sHTML, "@@iCantidadTotal@@", CStr(iCantidadTotal))
    
    hResultEmpleado = Null
    sQuery = "SELECT sum(`fl_total`) from tbl_ordenes_cerradas where id_control_fecha >= &1 and id_control_fecha <= &2 and int_forma_pago = 2"
    Try hResultEmpleado = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
       
    If (hResultEmpleado[0] <> Null) And hResultEmpleado.Available Then
      sHTML = Replace(sHTML, "@@Descuento@@", "Con Descuento: $" & hResultEmpleado[0] & ".00 // diferencia: $" & CFloat(hResultEmpleado[0] - flDescuento) & ".00")
    Else
      sHTML = Replace(sHTML, "@@Descuento@@", "Con Descuento: $0.00")
    Endif

    
    sHTML = Replace(sHTML, "@@Empleado@@", "Empleado/Personal: $" & flEmpleados & ".00")
    sHTML = Replace(sHTML, "@@Tarjeta@@", "Tarjeta Cred./Deb.: $" & flTarjeta & ".00")
    
    flTotal = flEfectivo + flDescuento + flEmpleados + flTarjeta
    
  Else
    Paint.Font = Font["Helvetica, Bold, 9"]
    sHTML = Replace(sHTML, "@@Detalle@@", "SIN MOVIMIENTOS PARA ESTA FECHA")
    Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 200, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  Endif
  
  hResult = Null
  hResultCantidad = Null
  hResultPrecio = Null
  
  Paint.Font = Font["Courier,9"]
  sTemporal = CStr(flTotal)
  sHTML = Replace(sHTML, "@@Total@@", sTemporal)
  
  PrinterCuenta.PaperWidth = 80
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub btnGeneraCuenta_Click()
Dim sTempFile, sCommand As String
'Dim tempContents As String

  'tempContents = generaCuenta(rsRecords)
  Me.Enabled = False
  Inc Application.Busy
  PrinterCuenta.PaperWidth = 80
  PrinterCuenta.Count = 2
  PrinterCuenta.PaperHeight = 1000
  
  sTempFile = User.Home &/ "Tickets/cuenta_" & modVariables.i_intTicketNR & "-" & modUtils.convierteFechaFormatoHora(Now) & ".pdf"
  sTempFile = Replace(sTempFile, " ", "-")
  PrinterCuenta.OutputFile = sTempFile
  PrinterCuenta.Print() 
  sCommand = "lp " & sTempFile 
  Shell sCommand Wait 
  Dec Application.Busy
  Me.Enabled = True

End


Public Sub btnBuscarMesero_Click()

Dim sQuery As String
'Dim sQueryInventario As String
Dim hResult As Result

  rsRecords = Null
    
  If radioFechaUnica2.Value = True Then
    modVariables._cnnFechaInicio = DateChooser4.Value
    modVariables._cnnFechaFinal = DateChooser4.Value    
  Else
    modVariables._cnnFechaInicio = DateChooser5.Value
    modVariables._cnnFechaFinal = DateChooser6.Value
    
  Endif
  
  hResult = Null
  sQueryString = "SELECT * FROM `tbl_control_fechas` where Date(`dt_fecha_calendario`) >= DATE(&1) and Date(`dt_fecha_calendario`) <= DATE(&2);"
  Try hResult = modVariables.c_Conn.Exec(sQueryString, Format(modVariables._cnnFechaInicio, "yyyy-mm-dd"), Format(modVariables._cnnFechaFinal, "yyyy-mm-dd"))

  If (hResult <> Null) And hResult.Available Then
    iControlFechaStart = hResult["id_control_fechas"]
    hResult.MoveLast
    iControlFechaEnd = hResult["id_control_fechas"]
  Else
    Message.Info("No se han encontrado registros")
    Return
  Endif
  
  hResult = Null
  
    sQuery = "SELECT  ANY_VALUE(SUM(`tbl_prods_x_orden`.`int_cantidad`*`tbl_precios_productos`.`dbl_precio`)) as `Total`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
    sQuery &= "        SUM(ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`)) AS `Cantidad`,"
    sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`,"
    sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
    sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
    sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `ID TPago`,"
    sQuery &= "        ANY_VALUE( `tbl_formas_pago`.`chr_forma_pago`) AS `Tipo Pago`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`"
    sQuery &= "        From"
    sQuery &= "        `tbl_prods_x_orden`"
    sQuery &= "        LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
    sQuery &= "        LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
    sQuery &= "        LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
    sQuery &= "        LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id`"
    sQuery &= "        left join `tbl_formas_pago` ON `tbl_ordenes_cerradas`.`int_forma_pago` = `tbl_formas_pago`.`id_forma_pago`"
    sQuery &= "        LEFT JOIN `tbl_precios_productos` ON (((`tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`)"
    sQuery &= "            And ( `tbl_precios_productos`.`int_tipo_precio` = 1)))"
    sQuery &= "        WHERE" 
    sQuery &= "        `tbl_productos`.`int_activo` = 1" 
    sQuery &= "            And `tbl_prods_x_orden`.`bool_activo` = '1'"  
    sQuery &= "            And `tbl_precios_productos`.`bit_activo` = 1" 
    sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` >= &1" 
    sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` <= &2" 
    sQuery &= "            And `tbl_tipos_precios`.`id_tipo_precio` = 3"
    sQuery &= "         group BY `ID Prod`, `Tipo Precio`, `ID TPago`"
    sQuery &= "         order by `Tipo Precio`, `ID TPago`, `Ordenar`"
    
  Try rsRecords = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)

  If rsRecords.Available Then
    gridReportMesero.Rows.Count = 0
    gridReportMesero.Rows.Count = rsRecords.Count
    Label4.Text = "Se han encontrado " & rsRecords.Count & " movimientos"
    gridReportMesero.Refresh
    btnGeneraUnica2.Enabled = True
    btnGeneraCuenta2.Enabled = True
  Else
    'GridView1.Clear
    gridReportIzq.Rows.Count = 0
    btnGeneraUnica2.Enabled = False
    btnGeneraCuenta2.Enabled = False
    Label4.Text = "No existen movimientos para la fecha seleccionada"
  Endif
  
Catch
  Message.Error(Error.Text & ",\n" & gb.CrLf & Error.Where)


End

Public Sub gridReportMesero_Data(Row As Integer, Column As Integer)

  If (rsRecords <> Null) Then
    If Row >= 0 Then
      rsRecords.moveTo(Row)
      Try gridReportMesero.Data.Text = Str(rsRecords[Column])
      If Error Then Print Error.Text & ", " & Error.Where
    Endif
  Endif

End

Public Sub PrinterCuenta2_Draw()
  'Dim documento As New ClassLaTex
  'Dim tex As String
  Dim sQuery As String
  Dim hResult, hResultCantidad, hResultPrecio, hResultEmpleado As Result
  
  Dim sTemporal, sPersonalText As String
  'Dim hImage As Image
  'Dim rResultPromos As Result
  Dim flTemporal, flTotal, flEfectivo, flDescuento, flEmpleados, flTarjeta As Float
  Dim iInc, iIndexPersonal As Integer
 ' Dim tText As String
  Dim iCantidad As Integer
  'Dim flPrecio As Float
    
  Dim sArray As String[] = Split(File.Load(User.Home &/ "Templates/cuenta.html"), gb.Newline, "", True)
  Dim sHTML As String
  
  sHTML = sArray.Join(gb.Newline)
  
  rYPrint = PRINT_MARGIN - (PrinterCuenta2.Page - 1) * (Paint.Height - PRINT_MARGIN * 2)
  
  Paint.Font = Font["Courier New,10"]
  sHTML = Replace(sHTML, "@@DateTime@@", Format(Now(), "dddd, yyyy-mm-dd hh:nn"))
  
  sHTML = Replace(sHTML, "@@DiaComienzo@@", Format(modVariables._cnnFechaInicio, "dddd dd mmmm yyyy"))
  
  If radioFechaRango.Value = True Then
    sHTML = Replace(sHTML, "@@DiaFin@@", "Al dia: " & Format(modVariables._cnnFechaFinal, "dddd dd mmmm yyyy"))
  Else
    sHTML = Replace(sHTML, "@@DiaFin@@", "")
  Endif
    
  sQuery = "SELECT * FROM tbl_datos_sucursal where id_sucursal = 1"
  Try hResult = modVariables.c_Conn.Exec(sQuery)

  sHTML = Replace(sHTML, "@@NombreSuc@@", hResult["chr_nombre"])
  sHTML = Replace(sHTML, "@@DirSuc1@@", hResult["chr_dir1"])
  sHTML = Replace(sHTML, "@@DirSuc2@@", hResult["chr_dir2"])
  sHTML = Replace(sHTML, "@@DirSuc3@@", hResult["chr_dir3"])
  sHTML = Replace(sHTML, "@@TelefonoSuc@@", hResult["chr_telefono1"])
  
  hResult = Null
  
  'iIndexPersonal
  sQuery = "SELECT `chr_var_value` from `tbl_configs` where `chr_var_name` = 'personal_index';"
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  iIndexPersonal = CInt(hResult[0])
  hResult = Null
  
  'sPersonalText
  sQuery = "SELECT `chr_nombre_precio` from `tbl_tipos_precios` where `id_tipo_precio` = '&1';"
  Try hResult = modVariables.c_Conn.Exec(sQuery, iIndexPersonal)
  sPersonalText = CStr(hResult[0])
  hResult = Null

  'main cachucha
    sQuery = "SELECT  ANY_VALUE(SUM(`tbl_prods_x_orden`.`int_cantidad`*`tbl_precios_productos`.`dbl_precio`)) as `Total`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`id_producto`) AS `ID Prod`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`chr_nombre_prod`) AS `Producto`,"
    sQuery &= "        SUM(ANY_VALUE( `tbl_prods_x_orden`.`int_cantidad`)) AS `Cantidad`,"
    sQuery &= "        ANY_VALUE( `tbl_precios_productos`.`dbl_precio`) AS `Precio`,"
    sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`id_tipo_precio`) AS `Tipo Precio`,"
    sQuery &= "        ANY_VALUE( `tbl_tipos_precios`.`chr_nombre_precio`) AS `CHRTipoPrecio`,"
    sQuery &= "        ANY_VALUE( `tbl_ordenes_cerradas`.`int_forma_pago`) AS `ID TPago`,"
    sQuery &= "        ANY_VALUE( `tbl_formas_pago`.`chr_forma_pago`) AS `Tipo Pago`,"
    sQuery &= "        ANY_VALUE( `tbl_productos`.`fl_ordenar`) AS `Ordenar`"
    sQuery &= "        From"
    sQuery &= "        `tbl_prods_x_orden`"
    sQuery &= "        LEFT JOIN `tbl_productos` ON `tbl_prods_x_orden`.`int_producto_id` = `tbl_productos`.`id_producto`"
    sQuery &= "        LEFT JOIN `tbl_precio_tipo_ordenes` ON `tbl_prods_x_orden`.`int_orden_id` = `tbl_precio_tipo_ordenes`.`id_orden`"
    sQuery &= "        LEFT JOIN `tbl_tipos_precios` ON `tbl_tipos_precios`.`id_tipo_precio` = `tbl_precio_tipo_ordenes`.`id_tipo_precio`"
    sQuery &= "        LEFT JOIN `tbl_ordenes_cerradas` ON `tbl_ordenes_cerradas`.`id_orden_id` = `tbl_prods_x_orden`.`int_orden_id`"
    sQuery &= "        left join `tbl_formas_pago` ON `tbl_ordenes_cerradas`.`int_forma_pago` = `tbl_formas_pago`.`id_forma_pago`"
    sQuery &= "        LEFT JOIN `tbl_precios_productos` ON (((`tbl_prods_x_orden`.`int_producto_id` = `tbl_precios_productos`.`id_producto`)"
    sQuery &= "            And ( `tbl_precios_productos`.`int_tipo_precio` = 1)))"
    sQuery &= "        WHERE" 
    sQuery &= "        `tbl_productos`.`int_activo` = 1" 
    sQuery &= "            And `tbl_prods_x_orden`.`bool_activo` = '1'"  
    sQuery &= "            And `tbl_precios_productos`.`bit_activo` = 1" 
    sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` >= &1" 
    sQuery &= "            And `tbl_ordenes_cerradas`.`id_control_fecha` <= &2" 
    sQuery &= "            And `tbl_tipos_precios`.`id_tipo_precio` = 3"
    sQuery &= "         group BY `ID Prod`, `Tipo Precio`, `ID TPago`"
    sQuery &= "         order by `Tipo Precio`, `ID TPago`, `Ordenar`"
  
  Try hResult = modVariables.c_Conn.Exec(sQuery, iControlFechaStart, iControlFechaEnd)
  
  If (hResult <> Null) And hResult.Available Then
    Print "Count: " & hResult.Count
    flEmpleados = 0
    iInc = 0
    sTemporal = ""
    iCantidad = 0
    
    sHTML = Replace(sHTML, "@@NumMovs@@", CStr(hResult.Count))
    '
    For Each hResult 'ordenes cerradas
      
      If hResult["Cantidad"] = Null Then iCantidad += 0 Else iCantidad += hResult["Cantidad"] 
      flTemporal = CFloat(hResult["Total"])
      sTemporal &= "<tr><td colspan=\"2\">" & hResult["Producto"] & "</td></tr><tr><td align = \"left\">"
      flEmpleados += CFloat(hResult["Precio"]) * CFloat(hResult["Cantidad"]) 
      sTemporal &= "x " & CStr(iCantidad) & "</td><td align=\"right\">(" & hResult["CHRTipoPrecio"] & ") - $" & CStr(CFloat(hResult["Total"])) & "</td></tr/>" 
      hResultEmpleado = Null
      
    Next
    sHTML = Replace(sHTML, "@@Detalle@@", sTemporal)
    
    sHTML = Replace(sHTML, "@@Efectivo@@", "")
    sHTML = Replace(sHTML, "@@Descuento@@", "")
    
    sHTML = Replace(sHTML, "@@Empleado@@", "Empleado/Personal: $" & flEmpleados & ".00")
    sHTML = Replace(sHTML, "@@Tarjeta@@", "Son " & iCantidad & " Artículos consumidos")
    
    flTotal = flEmpleados
    
  Else
    Paint.Font = Font["Helvetica, Bold, 9"]
    sHTML = Replace(sHTML, "@@Detalle@@", "SIN MOVIMIENTOS PARA ESTA FECHA")
    Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 200, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta2.Count, Align.TopNormal)
  Endif
  
  hResult = Null
  hResultCantidad = Null
  hResultPrecio = Null
  
  Paint.Font = Font["Courier,9"]
  sTemporal = CStr(flTotal) & ".00"
  sHTML = Replace(sHTML, "@@Total@@", sTemporal)
  
  PrinterCuenta2.PaperWidth = 80
  'Message(sHTML)
  Paint.DrawRichText(sHTML, PRINT_MARGIN, rYPrint + 20, Paint.Width - PRINT_MARGIN * 2, Paint.Height * PrinterCuenta2.Count, Align.TopNormal)
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub radioFechaRango2_Click()

  frmFechaUnica2.Visible = radioFechaUnica2.Value
  frmFechaRango2.Visible = Not radioFechaUnica2.Value

End

Public Sub radioFechaUnica2_Click()

  frmFechaUnica2.Visible = radioFechaUnica2.Value
  frmFechaRango2.Visible = Not radioFechaUnica2.Value

End

Public Sub DateChooser4_Click()

  If DateChooser4.Value > 0 Then btnBuscarMesero.Enabled = True

End

Public Sub DateChooser5_Click()

  If DateChooser5.Value > 0 Then btnBuscarMesero.Enabled = True

End

Public Sub DateChooser6_Click()

  If DateChooser6.Value > 0 Then btnBuscarMesero.Enabled = True

End

Public Sub btnGeneraCuenta2_Click()

  Dim sTempFile, sCommand As String
'Dim tempContents As String

  'tempContents = generaCuenta(rsRecords)
  Me.Enabled = False
  Inc Application.Busy
  PrinterCuenta2.PaperWidth = 80
  
  sTempFile = User.Home &/ "Tickets/cuenta_personal_" & modVariables.i_intTicketNR & "-" & modUtils.convierteFechaFormatoHora(Now) & ".pdf"
  sTempFile = Replace(sTempFile, " ", "-")
  PrinterCuenta2.OutputFile = sTempFile
  PrinterCuenta2.Print()
  sCommand = "lp " & sTempFile 
  Shell sCommand
  Dec Application.Busy
  Me.Enabled = True

End
