' Gambas class file

Private tmpCantidad As Integer
Private hResult As Result
'Private qString As String

Private vBoxVariantes1 As VBox
Private vBoxVariantes2 As VBox
Private vBoxVariantes3 As VBox

Private vBoxProds1 As VBox
Private vBoxProds2 As VBox
Private vBoxProds3 As VBox

Private chkVariantes As CheckBox

Public Sub Run() As Boolean

  Return Not Me.ShowModal()

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub Form_Open()

  Dim intTempCat As Integer
  Dim myButtons As Button
  Dim laDate As Date
  Dim precioDescuento As Float
  Dim rResultPromos As Result
  Dim iInd, Iinc, largoCadena As Integer
'  Dim sQueryCat As String
  Dim sQueryString As String
  Dim rResultCat As Result
  Dim sLabelBoton As String[]
  Dim sLabelEsc, sLabelTemp, labelFinished As String
 ' Dim intVariantes As Integer
    
  'Me.Maximized = True
  intTempCat = modVariables.i_idCategoriaTemp
  'Primero checamos si es martes o jueves, para seleccionar los productos apropiados
  
  laDate = Now()
  sQueryString = "Select * FROM  `vw_products_catprecio` where `CatID` = &1 and Activo = 1 and `IDTipo` = &2"
  Try hResult = modVariables.c_Conn.Exec(sQueryString, intTempCat, modVariables.i_intTipoPrecio)
  If Error Then Print Error.Text
  
  If (hResult <> Null) And hResult.Available Then
    iInd = 0
    'Creamos las cajas para acomodar los botones de los productos en dos columnas
    vBoxProds1 = New VBox(buttonsBox) 
    vBoxProds2 = New VBox(buttonsBox)
    vBoxProds3 = New VBox(buttonsBox)
    vBoxProds1.Expand = True
    vBoxProds2.Expand = True
    vBoxProds3.Expand = True
    
    For Each hResult
      myButtons = New Button(Me) As "KeyButton"
      myButtons.Font.Size = 10
      
      sQueryString = "Select * from tbl_promociones where id_producto = &1 and `bit_activo = 1`"
      Try rResultPromos = modVariables.c_Conn.Exec(sQueryString, hResult!ID)
      
      If (rResultPromos <> Null) Then 'Hay una promocion para este producto, checar validez de días.
        If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
          precioDescuento = hResult!Precio - (hResult!Precio * rResultPromos!fl_descuento)
        Endif
      Else
        precioDescuento = hResult!Precio
      Endif
      
      sLabelBoton = Split(hResult!Producto, " ")
      sLabelTemp = ""
      Iinc = 1
      largoCadena = 0
      labelFinished = ""
      
      For Each sLabelEsc In sLabelBoton
        sLabelTemp &= sLabelEsc & " "
        largoCadena = Len(sLabelTemp)
        If largoCadena >= 14 Then 
          labelFinished &= sLabelTemp & "\n"
          Iinc = 1
          largoCadena = 1
          sLabelTemp = ""
        Endif
        Inc Iinc
      Next
      labelFinished &= sLabelTemp
      
      
      'myButtons.Text = hResult!Producto & ":\n$" & precioDescuento
      myButtons.Text = labelFinished & "$" & precioDescuento
        
      myButtons.Tag = hResult!ID
      myButtons.ToolTip = precioDescuento
      
      If iInd <= CInt(hResult.Count / 3) Then 
        myButtons.Reparent(vBoxProds1) 
      Else If iInd <= CInt(hResult.Count / 3) + CInt(hResult.Count / 3)
        myButtons.Reparent(vBoxProds2)
      Else
        myButtons.Reparent(vBoxProds3)
      Endif
      myButtons.Expand = True
      Inc iInd
    Next
    Me.Arrangement = Arrange.LeftRight
  Endif
  
  hResult = Null
  iInd = 0
  
  'Preparamos cajitas para opciones
  vBoxVariantes1 = New VBox(Me) As "vBoxVariantes1"
  vBoxVariantes2 = New VBox(Me) As "vBoxVariantes2"
  vBoxVariantes3 = New VBox(Me) As "vBoxVariantes3"
  
  vBoxVariantes1.Reparent(HBoxVariantes)
  vBoxVariantes2.Reparent(HBoxVariantes)
  vBoxVariantes3.Reparent(HBoxVariantes)
  
  vBoxVariantes1.Expand = True
  vBoxVariantes2.Expand = True
  vBoxVariantes3.Expand = True
  
    
  rResultCat = Null
  tmpCantidad = 0
  btnMenos.Enabled = False
  
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)

End

Public Sub btnOK_Click()

Dim sQueryString As String
Dim i_iLastOrdenProd As Integer
'Dim rResult As Result
Dim iCombo As Integer
  
  'Inserta en la DB el producto y cantidad seleccionados, para la orden asignada
  sQueryString = "INSERT INTO `tbl_prods_x_orden` (`int_orden_id`, `int_producto_id`, `int_cantidad`, `bool_activo`, `dt_horafecha_pedido`, `bool_impreso`) VALUES (&1, &2, &3, '1', Now(), 0);"
    
  Try modVariables.c_Conn.Exec(sQueryString, modVariables.i_intOrdenID, modVariables.i_sProductoTmp, modVariables.s_sCantidadProd)
  
  i_iLastOrdenProd = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
  
  'Checar si es producto individual o combo
  hResult = Null
  sQueryString = "SELECT * from vw_combos_productos where `ID Prod Rel` = &1 and Activo = 1"
  'Print sQueryString
  Try hResult = modVariables.c_Conn.Exec(sQueryString, modVariables.i_sProductoTmp)

  If hResult.Available Then 'es un combo, agregar productos del combo
  iCombo = i_iLastOrdenProd
    For Each hResult
      i_iLastOrdenProd = 0
      sQueryString = "INSERT INTO `tbl_prods_x_orden` (`int_orden_id`, `int_producto_id`, `int_cantidad`, `bool_activo`, `dt_horafecha_pedido`, `bool_impreso`) VALUES (&1, &2, &3, '1', Now(), 0);"
      Try modVariables.c_Conn.Exec(sQueryString, modVariables.i_intOrdenID, hResult["ID Producto"], hResult["Cant. x Combo"])
      
      'Checamos si alguna opción está habilitada
      i_iLastOrdenProd = modVariables.c_Conn.Exec("select last_insert_id() as last")["last"]
      sQueryString = "INSERT INTO `tbl_combos_ordenes` (`id_orden_id`,`id_combo_id` ,`id_prod_x_orden_combo`,`id_prod_x_orden_parte_combo`) VALUES (&1, &2, &3, &4)"
      Try modVariables.c_Conn.Exec(sQueryString, iCombo, modVariables.i_sProductoTmp, hResult["ID Producto"], i_iLastOrdenProd)
      productos_variantes(i_iLastOrdenProd)
    Next
  Else
    productos_variantes(i_iLastOrdenProd)
  Endif
  
  modVariables.b_FsAMProdsReturn = True
  
  hResult = Null
  
  Me.Close(True)
  
Catch
  Message.Error(Error.Text & ", " & Error.Where)
  modVariables.b_FsAMProdsReturn = False
  modVariables.i_sProductoTmp = 0
  modVariables.s_sCantidadProd = 0
  Me.Close(False)
  
End

Private Function productos_variantes(i_iLastProdId As Integer)

Dim iInd As Integer
Dim myControl As Control

  iInd = 0
  Do While iInd <= (vBoxVariantes1.Children.Count + vBoxVariantes2.Children.Count + vBoxVariantes3.Children.Count) - 1
    For Each myControl In vBoxVariantes1.Children
      If Object.GetProperty(myControl, "Value") = True Then
        modUtils.insertaVariantePlatillo(i_iLastProdId, Object.GetProperty(myControl, "Tag"))
      Endif
      Inc iInd
    Next
    For Each myControl In vBoxVariantes2.Children
      If Object.GetProperty(myControl, "Value") = True Then
        modUtils.insertaVariantePlatillo(i_iLastProdId, Object.GetProperty(myControl, "Tag"))
      Endif
      Inc iInd
    Next
    For Each myControl In vBoxVariantes3.Children
      If Object.GetProperty(myControl, "Value") = True Then
        modUtils.insertaVariantePlatillo(i_iLastProdId, Object.GetProperty(myControl, "Tag"))
      Endif
      Inc iInd
    Next
    Inc iInd
  Loop

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)  
End


Public Sub btnCancel_Click()

  modVariables.i_sProductoTmp = 0
  modVariables.s_sCantidadProd = 0
  
  modVariables.b_FsAMProdsReturn = False
  Me.Close(False)

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End



Public Sub KeyButton_Click()

Dim sQuery As String  
Dim rResultVariantes As Result
'Dim Control As CheckBox
Dim intVariantes, iInd As Integer

  'Preparamos cajitas para opciones
  vBoxVariantes1.Delete
  vBoxVariantes2.Delete
  vBoxVariantes3.Delete
  
  'Message.Info("Button Tag: " & Last.Tag & "\nButton Text: " & Last.Text)
  tmpCantidad = 1
  btnMenos.Enabled = False
  lblCantidad.Text = "Cantidad: 1"
  lblSeleccion.Text = "Seleccion: " & CStr(Last.Tag) & ", " & Last.Text
  
  modVariables.i_sProductoTmp = Last.Tag
    
  If (tmpCantidad <= 0) Then btnMenos.Enabled = False
  
  modVariables.s_sCantidadProd = tmpCantidad
  Print "i_sProductoTmp = " & modVariables.i_sProductoTmp 

  sQuery = "Select * from `vw_variantes_x_platillo` where `ID Producto` = &1 and `Tipo Precio` = &2 and `Activo`= 1 order by `ID Variante` " 
  'Print sQuery & ", " & modVariables.i_sProductoTmp 
  Try rResultVariantes = modVariables.c_Conn.Exec(sQuery, modVariables.i_sProductoTmp, modVariables.i_intTipoPrecio)
  If rResultVariantes.Available Then
    
    intVariantes = rResultVariantes.Count
    rResultVariantes.MoveFirst
    
    vBoxVariantes1 = New VBox(Me) As "vBoxVariantes1"
    vBoxVariantes2 = New VBox(Me) As "vBoxVariantes2"
    vBoxVariantes3 = New VBox(Me) As "vBoxVariantes3"
  
    vBoxVariantes1.Reparent(HBoxVariantes)
    vBoxVariantes2.Reparent(HBoxVariantes)
    vBoxVariantes3.Reparent(HBoxVariantes)
    
    vBoxVariantes1.Expand = True
    vBoxVariantes2.Expand = True
    vBoxVariantes3.Expand = True
    
    For Each rResultVariantes
      With rResultVariantes
        Inc iInd
        chkVariantes = New CheckBox(Me) As "chkVariantePlatillo"
        chkVariantes.AutoResize = True
        chkVariantes.Text = rResultVariantes["Variante"]
        chkVariantes.Value = False
        chkVariantes.Tag = rResultVariantes["ID Variante"]
        If iInd > 0 And iInd <= 10 Then
          chkVariantes.Reparent(vBoxVariantes1)
        Else If iInd > 10 And iInd <= 20 Then
          chkVariantes.Reparent(vBoxVariantes2)
        Else If iInd > 20 And iInd <= 30 Then
          chkVariantes.Reparent(vBoxVariantes3)
        Endif
      End With
    Next
  Else
    vBoxVariantes1.Delete
    vBoxVariantes2.Delete
    vBoxVariantes3.Delete
  Endif
rResultVariantes = Null
Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

Public Sub btnCantidad_Click()
  btnOK.Enabled = False
  
  Select Case Last.Tag
    Case "++"
      Inc tmpCantidad
    Case "--"
      tmpCantidad = tmpCantidad - 1
    Case Else
      tmpCantidad = tmpCantidad + CInt(Last.Tag)
  End Select
  
  lblCantidad.Text = "Cantidad: " & tmpCantidad
  
  If (tmpCantidad > 0) Then btnMenos.Enabled = True Else btnMenos.Enabled = False
  
  modVariables.s_sCantidadProd = tmpCantidad
  Print "s_sCantidadProd = " & modVariables.s_sCantidadProd
  
  If (tmpCantidad > 0) Then btnOK.Enabled = True

Catch
  Print Error.Text
  Message.Error(Error.Text & ", " & Error.Where)
End

