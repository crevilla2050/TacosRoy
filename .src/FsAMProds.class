' Gambas class file

Private tmpCantidad As Integer
Private hResult As Result

Private qString As String

Private vBoxVariantes1 As VBox
Private vBoxVariantes2 As VBox
Private vBoxVariantes3 As VBox
Private chkVariantes As CheckBox

Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btnOK_Click()

Dim sQueryString As String
Dim iInd As Integer
Dim iLastProdId As Integer
Dim myControl As Control


  'Inserta en la DB el producto y cantidad seleccionados, para la orden asignada
  qString = "INSERT INTO `db_tacos_roy`.`tbl_prods_x_orden` (`int_orden_id`, `int_producto_id`, `int_cantidad`) VALUES (&1, &2, &3)"
  Try modVariables.$hConn.Exec(qString, modVariables.$intOrdenTmp, modVariables.$intProductoTmp, modVariables.$intCantidadProd)
  
  iLastProdId = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
  
  'Checamos si alguna opción está habilitada
  Do While iInd <= (vBoxVariantes1.Children.Count + vBoxVariantes2.Children.Count + vBoxVariantes3.Children.Count) - 1
      
    sQueryString = ""
    
    If iInd < 5 Then
      For Each myControl In vBoxVariantes1.Children
        If Object.GetProperty(myControl, "Value") = True Then
          sQueryString = "INSERT INTO tbl_prods_orden_opciones (id_prod_x_orden, id_variante_platillo) VALUES (&1, &2)" 
          Print sQueryString
          Try modVariables.$hConn.Exec(sQueryString, iLastProdId, Object.GetProperty(myControl, "Tag"))
        Endif
        Inc iInd
      Next
    Endif
    If iInd >= 5 And iInd <= 10 Then
      For Each myControl In vBoxVariantes2.Children
        If Object.GetProperty(myControl, "Value") = True Then
          sQueryString = "INSERT INTO tbl_prods_orden_opciones (id_prod_x_orden, id_variante_platillo) VALUES (&1, &2)" 
          Print sQueryString
          Try modVariables.$hConn.Exec(sQueryString, iLastProdId, Object.GetProperty(myControl, "Tag"))
        Endif
        Inc iInd
      Next
    Endif
    If iInd >= 10 Then 
      For Each myControl In vBoxVariantes3.Children
        If Object.GetProperty(myControl, "Value") = True Then
          sQueryString = "INSERT INTO tbl_prods_orden_opciones (id_prod_x_orden, id_variante_platillo) VALUES (&1, &2)" 
          Print sQueryString
          Try modVariables.$hConn.Exec(sQueryString, iLastProdId, Object.GetProperty(myControl, "Tag"))
        Endif
        Inc iInd
      Next
    Endif
  Loop
 
  modVariables.$FsAMProdsReturn = True
  
  Me.Close(True)
  
Catch
  Message.Error(Error.Text)
  modVariables.$FsAMProdsReturn = False
  modVariables.$intProductoTmp = 0
  modVariables.$intCantidadProd = 0
  Me.Close(False)
  
End

Public Sub btnCancel_Click()

  modVariables.$intProductoTmp = 0
  modVariables.$intCantidadProd = 0
  
  modVariables.$FsAMProdsReturn = False
  Me.Close(False)

End


Public Sub Form_Open()

  Dim intTempCat As Integer
  Dim myButtons As Button
  Dim laDate As Date
  Dim precioDescuento As Float
  Dim sQuery As String
  Dim rResultPromos As Result

  Dim myControl As Control
  Dim iInd As Integer
  Dim sQueryCat As String
  Dim rResultCat As Result
  
    
  intTempCat = FComandas.$idCategoriaTemp
  
  'Try hConn = modConn.ConectarDB()
  If Error Then Message.Error(Error.Text)
  
  'Primero checamos si es martes o jueves, para seleccionar los productos apropiados
  
  laDate = Now()
 
  Try hResult = modVariables.$hConn.Exec("Select * FROM  `vw_products_catprecio` where `CatID` = &1", intTempCat)
  If Error Then Print Error.Text
  
  If hResult.Available Then
    For Each hResult
      myButtons = New Button(Me) As "KeyButton"
      myButtons.Font.Size = 10
      
      sQuery = "Select * from tbl_promociones where id_producto = &1"
      Try rResultPromos = modVariables.$hConn.Exec(sQuery, hResult!ID)
      
      If rResultPromos.Available Then 'Hay una promocion para este producto, checar validez de días.
        If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
          precioDescuento = hResult!Precio - (hResult!Precio * rResultPromos!fl_descuento)
        Endif
      Else
        precioDescuento = hResult!Precio
      Endif
      myButtons.Text = hResult!Producto & ": $" & precioDescuento
        
      myButtons.Tag = hResult!ID
      myButtons.ToolTip = precioDescuento
      myButtons.Reparent(buttonsBox)
      myButtons.Expand = True
    Next
    Me.Arrangement = Arrange.LeftRight
  Endif
  
  hResult = Null
  'hResult = hConn.Exec("Select * FROM tbl_variantes_platillos")
  iInd = 0
  
  'Preparamos cajitas para opciones
  vBoxVariantes1 = New VBox(Me) As "vBoxVariantes1"
  vBoxVariantes2 = New VBox(Me) As "vBoxVariantes2"
  vBoxVariantes3 = New VBox(Me) As "vBoxVariantes3"
  
  vBoxVariantes1.Reparent(HBoxVariantes)
  vBoxVariantes2.Reparent(HBoxVariantes)
  vBoxVariantes3.Reparent(HBoxVariantes)
  
  vBoxVariantes1.Expand = True
  vBoxVariantes2.Expand = True
  vBoxVariantes3.Expand = True
  
  sQueryCat = "Select * from `vw_variantes_x_categoria` where `IDCAT` = &1 ORDER BY IDCAT, IDVAR ASC" 
  Try rResultCat = modVariables.$hConn.Exec(sQueryCat, modVariables.$currCategoriaInteger)
  
  
  For Each rResultCat
    With rResultCat
      chkVariantes = New CheckBox(Me) As "chkVariantePlatillo"
      chkVariantes.Text = rResultCat["Variante"]
      chkVariantes.AutoResize = True
      chkVariantes.Value = False
      chkVariantes.Tag = rResultCat[0]
      Inc iInd
      If iInd > 0 And iInd <= 5 Then
        chkVariantes.Reparent(vBoxVariantes1)
      Else If iInd > 5 And iInd <= 10 Then
        chkVariantes.Reparent(vBoxVariantes2)
      Else If iInd > 10 And iInd <= 15 Then
        chkVariantes.Reparent(vBoxVariantes3)
      Endif
    End With
  Next
  
  hResult = Null
  tmpCantidad = 0
  btnMenos.Enabled = False  

End

Public Sub KeyButton_Click()
  
  'Message.Info("Button Tag: " & Last.Tag & "\nButton Text: " & Last.Text)
  tmpCantidad = 1
  btnMenos.Enabled = False
  lblCantidad.Text = "Cantidad: 1"
  lblSeleccion.Text = "Seleccion: " & CStr(Last.Tag) & ", " & Last.Text
  
  modVariables.$intProductoTmp = Last.Tag
    
  If (tmpCantidad <= 0) Then btnMenos.Enabled = False
  
  modVariables.$intCantidadProd = tmpCantidad
  Print "$intProductoTmp = " & modVariables.$intProductoTmp 
End

Public Sub btnCantidad_Click()
  btnOK.Enabled = False
  
  Select Case Last.Tag
    Case "++"
      Inc tmpCantidad
    Case "--"
      tmpCantidad = tmpCantidad - 1
    Case Else
      tmpCantidad = tmpCantidad + CInt(Last.Tag)
  End Select
  
  lblCantidad.Text = "Cantidad: " & tmpCantidad
  
  If (tmpCantidad > 0) Then btnMenos.Enabled = True Else btnMenos.Enabled = False
  
  modVariables.$intCantidadProd = tmpCantidad
  Print "$intCantidadProd = " & modVariables.$intCantidadProd
  
  If (tmpCantidad > 0) Then btnOK.Enabled = True
End

