' Gambas class file

Private tmpCantidad As Integer
Private hResult As Result
Private qString As String

Private vBoxVariantes1 As VBox
Private vBoxVariantes2 As VBox
Private vBoxVariantes3 As VBox

Private vBoxProds1 As VBox
Private vBoxProds2 As VBox

Private chkVariantes As CheckBox

Public Sub Run() As Boolean

  Return Not Me.ShowModal()

End

Public Sub btnOK_Click()

Dim sQueryString As String
Dim iInd As Integer
Dim iLastProdId As Integer
Dim myControl As Control
Dim rResult As Result

  'Inserta en la DB el producto y cantidad seleccionados, para la orden asignada
  sQueryString = "INSERT INTO `db_tacosRoy`.`tbl_prods_x_orden` (`int_orden_id`, `int_producto_id`, `int_cantidad`, `bool_activo`, `dt_horafecha_pedido`, `bool_impreso`) VALUES ("
  sQueryString &= "'" & modVariables.$intOrdenID & "', "
  sQueryString &= "'" & modVariables.$intProductoTmp & "', " 
  sQueryString &= "'" & modVariables.$intCantidadProd & "', '1', Now(), 0);"
  'Print sQueryString
    
  Try modVariables.$hConn.Exec(sQueryString)
  
  iLastProdId = modVariables.$hConn.Exec("select last_insert_id() as last")["last"]
  iInd = 0
  
  'Checamos si alguna opción está habilitada
  Do While iInd <= (vBoxVariantes1.Children.Count + vBoxVariantes2.Children.Count + vBoxVariantes3.Children.Count) - 1
      
    sQueryString = ""
    
'    If iInd < 5 Then
      For Each myControl In vBoxVariantes1.Children
        If Object.GetProperty(myControl, "Value") = True Then
          modUtils.insertaVariantePlatillo(iLastProdId, Object.GetProperty(myControl, "Tag"))
        Endif
        Inc iInd
      Next
 '   Endif
  '  If iInd >= 5 And iInd <= 10 Then
      For Each myControl In vBoxVariantes2.Children
        If Object.GetProperty(myControl, "Value") = True Then
          modUtils.insertaVariantePlatillo(iLastProdId, Object.GetProperty(myControl, "Tag"))
        Endif
        Inc iInd
      Next
  '  Endif
   ' If iInd >= 10 Then 
      For Each myControl In vBoxVariantes3.Children
        If Object.GetProperty(myControl, "Value") = True Then
          modUtils.insertaVariantePlatillo(iLastProdId, Object.GetProperty(myControl, "Tag"))
        Endif
        Inc iInd
      Next
  '  Endif
  Loop
 
  modVariables.$FsAMProdsReturn = True
  
  rResult = Null
  
  Me.Close(True)
  
Catch
  Message.Error(Error.Text & ", " & Error.Where)
  modVariables.$FsAMProdsReturn = False
  modVariables.$intProductoTmp = 0
  modVariables.$intCantidadProd = 0
  Me.Close(False)
  
End

Public Sub btnCancel_Click()

  modVariables.$intProductoTmp = 0
  modVariables.$intCantidadProd = 0
  
  modVariables.$FsAMProdsReturn = False
  Me.Close(False)

Catch
  Print Error.Text

End


Public Sub Form_Open()

  Dim intTempCat As Integer
  Dim myButtons As Button
  Dim laDate As Date
  Dim precioDescuento As Float
  Dim sQuery As String
  Dim rResultPromos As Result
  Dim iInd As Integer
  Dim sQueryCat As String
  Dim sQueryString As String
  Dim rResultCat As Result
  Dim rResultVariantes As Result
  Dim intVariantes As Integer
  
    
  intTempCat = modVariables.$idCategoriaTemp
  
  'Try hConn = modConn.ConectarDB()
  If Error Then Message.Error(Error.Text & ", " & Error.Where)
  
  'Primero checamos si es martes o jueves, para seleccionar los productos apropiados
  
  laDate = Now()
 
  Try hResult = modVariables.$hConn.Exec("Select * FROM  `vw_products_catprecio` where `CatID` = &1", intTempCat)
  If Error Then Print Error.Text
  
  If hResult.Available Then
    iInd = 0
    'Creamos las cajas para acomodar los botones de los productos en dos columnas
    vBoxProds1 = New VBox(buttonsBox) 
    vBoxProds2 = New VBox(buttonsBox)
    vBoxProds1.Expand = True
    vBoxProds2.Expand = True
    
    For Each hResult
      myButtons = New Button(Me) As "KeyButton"
      myButtons.Font.Size = 10
      
      sQuery = "Select * from tbl_promociones where id_producto = &1"
      Try rResultPromos = modVariables.$hConn.Exec(sQuery, hResult!ID)
      
      If rResultPromos.Available Then 'Hay una promocion para este producto, checar validez de días.
        If Mid(rResultPromos!chr_dias_valido, WeekDay(Now) + 1, 1) = "1" Then
          precioDescuento = hResult!Precio - (hResult!Precio * rResultPromos!fl_descuento)
        Endif
      Else
        precioDescuento = hResult!Precio
      Endif
      
      myButtons.Text = hResult!Producto & ": $" & precioDescuento
        
      myButtons.Tag = hResult!ID
      myButtons.ToolTip = precioDescuento
      If iInd <= CInt(hResult.Count / 2) Then myButtons.Reparent(vBoxProds1) Else myButtons.Reparent(vBoxProds2)
      myButtons.Expand = True
      Inc iInd
    Next
    Me.Arrangement = Arrange.LeftRight
  Endif
  
  hResult = Null
  'hResult = modVariables.$hConn.Exec("Select * FROM tbl_variantes_platillos")
  iInd = 0
  
  'Preparamos cajitas para opciones
  vBoxVariantes1 = New VBox(Me) As "vBoxVariantes1"
  vBoxVariantes2 = New VBox(Me) As "vBoxVariantes2"
  vBoxVariantes3 = New VBox(Me) As "vBoxVariantes3"
  
  vBoxVariantes1.Reparent(HBoxVariantes)
  vBoxVariantes2.Reparent(HBoxVariantes)
  vBoxVariantes3.Reparent(HBoxVariantes)
  
  vBoxVariantes1.Expand = True
  vBoxVariantes2.Expand = True
  vBoxVariantes3.Expand = True
  
  sQueryString = "SELECT * FROM db_tacosRoy.tbl_variantes_platillos"
  
  'Obtenemos el número máximo posible de variantes para el platillo
  Try rResultVariantes = modVariables.$hConn.Exec(sQueryString)
  intVariantes = rResultVariantes.Count
  rResultVariantes = Null
  
  sQueryCat = "Select * from `vw_variantes_x_categoria` where `IDCAT` = &1 ORDER BY `IDCAT`, `IDVAR` ASC" 
  Try rResultCat = modVariables.$hConn.Exec(sQueryCat, intTempCat)
  
  Print sQueryCat & ", " & intTempCat
  
  Print rResultCat.Count
  
  rResultCat.MoveFirst
  
  For Each rResultCat
    With rResultCat
      Inc iInd
      chkVariantes = New CheckBox(Me) As "chkVariantePlatillo"
      chkVariantes.Text = rResultCat["Variante"]
      chkVariantes.AutoResize = True
      chkVariantes.Value = False
      chkVariantes.Tag = rResultCat["IDVAR"]
      If iInd > 0 And iInd <= CInt(intVariantes / 3) Then
        chkVariantes.Reparent(vBoxVariantes1)
      Else If iInd > 5 And iInd <= CInt(intVariantes / 3) * 2 Then
        chkVariantes.Reparent(vBoxVariantes2)
      Else If iInd > 10 And iInd <= intVariantes Then
        chkVariantes.Reparent(vBoxVariantes3)
      Endif
    End With
  Next
  
  rResultCat = Null
  tmpCantidad = 0
  btnMenos.Enabled = False
  
Catch
  Print Error.Text

End

Public Sub KeyButton_Click()
  
  'Message.Info("Button Tag: " & Last.Tag & "\nButton Text: " & Last.Text)
  tmpCantidad = 1
  btnMenos.Enabled = False
  lblCantidad.Text = "Cantidad: 1"
  lblSeleccion.Text = "Seleccion: " & CStr(Last.Tag) & ", " & Last.Text
  
  modVariables.$intProductoTmp = Last.Tag
    
  If (tmpCantidad <= 0) Then btnMenos.Enabled = False
  
  modVariables.$intCantidadProd = tmpCantidad
  Print "$intProductoTmp = " & modVariables.$intProductoTmp 
End

Public Sub btnCantidad_Click()
  btnOK.Enabled = False
  
  Select Case Last.Tag
    Case "++"
      Inc tmpCantidad
    Case "--"
      tmpCantidad = tmpCantidad - 1
    Case Else
      tmpCantidad = tmpCantidad + CInt(Last.Tag)
  End Select
  
  lblCantidad.Text = "Cantidad: " & tmpCantidad
  
  If (tmpCantidad > 0) Then btnMenos.Enabled = True Else btnMenos.Enabled = False
  
  modVariables.$intCantidadProd = tmpCantidad
  Print "$intCantidadProd = " & modVariables.$intCantidadProd
  
  If (tmpCantidad > 0) Then btnOK.Enabled = True
End

