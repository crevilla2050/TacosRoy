' Gambas class file

Private hResult As Result
'Private hConn As Connection

Private Sub checaMesas(HBox As Container)
  Dim myControl As Control
  Dim hFont As Font
  
  For Each mycontrol In HBox.Children
    If (Object.GetProperty(mycontrol, "Tag")) = Last.Tag Then
      hFont = Font["Ubuntu,Bold,+2"]
      Object.SetProperty(myControl, "Font", hFont)
    Else
      hFont = Font["Ubuntu,Normal,-2"]
      Object.SetProperty(myControl, "Font", hFont)
    Endif
  Next
End

Public Sub Form_Open()

  Dim myButtons As Button
  Dim sQuery As String
  Dim intCnt As Integer
    
  intCnt = 1
  modVariables.i_intIDPersonal = 0
  sQuery = "Select * From `tbl_mesas` where `tbl_mesas`.`bit_mesa_activa` = True order by `tbl_mesas`.`id_mesa_id` Asc"
  
  Try hResult = modVariables.c_Conn.Exec(sQuery)
    
  If (hResult <> Null) And hResult.Available Then
    For Each hResult
      'If hResult["bit_domicilio"] = 1 Then modVariables.iDomicilio = hResult["id_mesa_id"]
      myButtons = New Button(Me) As "MesasButton"
      myButtons.Font.Size = 12
      myButtons.Text = hResult!chr_mesa
      myButtons.Tag = hResult!id_mesa_id
      myButtons.Expand = True
      'Print intCnt
      If (intCnt >= 1 And intCnt <= 6) Then myButtons.Reparent(HBox1)
      If (intCnt > 6 And intCnt <= 12) Then myButtons.Reparent(HBox2)
      If (intCnt > 12 And intCnt <= 18) Then myButtons.Reparent(HBox3)
      Inc intCnt
    Next
  Endif
  
  hResult = Null
  sQuery = "SELECT * FROM tbl_personal where bit_activo = 1 order by id_personal Asc"
  
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  For Each hResult
    cmbMeseros.Add(hResult!chr_nombre_persona, hResult!id_personal)
  Next
  '
  hResult = Null
  sQuery = "SELECT * FROM tbl_tipos_precios where bit_activo = 1"
  cmbTipoPrecios.Add("Elija tipo de precios...")
  Try hResult = modVariables.c_Conn.Exec(sQuery)
  For Each hResult
    cmbTipoPrecios.Add(hResult!chr_nombre_precio, hResult!id_tipo_precio)
  Next
  
  hResult = Null

Catch
  Message.error(Error.Text & ", " & Error.Where)  
  Print Error.Text & ", " & Error.Where
  hResult = Null
End

Public Sub MesasButton_Click()
  
'Dim myControl As Control
'Dim hFont As Font
  hResult = Null
  hResult = modVariables.c_Conn.Exec("SELECT * FROM `tbl_mesas` where id_mesa_id = &1", Last.Tag)

  If (hResult <> Null) And hResult.Available Then 
    modVariables.s_strMesaTemp = CStr(hResult["chr_mesa"])
    modVariables.i_intIDMesaTemp = CInt(Last.Tag)
    Print "MesaID: " & modVariables.i_intIDMesaTemp
  Else
    modVariables.s_strMesaTemp = ""
    modVariables.i_intIDMesaTemp = 0
  Endif

  checaMesas(HBox1)
  checaMesas(HBox2)
  checaMesas(HBox3)
'  Print Last.Tag
  If modVariables.s_strMesaTemp = "A Domicilio" Then cmbTipoPrecios.Index = 2
  
  hResult = Null
  BtnMesaOK.Enabled = True
  btnMesaCancel.Enabled = True
  
Catch
  Message.error(Error.Text & ", " & Error.Where)  
  Print Error.Text & ", " & Error.Where
  hResult = Null
End

Public Sub btnMesaCancel_Click()

Dim sQuery As String

  If (Message.Question("Deseas CANCELAR la operación?", "Sí, cancelar", "No, continuar") = 1) Then
    sQuery = "id_orden_id = &1"
    modVariables.c_Conn.Begin()
    hResult = modVariables.c_Conn.Edit("tbl_ordenes", sQuery, modVariables.i_intOrdenID)
    hResult!chr_status_orden = "CANCELADA"
    hResult.Update()
    modVariables.c_Conn.Commit()
    hResult = Null
    
    modVariables.c_Conn.Begin()
    hResult = modVariables.c_Conn.Create("tbl_ordenes_cerradas")
    hResult!id_orden_id = modVariables.i_intOrdenID
    hResult!dt_horafecha_cierre_orden = Now()
    hResult!fl_total = 0
    hResult!bool_factura = 0
    hResult!chr_referencia_notas = "PROCESO INTERRUMPIDO"
    hResult!int_lvl_report = 1
    hResult!id_ticket_IDNr = modVariables.i_intTicketNR
    hResult!id_control_fecha = modVariables.i_idControlFecha
    hResult.Update()
    modVariables.c_Conn.Commit()
    hResult = Null
    
    Me.Close
    Return
  Endif

End

Public Sub BtnMesaOK_Click()

Dim sQuery As String
Dim sTemp As String

  modVariables.i_intIDPersonal = cmbMeseros.Index + 1
  
  If txtNrComanda.Text = "" Then 
    Message.Warning("introduzca número de comanda por favor")
    txtNrComanda.SetFocus
    Return
  Endif
  
  If modVariables.i_intIDMesaTemp > 0 And modVariables.i_intIDPersonal <> 0 And txtNrComanda.Text <> "" Then 
    
    If cmbTipoPrecios.Index > 0 Then
      If cmbTipoPrecios.Index = modVariables.COBRO_CORTESIA Then
        modVariables.i_intTipoPrecio = 1
      Endif
      modVariables.i_intTipoPrecio = cmbTipoPrecios.Index
    Else
      Message.Warning("Elija un tipo de precios por favor")
      cmbTipoPrecios.SetFocus
    Endif
    
    modVariables.i_intNrComanda = CInt(txtNrComanda.Text)
    sQuery = "UPDATE `tbl_ordenes` SET `int_nr_comanda` = &1 WHERE (`id_orden_id` = &2);"
    modVariables.c_Conn.Exec(sQuery, modVariables.i_intNrComanda, modVariables.i_intOrdenID)
    
    sQuery = ""
    hResult = Null
    sQuery = "SELECT * FROM tbl_mesas where `id_mesa_id` = &1;"
    Try hResult = modVariables.c_Conn.Exec(sQuery, modVariables.i_intIDMesaTemp)
      
    sTemp = "Mesa asignada:" & hResult["chr_mesa"] & "\nMesero: " & cmbMeseros.Text & "\nTipo Precio: " & cmbTipoPrecios.Text
    
    If (hResult["chr_mesa"] = "A domicilio") Or chkAsignarCliente.value = True Then 
      FBClientes.ShowModal()
      sTemp &= "\nOrden a Domicilio:\n"
      sTemp &= modVariables.r_gridClientes["Nombre"] & ", " & modVariables.r_gridClientes["Apellidos"] & "\n"
    Endif
    
    If modVariables.iClienteID > 0 And txtNrComanda.Text <> "" Then 
      'Insertar orden por cliente en tabla
      hResult = Null
      modVariables.c_Conn.Begin()
      hResult = modVariables.c_Conn.Create("tbl_ordenes_x_clientes")
      hResult!id_orden = modVariables.i_intOrdenID
      hResult!id_cliente = modVariables.iClienteID
      hResult.Update()
      modVariables.c_Conn.Commit()
      
      modVariables.i_intTipoPrecio = cmbTipoPrecios.Index
     
      'sTemp &= "\nTipo Precio: " & cmbTipoPrecios.Text
      'Message.Info(sTemp)
    Endif 
    
    Me.Close
  Else
    Message.Error("¡No se ha asignado una mesa, o falta asignar mesero!")
  Endif

Catch
  Message.error(Error.Text & ", " & Error.Where)  
  Print Error.Text & ", " & Error.Where
  
End


Public Sub txtNrComanda_KeyPress()

  Print Str(key.code) 
  'If Len(txtRecibido.text) = 0 Then btnOK.Enabled = False Else btnOK.Enabled = True
  If (Key.Code >= Asc("a") And Key.Code <= Asc("z")) Or (Key.Code >= Asc("A") And Key.Code <= Asc("Z")) Then Stop Event
  If Len(txtNrComanda.Text) > 5 Then 
    txtNrComanda.Text = Left(txtNrComanda.Text, 5)
  Endif

End
