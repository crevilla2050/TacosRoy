' Gambas class file

Private hResult As Result
Private hConn As Connection

Public Sub Form_Open()

  Dim myButtons As Button
  Dim sQuery As String
  Dim intCnt As Integer
    
  intCnt = 1
  modVariables.$intMesero = 0
  sQuery = "Select * From `tbl_mesas` where `tbl_mesas`.`bit_mesa_activa` = True order by `tbl_mesas`.`id_mesa_id` Asc"
  
  Try hResult = modVariables.$hConn.Exec(sQuery)
  If Error Then Print Error.Text
  
  If hResult.Available Then
    For Each hResult
      myButtons = New Button(Me) As "MesasButton"
      myButtons.Font.Size = 12
      myButtons.Text = hResult!chr_mesa
      myButtons.Tag = hResult!id_mesa_id
      myButtons.Expand = True
      'Print intCnt
      If (intCnt >= 1 And intCnt <= 6) Then myButtons.Reparent(HBox1)
      If (intCnt > 6 And intCnt <= 12) Then myButtons.Reparent(HBox2)
      If (intCnt > 12 And intCnt <= 18) Then myButtons.Reparent(HBox3)
      Inc intCnt
    Next
  Endif
  
  hResult = Null
  sQuery = "SELECT * FROM tbl_personal where bit_activo = 1 order by id_personal Asc"
  
  Try hResult = modVariables.$hConn.Exec(sQuery)
  For Each hResult
    cmbMeseros.Add(hResult!chr_nombre_persona, hResult!id_personal)
  Next
  '
  hResult = Null
  sQuery = "SELECT * FROM tbl_tipos_precios"
  cmbTipoPrecios.Add("Elija tipo de precios...")
  Try hResult = modVariables.$hConn.Exec(sQuery)
  For Each hResult
    cmbTipoPrecios.Add(hResult!chr_nombre_precio, hResult!id_tipo_precio)
  Next
  
  hResult = Null

Catch
  Message.error(Error.Text & ", " & Error.Where)  
  Print Error.Text & ", " & Error.Where
  hResult = Null
End

Public Sub MesasButton_Click()
  
  modVariables.$strMesaTemp = Last.Tag

'  Print Last.Tag
  
  BtnMesaOK.Enabled = True
  btnMesaCancel.Enabled = True
  
End

Public Sub btnMesaCancel_Click()

  If (Message.Question("Deseas CANCELAR la operación?", "Sí, cancelar", "No, continuar") = 1) Then
    modVariables.$strMesaTemp = 0
    Me.Close
    Return
  Endif

End

Public Sub BtnMesaOK_Click()

Dim sQuery As String
Dim hResult As Result

modVariables.$intMesero = cmbMeseros.Index + 1
If modVariables.$strMesaTemp <> "" And modVariables.$intMesero <> 0 Then 
  
  sQuery = "SELECT * FROM db_tacosRoy.tbl_mesas where `id_mesa_id` = &1;"
  Try hResult = modVariables.$hConn.Exec(sQuery, modVariables.$strMesaTemp)
  
  If cmbTipoPrecios.Index > 0 Then
    modVariables.$intTipoPrecio = cmbTipoPrecios.Index
  Else
    Message.Warning("Elija un tipo de precios por favor")
    cmbTipoPrecios.SetFocus
  Endif
  
  Message("Mesa asignada:" & hResult["chr_mesa"] & "\nMesero: " & cmbMeseros.Text & "\nTipo Precio: " & cmbTipoPrecios.Text)
  hResult = Null
  modVariables.$intTipoPrecio = cmbTipoPrecios.Index
  Me.Close
Else
  Message.Error("¡No se ha asignado una mesa, o falta asignar mesero!")
Endif

End



Public Sub Form_Leave()
'If modVariables.$strMesaTemp = "" Or modVariables.$intMesero = 0 Then 
'  Message.Error("La Pucha!")
'  cmbMeseros.SetFocus()
'Endif
End

